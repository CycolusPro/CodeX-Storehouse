# ç®€æ˜“åº“å­˜ç®¡ç†æœåŠ¡

è¿™æ˜¯ä¸€ä¸ªåŸºäº Flask æ„å»ºçš„è½»é‡çº§åº“å­˜ç³»ç»Ÿï¼Œæ—¢æä¾›æ“ä½œå‹å¥½çš„ç½‘é¡µæ§åˆ¶å°ï¼Œä¹Ÿæš´éœ²å®Œæ•´çš„ REST é£æ ¼æ¥å£ï¼Œå¸®åŠ©å°å‹å›¢é˜Ÿå¿«é€Ÿæ­å»ºâ€œèƒ½è®°å½•ã€èƒ½è¿½è¸ªã€èƒ½å¯¼å‡ºâ€çš„å…¥å‡ºåº“æµç¨‹ã€‚é¡¹ç›®ä½¿ç”¨çº¯ JSON æ–‡ä»¶ä¿å­˜åº“å­˜ã€é—¨åº—ã€åˆ†ç±»ä»¥åŠæ—¥å¿—ï¼Œéƒ¨ç½²æˆæœ¬æä½ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ¬ **å¤šé—¨åº—ä¸åˆ†ç±»ç®¡ç†**ï¼šæ”¯æŒåˆ›å»ºå¤šä¸ªé—¨åº—ã€ä¸ºå•†å“æ‰“ä¸Šåˆ†ç±»æ ‡ç­¾ï¼Œå¹¶åœ¨æ§åˆ¶å°ä¹‹é—´å¿«é€Ÿåˆ‡æ¢ã€‚
- ğŸš¨ **åº“å­˜é˜ˆå€¼æé†’**ï¼šSKU å¯é…ç½®ä½åº“å­˜é˜ˆå€¼ï¼Œä»ªè¡¨ç›˜ä¼šè‡ªåŠ¨é«˜äº®æé†’ã€‚
- ğŸ“¦ **çµæ´»çš„åº“å­˜æ“ä½œ**ï¼šæ”¯æŒæ–°å¢/ç›˜ç‚¹ã€å…¥åº“ã€å‡ºåº“ã€åˆ é™¤ç­‰åŠ¨ä½œï¼Œå¹¶è‡ªåŠ¨è®°å½•æ“ä½œäººã€å˜åŒ–æ•°é‡ã€é—¨åº—ä¸åˆ†ç±»ä¿¡æ¯ã€‚
- ğŸ“ˆ **ç»Ÿè®¡åˆ†æé¢æ¿**ï¼šå†…ç½®å›¾è¡¨æ•°æ®æºï¼Œå¯æŒ‰æ—¥æˆ–æœˆå¯¼å‡ºå…¥/å‡ºåº“ç»Ÿè®¡æŠ¥è¡¨ã€‚
- ğŸ” **ä¸‰è§’è‰²æƒé™ä½“ç³»**ï¼š`super_admin`ã€`admin`ã€`staff` ä¸‰ç§è§’è‰²è¦†ç›–æ—¥å¸¸åœºæ™¯ï¼Œç¡®ä¿æ•æ„Ÿæ“ä½œä»…æˆæƒå¯è§ã€‚
- ğŸ”„ **æ‰¹é‡å¯¼å…¥å¯¼å‡º**ï¼šå¯ä½¿ç”¨ CSV æ¨¡æ¿å¯¼å…¥å•†å“ï¼Œä¹Ÿå¯å¯¼å‡º XLS æ ¼å¼çš„å½“å‰åº“å­˜ã€æ“ä½œå†å²ä¸ç»Ÿè®¡æŠ¥è¡¨ã€‚
- ğŸ•’ **å®Œæ•´æ“ä½œæ—¥å¿—**ï¼šæ‰€æœ‰æ“ä½œéƒ½ä¼šå†™å…¥ JSON Lines æ ¼å¼çš„å†å²æ–‡ä»¶ï¼Œä¾¿äºå®¡è®¡è¿½æº¯ã€‚
- ğŸŒ **å“åº”å¼ç•Œé¢**ï¼šå‰ç«¯åŸºäº Bootstrap 5ï¼Œæ¡Œé¢ä¸ç§»åŠ¨ç«¯çš†å¯è½»æ¾æ“ä½œã€‚

## å¿«é€Ÿå¼€å§‹

1. **å®‰è£…ä¾èµ–**

   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows ä½¿ç”¨ .venv\Scripts\activate
   pip install -r requirements.txt
   ```

2. **å¯åŠ¨æœåŠ¡**

   ```bash
   flask --app inventory_app.app run --host 0.0.0.0 --port 5000
   ```

   æµè§ˆå™¨è®¿é—® `http://localhost:5000` è¿›å…¥æ§åˆ¶å°ã€‚

3. **é¦–æ¬¡ç™»å½•**

   é¦–æ¬¡å¯åŠ¨ä¼šè‡ªåŠ¨åˆ›å»ºè¶…çº§ç®¡ç†å‘˜è´¦å· `admin / admin`ã€‚è¯·ç™»å½•åç«‹åˆ»ä¿®æ”¹å¯†ç ï¼Œå¹¶åœ¨â€œç”¨æˆ·ç®¡ç†â€é¡µé¢åˆ›å»ºæ—¥å¸¸ä½¿ç”¨è´¦å·ã€‚

> â„¹ï¸ ç™»å½•ç•Œé¢ä½äº `/login`ã€‚æœªç™»å½•è®¿é—®ä»»ä½•é¡µé¢æˆ– API ä¼šè¢«é‡å®šå‘åˆ°ç™»å½•é¡µã€‚

## èº«ä»½éªŒè¯ä¸æƒé™

ç³»ç»ŸåŸºäºæœåŠ¡å™¨ç«¯ä¼šè¯ç»´æŒç™»å½•çŠ¶æ€ï¼Œæ¯ä¸ªè´¦å·ç»‘å®šä¸€ä¸ªè§’è‰²ï¼š

| è§’è‰²          | æƒé™æ¦‚è§ˆ                                                                 |
| ------------- | ------------------------------------------------------------------------ |
| `super_admin` | æ‹¥æœ‰å…¨éƒ¨æƒé™ï¼šç®¡ç†åº“å­˜ã€é—¨åº—ã€åˆ†ç±»ã€å¯¼å…¥å¯¼å‡ºã€æŸ¥çœ‹ç»Ÿè®¡ã€ç»´æŠ¤ç”¨æˆ·åŠæ¸…ç†å†å²ã€‚ |
| `admin`       | å¯ç®¡ç†åº“å­˜ã€é—¨åº—åˆ†ç±»ã€å¯¼å…¥å¯¼å‡ºã€æŸ¥çœ‹ç»Ÿè®¡ï¼Œä½†ä¸èƒ½ç»´æŠ¤ç”¨æˆ·æˆ–æ¸…ç†å†å²ã€‚         |
| `staff`       | ä»…èƒ½æŸ¥çœ‹åº“å­˜ã€æ‰§è¡Œå‡ºåº“ä¸å¯¼å‡ºæ“ä½œã€‚                                       |

> ğŸ” ä¼šè¯æœ‰æ•ˆæœŸ 14 å¤©ï¼Œä¸»åŠ¨é€€å‡ºæˆ–æ¸…é™¤æµè§ˆå™¨ Cookie ä¼šç«‹å³å¤±æ•ˆã€‚

## æ•°æ®å­˜å‚¨

é»˜è®¤æƒ…å†µä¸‹ï¼Œåº“å­˜æ•°æ®ä¿å­˜åœ¨ `inventory_data.json`ï¼Œæ“ä½œæ—¥å¿—å†™å…¥ `inventory_data.history.jsonl`ï¼Œç”¨æˆ·æ•°æ®ä½äº `users_data.json`ã€‚é€šè¿‡ `create_app(storage_path, user_storage_path)` å¯ä»¥è‡ªå®šä¹‰å­˜å‚¨è·¯å¾„ã€‚

## API è¯´æ˜

æ‰€æœ‰ API å‡è¦æ±‚å·²ç™»å½•ä¼šè¯ï¼Œä¸åŒç«¯ç‚¹è¿˜ä¼šåŸºäºè§’è‰²åšæƒé™æ§åˆ¶ã€‚é™¤ç‰¹æ®Šè¯´æ˜ï¼ŒAPI é»˜è®¤æ”¶å‘ JSONã€‚

### è·å–ä¼šè¯ï¼ˆç™»å½•ï¼‰

ä½¿ç”¨è¡¨å•ç™»å½•å¹¶åœ¨ Cookie ä¸­ä¿ç•™ä¼šè¯ä¿¡æ¯ï¼š

```bash
# Step 1: ç™»å½•å¹¶ä¿å­˜ Cookie
curl -c cookies.txt -X POST http://localhost:5000/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin&password=admin"

# Step 2: ä½¿ç”¨ä¼šè¯è®¿é—® API
curl -b cookies.txt http://localhost:5000/api/items
```

### é—¨åº—ä¸åˆ†ç±»ç®¡ç†

- `POST /stores` â€”â€” **æƒé™ï¼š** `super_admin`
  - JSON è¯·æ±‚ä½“ï¼š`{"name": "åä¸œä»“"}`
  - è¿”å›æ–°é—¨åº—çš„ `id`ï¼Œåç»­å¯åœ¨æŸ¥è¯¢ä¸æ“ä½œæ—¶é€šè¿‡ `store_id` æŒ‡å®šã€‚
- `POST /stores/<store_id>/delete` â€”â€” **æƒé™ï¼š** `super_admin`
  - å¯é€‰ `cascade=true`ï¼ŒåŒæ—¶åˆ é™¤é—¨åº—ä¸‹çš„æ‰€æœ‰åº“å­˜ã€‚
- `POST /categories` â€”â€” **æƒé™ï¼š** `admin` åŠä»¥ä¸Š
  - JSON è¯·æ±‚ä½“ï¼š`{"name": "è€—æ"}`ï¼Œåˆ›å»ºåä¼šè¿”å› `id`ã€‚
- `POST /categories/<category_id>/delete` â€”â€” **æƒé™ï¼š** `admin` åŠä»¥ä¸Š
  - åŒæ ·æ”¯æŒ `cascade=true`ï¼Œåˆ é™¤åˆ†ç±»å¹¶æ¸…ç©ºåˆ†ç±»å¼•ç”¨ã€‚

### åº“å­˜ç±»æ¥å£

é™¤éç‰¹åˆ«è¯´æ˜ï¼Œä»¥ä¸‹ç«¯ç‚¹éƒ½æ¥å— `store_id`ï¼ˆæŸ¥è¯¢å‚æ•°æˆ– JSON å­—æ®µï¼‰ä¸ `category`ï¼ˆJSON å­—æ®µï¼‰æ¥é™å®šé—¨åº—/åˆ†ç±»ã€‚

- `GET /api/items` â€”â€” **æƒé™ï¼š** ä»»æ„ç™»å½•ç”¨æˆ·
  - å¯é€‰å‚æ•°ï¼š`store_id`ã€`category_id`
  - è¿”å›å½“å‰é—¨åº—/åˆ†ç±»ä¸‹å…¨éƒ¨ SKUï¼ŒåŒ…å«é˜ˆå€¼ã€æœ€è¿‘å‡ºå…¥åº“æ—¶é—´ç­‰å­—æ®µã€‚
- `POST /api/items` â€”â€” **æƒé™ï¼š** `admin` æˆ– `super_admin`
  - è¯·æ±‚ä½“ç¤ºä¾‹ï¼š

    ```json
    {
      "name": "èºä¸",
      "quantity": 50,
      "unit": "ç›’",
      "threshold": 10,
      "store_id": "default",
      "category": "hardware"
    }
    ```

  - ä¼šæ ¹æ® `name + store_id` åˆ›å»ºæˆ–è¦†ç›– SKUï¼Œè¿”å›æœ€æ–°åº“å­˜ã€‚
- `PUT /api/items/<name>` â€”â€” **æƒé™ï¼š** `admin` æˆ– `super_admin`
  - è¯·æ±‚ä½“éœ€åŒ…å« `quantity`ï¼Œå¯é€‰ `unit`ã€`threshold`ã€`category`ã€`store_id`ã€‚
- `POST /api/items/<name>/in` â€”â€” **æƒé™ï¼š** `admin` æˆ– `super_admin`
  - è¯·æ±‚ä½“ï¼š`{"quantity": 25, "store_id": "default"}`ã€‚
- `POST /api/items/<name>/out` â€”â€” **æƒé™ï¼š** ä»»æ„ç™»å½•ç”¨æˆ·
  - è¯·æ±‚ä½“ï¼š`{"quantity": 10, "store_id": "default"}`ã€‚è‹¥å‡ºåº“é‡è¶…å‡ºåº“å­˜å°†è¿”å›é”™è¯¯ã€‚
- `DELETE /api/items/<name>` â€”â€” **æƒé™ï¼š** `admin` æˆ– `super_admin`
  - æ”¯æŒé€šè¿‡æŸ¥è¯¢å‚æ•° `store_id` æŒ‡å®šé—¨åº—ã€‚

### æ‰¹é‡å¯¼å…¥å¯¼å‡º

- `POST /api/items/import` â€”â€” **æƒé™ï¼š** `admin` æˆ– `super_admin`
  - æ”¯æŒ `multipart/form-data` ä¸Šä¼  CSV æ–‡ä»¶ï¼Œæˆ–ç›´æ¥æäº¤ JSON æ•°ç»„ï¼ˆæ¯é¡¹åŒ…å« `name`ã€`quantity`ã€`unit`ï¼Œå¯é€‰ `threshold` ä¸ `category`ï¼‰ã€‚
  - å¯åœ¨è¯·æ±‚ä½“æˆ–æŸ¥è¯¢å‚æ•°æä¾› `store_id`ï¼Œæœªæä¾›åˆ™ä½¿ç”¨å½“å‰é€‰ä¸­é—¨åº—ã€‚
  - è¿”å›å¯¼å…¥æˆåŠŸçš„ SKU åˆ—è¡¨åŠæ•°é‡ã€‚
- `GET /api/items/template` â€”â€” **æƒé™ï¼š** ä»»æ„ç™»å½•ç”¨æˆ·
  - ä¸‹è½½ç¤ºä¾‹ CSV æ¨¡æ¿ï¼ˆå«åç§°ã€æ•°é‡ã€å•ä½ã€é˜ˆå€¼æé†’ã€åº“å­˜åˆ†ç±»å­—æ®µï¼‰ã€‚
- `GET /api/items/export` â€”â€” **æƒé™ï¼š** ä»»æ„ç™»å½•ç”¨æˆ·
  - å¯é€‰ `store_id`ï¼Œè¿”å› XLS è¡¨æ ¼ï¼Œå­—æ®µåŒ…å«é—¨åº—ã€åˆ†ç±»ã€é˜ˆå€¼ä¸æœ€è¿‘å‡ºå…¥åº“ä¿¡æ¯ã€‚

### æ“ä½œå†å²ä¸ç»Ÿè®¡

- `GET /api/history` â€”â€” **æƒé™ï¼š** ä»»æ„ç™»å½•ç”¨æˆ·
  - å‚æ•°ï¼š`store_id`ã€`limit`ã€‚
  - è¿”å›æœ€æ–°çš„æ“ä½œè®°å½•ï¼ˆåŠ¨ä½œç±»å‹ã€æ—¶é—´ã€æ“ä½œè€…ã€æ•°é‡å˜åŒ–ç­‰ï¼‰ã€‚
- `GET /api/history/export` â€”â€” **æƒé™ï¼š** ä»»æ„ç™»å½•ç”¨æˆ·
  - å‚æ•°ï¼š`store_id`ã€‚
  - å¯¼å‡ºå®Œæ•´å†å² XLS è¡¨æ ¼ï¼Œé™„å¸¦å…¥/å‡ºåº“é‡ã€æ“ä½œè€…ã€é—¨åº—åˆ†ç±»ç­‰ç»´åº¦ã€‚
- `GET /api/history/stats/export` â€”â€” **æƒé™ï¼š** `admin` æˆ– `super_admin`
  - å‚æ•°ï¼š`store_id`ã€`mode=day|month`ã€`start=YYYY-MM-DD`ã€`end=YYYY-MM-DD`ã€‚
  - è¿”å›æŒ‡å®šæ—¶é—´èŒƒå›´çš„å…¥åº“é‡ã€å‡ºåº“é‡ä¸å‡€å˜åŠ¨ç»Ÿè®¡ã€‚

### å¿«æ·æŒ‡ä»¤ä¸è‡ªåŠ¨åŒ–è°ƒç”¨

ä¸ºäº†æ–¹ä¾¿ iOS/iPadOS å¿«æ·æŒ‡ä»¤åŠå…¶ä»–è‡ªåŠ¨åŒ–è„šæœ¬é›†æˆï¼Œåº”ç”¨æ–°å¢äº†å…ä¼šè¯çš„ä»¤ç‰Œè®¤è¯ä¸ç®€åŒ–æ¥å£ï¼š

- `POST /api/auth/token`
  - JSON è¯·æ±‚ä½“éœ€åŒ…å« `username`ã€`password`ï¼Œå¯é€‰ `expires_in`ï¼ˆå•ä½ï¼šç§’ï¼Œé»˜è®¤ 3600ï¼Œæœ€å¤§ 30 å¤©ï¼‰ã€‚
  - è¿”å› `token`ã€`expires_at`ã€`expires_in` ä»¥åŠå½“å‰ç”¨æˆ·è§’è‰²ä¿¡æ¯ã€‚
  - ä¹‹åå¯åœ¨ä»»æ„ API è¯·æ±‚å¤´åŠ å…¥ `Authorization: Bearer <token>`ï¼Œæˆ–é€šè¿‡æŸ¥è¯¢å‚æ•° `api_token=<token>` å®Œæˆè®¤è¯ã€‚

åŸºäºä»¤ç‰Œè®¤è¯ï¼Œç³»ç»Ÿæä¾›äº†ä¸€ç»„é’ˆå¯¹å¿«æ·æŒ‡ä»¤åœºæ™¯å°è£…çš„ç«¯ç‚¹ï¼š

- `GET /api/shortcuts/profile`
  - è¿”å›å½“å‰ç”¨æˆ·ä¿¡æ¯ã€æƒé™ã€å…¨éƒ¨é—¨åº—ä¸åˆ†ç±»åˆ—è¡¨ï¼Œæ–¹ä¾¿åœ¨å¿«æ·æŒ‡ä»¤ä¸­æ„å»ºé€‰æ‹©å™¨ã€‚
- `GET /api/shortcuts/items/summary`
  - æŸ¥è¯¢å‚æ•°ï¼š`name`ï¼ˆå¿…å¡«ï¼‰ã€`store_id`ï¼ˆå¯é€‰ï¼‰ã€‚
  - è¿”å›å•ä¸ª SKU çš„åº“å­˜æ•°é‡ã€å•ä½ã€åˆ†ç±»/é—¨åº—åç§°ã€æ˜¯å¦è§¦å‘ä½åº“å­˜ç­‰æ‘˜è¦ã€‚
- `POST /api/shortcuts/items/adjust`
  - JSON è¯·æ±‚ä½“ç¤ºä¾‹ï¼š

    ```json
    {
      "name": "æµ‹è¯•é›¶ä»¶",
      "action": "out",
      "quantity": 3,
      "store_id": "default"
    }
    ```

  - `action` æ”¯æŒ `set`ï¼ˆé‡ç½®æ•°é‡ï¼‰ã€`in`ï¼ˆå…¥åº“ï¼‰ã€`out`ï¼ˆå‡ºåº“ï¼‰ã€`transfer`ï¼ˆé—¨åº—è°ƒæ‹¨ï¼‰ã€‚
  - `transfer` é¢å¤–éœ€è¦ `target_store_id` å­—æ®µã€‚
  - æ‰€æœ‰æˆåŠŸå“åº”å‡åŒ…å« `status="success"` ä»¥åŠæœ€æ–°åº“å­˜å¿«ç…§ï¼›é”™è¯¯å“åº”ä¼šè¿”å› `status="error"` ä¸å…·ä½“é”™è¯¯ç ã€‚

### ç½‘é¡µç«¯è¾…åŠ©æ¥å£

- `POST /stores/select` â€”â€” **æƒé™ï¼š** ç™»å½•ç”¨æˆ·
  - æ›´æ”¹å½“å‰ä¼šè¯é€‰ä¸­çš„é—¨åº—ã€‚
- `POST /import` â€”â€” **æƒé™ï¼š** `admin` æˆ– `super_admin`
  - è¡¨å•ä¸Šä¼  CSVï¼ŒæˆåŠŸååœ¨ä»ªè¡¨ç›˜æ˜¾ç¤ºå¯¼å…¥æ‘˜è¦ã€‚

## è¿è¡Œæµ‹è¯•

```bash
pytest
```

## éƒ¨ç½²æç¤º

- ç”Ÿäº§ç¯å¢ƒæ¨èä½¿ç”¨ WSGI æœåŠ¡ï¼ˆå¦‚ Gunicorn æˆ– uWSGIï¼‰æ‰˜ç®¡åº”ç”¨ã€‚
- å¯ä½¿ç”¨ `inventory_app.create_app("/path/to/inventory.json", "/path/to/users.json")` æŒ‡å®šè‡ªå®šä¹‰çš„æŒä¹…åŒ–æ–‡ä»¶è·¯å¾„ã€‚
