# ç®€æ˜“åº“å­˜ç®¡ç†æœåŠ¡

è¿™æ˜¯ä¸€ä¸ªåŸºäº Flask çš„æç®€åº“å­˜ç®¡ç†ç¨‹åºï¼Œæä¾›æœ€åŸºç¡€çš„åº“å­˜å½•å…¥ã€å…¥åº“å’Œå‡ºåº“åŠŸèƒ½ï¼Œå¹¶ä¼šè‡ªåŠ¨è®°å½•æœ€è¿‘çš„å…¥åº“/å‡ºåº“æ—¶é—´ã€‚å®ƒå¯ä»¥éƒ¨ç½²åœ¨ä»»æ„æ”¯æŒ Python çš„æœåŠ¡å™¨ä¸Šï¼Œå…¶ä»–è®¾å¤‡å¯ä»¥é€šè¿‡ HTTP æ¥å£æˆ–ç½‘é¡µè¡¨å•æ¥è®¿é—®ã€‚ç°åœ¨åº”ç”¨å†…ç½®äº†ç”¨æˆ·ç³»ç»Ÿï¼Œæ‰€æœ‰é¡µé¢å’Œ API éƒ½éœ€è¦ç™»å½•åæ‰èƒ½ä½¿ç”¨ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ“¦ é€šè¿‡å¼¹çª—å¿«é€Ÿæ–°å¢æˆ–è®¾ç½®åº“å­˜å•†å“çš„æ•°é‡ä¸å•ä½
- â¬†ï¸ å…¥åº“ï¼šå¢åŠ æŸä¸ªå•†å“çš„æ•°é‡
- â¬‡ï¸ å‡ºåº“ï¼šå‡å°‘æŸä¸ªå•†å“çš„æ•°é‡å¹¶é˜²æ­¢å‡ºç°è´Ÿåº“å­˜
- ğŸŒ åŸºäº Bootstrap 5 æ‰“é€ çš„å“åº”å¼æ§åˆ¶é¢æ¿ï¼Œå¯ç›´æ¥åœ¨æµè§ˆå™¨æ“ä½œ
- ğŸ§­ ä»ªè¡¨ç›˜ä¸­çš„åº“å­˜è¯¦æƒ…æ”¯æŒå°±åœ°ç¼–è¾‘ï¼šå¯ç›´æ¥ä¿®æ”¹æ•°é‡ã€è°ƒæ•´å•ä½æˆ–åˆ é™¤ SKU
- ğŸ•’ è‡ªåŠ¨è¿½è¸ªæ¯ä¸ªå•†å“æœ€è¿‘çš„å…¥åº“ä¸å‡ºåº“æ—¶é—´ï¼Œå¹¶åœ¨ç•Œé¢ä¸ API ä¸­å±•ç¤º
- ğŸ“Š é¦–é¡µæä¾›ç»Ÿè®¡å¡ç‰‡ä¸å‡ºå…¥åº“åŠ¨æ€åˆ—è¡¨ï¼Œå¿«é€Ÿäº†è§£åº“å­˜æ¦‚å†µ
- ğŸ§¾ æœ€è¿‘åŠ¨æ€å¡ç‰‡ä¼šå±•ç¤ºæ–°å¢ SKUã€å…¥åº“/å‡ºåº“æ•°é‡ã€ç›˜ç‚¹è°ƒæ•´åŠåˆ é™¤è®°å½•ï¼ˆæœ€æ–° 5 æ¡ï¼‰
- ğŸ“¥ æ”¯æŒé€šè¿‡ CSV æ¨¡æ¿æ‰¹é‡å¯¼å…¥ SKUï¼Œå®Œæˆåä¼šæ˜¾ç¤ºå¯¼å…¥æ‘˜è¦
- ğŸ“¤ ä¸€é”®å¯¼å‡ºå½“å‰åº“å­˜æ¸…å•ä¸å®Œæ•´å†å²åŠ¨æ€ä¸ºè¡¨æ ¼æ–‡ä»¶ï¼Œæ–¹ä¾¿ç›˜ç‚¹å½’æ¡£
- ğŸ” åŸºäºä¼šè¯çš„èº«ä»½éªŒè¯ä¸è§’è‰²æƒé™æ§åˆ¶ï¼Œç¡®ä¿æ•æ„Ÿæ“ä½œä»…å¯¹æˆæƒç”¨æˆ·å¼€æ”¾
- ğŸ”— RESTful APIï¼Œä¾¿äºè¢« Appã€å¿«æ·æŒ‡ä»¤ç­‰å…¶ä»–å¹³å°é›†æˆ
- ğŸ’¾ ä½¿ç”¨ JSON æ–‡ä»¶æŒä¹…åŒ–åº“å­˜æ•°æ®ï¼Œå¹¶ä»¥ JSON Lines æ—¥å¿—å½¢å¼è®°å½•å…¨éƒ¨æ“ä½œå†å²

## å¿«é€Ÿå¼€å§‹

1. **å®‰è£…ä¾èµ–**

   ```bash
   python -m venv .venv
   source .venv/bin/activate  # Windows ä½¿ç”¨ .venv\\Scripts\\activate
   pip install -r requirements.txt
   ```

2. **å¯åŠ¨æœåŠ¡**

   ```bash
   flask --app inventory_app.app run --host 0.0.0.0 --port 5000
   ```

   æœåŠ¡å¯åŠ¨åï¼Œå¯åœ¨ `http://localhost:5000` è®¿é—®ç½‘é¡µç•Œé¢ã€‚

3. **é¦–æ¬¡ç™»å½•**

   ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé»˜è®¤è¶…çº§ç®¡ç†å‘˜è´¦å· `admin / admin`ã€‚è¯·ä½¿ç”¨è¯¥è´¦å·ç™»å½•åç«‹å³ä¿®æ”¹å¯†ç ï¼Œå¹¶åœ¨â€œç”¨æˆ·ç®¡ç†â€é¡µé¢æŒ‰éœ€åˆ›å»ºå…¶ä»–ç®¡ç†å‘˜æˆ–å‘˜å·¥è´¦å·ã€‚

> â„¹ï¸ ç™»å½•ç•Œé¢ä½äº `/login`ã€‚åœ¨æœªç™»å½•çŠ¶æ€ä¸‹è®¿é—®ä»»æ„é¡µé¢æˆ– API éƒ½ä¼šè¢«é‡å®šå‘è‡³æ­¤é¡µé¢ã€‚

## èº«ä»½éªŒè¯ä¸æƒé™

ç³»ç»ŸåŸºäºæœåŠ¡å™¨ç«¯ä¼šè¯ç»´æŒç™»å½•çŠ¶æ€ï¼Œæ¯ä¸ªè´¦å·ç»‘å®šä¸€ä¸ªè§’è‰²ï¼š

| è§’è‰²          | æƒé™æ¦‚è§ˆ                                                                 |
| ------------- | ------------------------------------------------------------------------ |
| `super_admin` | å…·å¤‡å…¨éƒ¨æƒé™ï¼Œå¯ç®¡ç†åº“å­˜ã€å¯¼å…¥å¯¼å‡ºã€æŸ¥çœ‹ç»Ÿè®¡ã€ç®¡ç†ç”¨æˆ·ã€æ¸…ç©ºå†å²è®°å½•ã€‚     |
| `admin`       | å¯ç®¡ç†åº“å­˜ã€å¯¼å…¥å¯¼å‡ºã€æŸ¥çœ‹ç»Ÿè®¡ï¼Œä½†æ— æ³•ç®¡ç†ç”¨æˆ·æˆ–æ¸…ç©ºå†å²è®°å½•ã€‚           |
| `staff`       | ä»…èƒ½æŸ¥çœ‹åº“å­˜æ•°æ®ã€æ‰§è¡Œå‡ºåº“æ“ä½œåŠä¸‹è½½å¯¼å‡ºæ–‡ä»¶ã€‚                           |

> ğŸ” ä¼šè¯æœ‰æ•ˆæœŸä¸º 14 å¤©ï¼Œæ‰‹åŠ¨é€€å‡ºç™»å½•æˆ–æ¸…é™¤æµè§ˆå™¨ Cookie ä¼šç«‹å³å¤±æ•ˆã€‚

## API è¯´æ˜

æ‰€æœ‰ API éƒ½éœ€è¦åœ¨ç™»å½•çŠ¶æ€ä¸‹è®¿é—®ï¼›ä¸åŒç«¯ç‚¹è¿˜ä¼šæ ¹æ®è§’è‰²é™åˆ¶æ“ä½œã€‚è¯·æ±‚å’Œå“åº”é»˜è®¤ä½¿ç”¨ JSONã€‚

### è·å–ä¼šè¯ï¼ˆç™»å½•ï¼‰

API è°ƒç”¨å‰éœ€è¦å…ˆé€šè¿‡ç™»å½•æ¥å£å»ºç«‹ä¼šè¯ï¼Œå¯ä½¿ç”¨æµè§ˆå™¨æˆ–å‘½ä»¤è¡Œå·¥å…·ï¼ˆå¦‚ `curl`ï¼‰å®Œæˆï¼š

```bash
# Step 1: ç™»å½•å¹¶ä¿å­˜ Cookie
curl -c cookies.txt -X POST http://localhost:5000/login \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "username=admin&password=admin"

# Step 2: ä½¿ç”¨ä¿å­˜çš„ Cookie è®¿é—® API
curl -b cookies.txt http://localhost:5000/api/items
```

å¦‚æœéœ€è¦åœ¨è„šæœ¬ä¸­è°ƒç”¨ APIï¼Œè¯·åœ¨ç¬¬ä¸€æ¬¡ç™»å½•åç¼“å­˜ Cookie æ–‡ä»¶æˆ–åœ¨åº”ç”¨å†…å®ç°åŸºäºè¡¨å•çš„ç™»å½•æµç¨‹ã€‚

### è·å–åº“å­˜åˆ—è¡¨

- `GET /api/items`
- **æƒé™è¦æ±‚ï¼š** ä»»æ„ç™»å½•ç”¨æˆ·ï¼ˆ`staff` åŠä»¥ä¸Šï¼‰
- å“åº”ç¤ºä¾‹ï¼š

  ```json
  [
    {
      "name": "èºä¸",
      "quantity": 100,
      "unit": "ç›’",
      "last_in": "2024-05-20T09:31:22.551274+00:00",
      "last_out": "2024-05-21T01:03:10.028741+00:00",
      "created_at": "2024-05-18T08:12:02.102932+00:00",
      "created_quantity": 100,
      "last_in_delta": 20,
      "last_out_delta": 5
    },
    {
      "name": "æ‰³æ‰‹",
      "quantity": 10,
      "unit": "æŠŠ",
      "last_in": "2024-05-18T15:08:09.431220+00:00",
      "last_out": null,
      "created_at": "2024-05-17T10:02:44.112311+00:00",
      "created_quantity": 10,
      "last_in_delta": 10,
      "last_out_delta": null
    }
  ]
  ```

### æ–°å¢æˆ–è®¾ç½®åº“å­˜

- `POST /api/items`
- **æƒé™è¦æ±‚ï¼š** `admin` æˆ– `super_admin`
- è¯·æ±‚ä½“ï¼š

  ```json
  {"name": "èºä¸", "quantity": 50, "unit": "ç›’"}
  ```

### æ›´æ–°ç°æœ‰åº“å­˜ï¼ˆæ•°é‡/å•ä½ï¼‰

- `PUT /api/items/<name>`
- **æƒé™è¦æ±‚ï¼š** `admin` æˆ– `super_admin`
- è¯·æ±‚ä½“ï¼š

  ```json
  {"quantity": 60, "unit": "ç®±"}
  ```

  å½“ç›®æ ‡ SKU ä¸å­˜åœ¨æ—¶è¿”å› 404ã€‚

### å…¥åº“

- `POST /api/items/<name>/in`
- **æƒé™è¦æ±‚ï¼š** `admin` æˆ– `super_admin`
- è¯·æ±‚ä½“ï¼š

  ```json
  {"quantity": 25}
  ```

### å‡ºåº“

- `POST /api/items/<name>/out`
- **æƒé™è¦æ±‚ï¼š** ä»»æ„ç™»å½•ç”¨æˆ·ï¼ˆ`staff` åŠä»¥ä¸Šï¼‰
- è¯·æ±‚ä½“ï¼š

  ```json
  {"quantity": 10}
  ```

  å¦‚æœå‡ºåº“æ•°é‡è¶…è¿‡å½“å‰åº“å­˜ï¼Œå°†è¿”å›é”™è¯¯æç¤ºã€‚

### åˆ é™¤åº“å­˜

- `DELETE /api/items/<name>`
- **æƒé™è¦æ±‚ï¼š** `admin` æˆ– `super_admin`
- åˆ é™¤åä¼šåœ¨æ“ä½œæ—¥å¿—ä¸­è®°å½•ä¸€æ¡åˆ é™¤äº‹ä»¶ï¼Œä¾¿äºè¿½æº¯ã€‚

### æ‰¹é‡å¯¼å…¥åº“å­˜

- `POST /api/items/import`
- **æƒé™è¦æ±‚ï¼š** `admin` æˆ– `super_admin`
- æ”¯æŒä¸¤ç§è¯·æ±‚æ–¹å¼ï¼š
  - `multipart/form-data` ä¸Šä¼  CSV æ–‡ä»¶ï¼ˆå­—æ®µåŒ…å« `name`, `quantity`, `unit`ï¼‰ã€‚
  - ç›´æ¥æäº¤ JSON æ•°ç»„ï¼š`[{"name": "å’–å•¡è±†", "quantity": 50, "unit": "è¢‹"}]`
- è¿”å›å¯¼å…¥æˆåŠŸçš„æ¡ç›®åŠæ•°é‡ç»Ÿè®¡ã€‚å¯¹äºç½‘é¡µç«¯ï¼Œé¡µé¢å³ä¸Šè§’çš„â€œæ‰¹é‡æ“ä½œâ€èœå•ä¼šè°ƒç”¨ `/import` è¡¨å•ç«¯ç‚¹è¿›è¡Œä¸Šä¼ ï¼Œå¹¶å°†ç»“æœæ‘˜è¦æ˜¾ç¤ºåœ¨åº“å­˜åˆ—è¡¨ä¸Šæ–¹ã€‚

### å¯¼å‡ºåº“å­˜æ¸…å•

- `GET /api/items/export`
- **æƒé™è¦æ±‚ï¼š** ä»»æ„ç™»å½•ç”¨æˆ·ï¼ˆ`staff` åŠä»¥ä¸Šï¼‰
- è¿”å› UTF-8 å¸¦ BOM çš„ CSV æ–‡ä»¶ï¼ŒåŒ…å« SKUã€æ•°é‡ã€å•ä½ã€æœ€è¿‘å‡ºå…¥åº“ç­‰å­—æ®µï¼Œå¯ç›´æ¥ç”¨äºç›˜ç‚¹ã€‚

### ä¸‹è½½å¯¼å…¥æ¨¡æ¿

- `GET /api/items/template`
- **æƒé™è¦æ±‚ï¼š** ä»»æ„ç™»å½•ç”¨æˆ·ï¼ˆ`staff` åŠä»¥ä¸Šï¼‰
- è·å–ç¤ºä¾‹ CSV æ¨¡æ¿ï¼Œä¾¿äºæŒ‰æ ¼å¼å¡«å†™æ‰¹é‡å¯¼å…¥æ•°æ®ã€‚

### æŸ¥è¯¢æ“ä½œå†å²

- `GET /api/history`
- **æƒé™è¦æ±‚ï¼š** ä»»æ„ç™»å½•ç”¨æˆ·ï¼ˆ`staff` åŠä»¥ä¸Šï¼‰
- å¯é€‰æŸ¥è¯¢å‚æ•°ï¼š`limit`ï¼ˆæ•´æ•°ï¼Œé™åˆ¶è¿”å›æ¡ç›®æ•°é‡ï¼‰
- å“åº”ç¤ºä¾‹ï¼š

  ```json
  [
    {
      "timestamp": "2024-05-22T10:10:12.102932+00:00",
      "action": "in",
      "name": "å’–å•¡è±†",
      "meta": {
        "delta": 5,
        "new_quantity": 20,
        "unit": "è¢‹"
      }
    },
    {
      "timestamp": "2024-05-22T09:58:44.551274+00:00",
      "action": "create",
      "name": "å’–å•¡è±†",
      "meta": {
        "quantity": 15,
        "unit": "è¢‹"
      }
    }
  ]
  ```

æ‰€æœ‰æ“ä½œå†å²ä¼šå†™å…¥ `inventory_data.history.jsonl`ï¼ˆæˆ–è‡ªå®šä¹‰è·¯å¾„ï¼‰æ–‡ä»¶ä¸­ï¼Œä¾¿äºé•¿ä¹…è¿½è¸ªä¸å¤–éƒ¨ç³»ç»Ÿè¯»å–ã€‚

### å¯¼å‡ºæ“ä½œå†å²

- `GET /api/history/export`
- **æƒé™è¦æ±‚ï¼š** ä»»æ„ç™»å½•ç”¨æˆ·ï¼ˆ`staff` åŠä»¥ä¸Šï¼‰
- ä»¥ CSV å½¢å¼è¾“å‡ºå®Œæ•´å†å²è®°å½•ï¼ŒåŒ…å«äº‹ä»¶åç§°ã€åŠ¨ä½œã€è¯¦æƒ…åŠåŸå§‹å…ƒæ•°æ® JSON å­—æ®µï¼Œæ–¹ä¾¿åœ¨ Excel æˆ–å…¶ä»–å·¥å…·ä¸­è¿›è¡Œåˆ†æã€‚

### å¯¼å‡ºç»Ÿè®¡æŠ¥è¡¨

- `GET /api/history/stats/export`
- **æƒé™è¦æ±‚ï¼š** `admin` æˆ– `super_admin`
- åŸºäºå†å²è®°å½•ç”ŸæˆæŒ‡å®šæ—¶é—´æ®µçš„å…¥åº“ã€å‡ºåº“åŠå‡€å˜åŠ¨ç»Ÿè®¡ï¼Œè¿”å› CSV æ–‡ä»¶ä¾¿äºè¿›ä¸€æ­¥åˆ†æã€‚

## è¿è¡Œæµ‹è¯•

```bash
pytest
```

## éƒ¨ç½²æç¤º

- ç”Ÿäº§ç¯å¢ƒä¸­è¯·ä½¿ç”¨ WSGI æœåŠ¡ï¼ˆå¦‚ Gunicorn æˆ– uWSGIï¼‰è¿›è¡Œéƒ¨ç½²ã€‚
- å¦‚éœ€æŒä¹…åŒ–æ•°æ®ï¼Œå¯å°† `inventory_data.json` æ–‡ä»¶æ”¾ç½®åœ¨æŒä¹…åŒ–å­˜å‚¨ç›®å½•ï¼Œå¹¶åœ¨åˆ›å»ºåº”ç”¨æ—¶æŒ‡å®šè·¯å¾„ï¼š

  ```python
  from inventory_app import create_app

  app = create_app("/path/to/data/inventory_data.json")
  ```
