<!doctype html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>星选送库存控制中心</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #eef1f9;
        --fg: #111827;
        --muted: #6b7280;
        --surface: rgba(255, 255, 255, 0.94);
        --panel: rgba(255,255,255,0.82);
        --border: rgba(148, 163, 184, 0.35);
        --border-strong: rgba(100, 116, 139, 0.45);
        --accent: #4c6ef5;
        --accent-soft: rgba(76, 110, 245, 0.12);
        --danger: #ef4444;
        --warning: #f59e0b;
        --success: #10b981;
        --shadow: 0 28px 60px rgba(15, 23, 42, 0.15);
        --radius-lg: 24px;
        --radius-md: 16px;
      }
      :root.dark {
        --bg: #050a18;
        --fg: #f8fafc;
        --muted: #94a3b8;
        --surface: rgba(12, 18, 36, 0.9);
        --panel: rgba(12, 18, 36, 0.78);
        --border: rgba(100, 116, 139, 0.22);
        --border-strong: rgba(100, 116, 139, 0.35);
        --shadow: 0 28px 60px rgba(2, 6, 23, 0.6);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Inter", "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
        background: radial-gradient(circle at top left, rgba(76, 110, 245, 0.15), transparent 55%),
                    radial-gradient(circle at bottom right, rgba(20, 184, 166, 0.08), transparent 60%),
                    var(--bg);
        color: var(--fg);
      }
      a { color: inherit; text-decoration: none; }
      .hidden { display: none !important; }
      .flex { display: flex !important; }
      .app-shell {
        min-height: 100vh;
        display: grid;
        grid-template-columns: 280px minmax(0, 1fr);
        gap: 0;
      }
      .sidebar {
        position: sticky;
        top: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding: 32px 28px;
        background: var(--surface);
        border-right: 1px solid var(--border);
        box-shadow: inset -1px 0 0 rgba(255,255,255,0.04);
      }
      .sidebar__brand {
        position: relative;
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 18px 20px;
        border-radius: 20px;
        background: linear-gradient(135deg, rgba(76, 110, 245, 0.16), rgba(14, 116, 144, 0.08));
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 18px 38px rgba(15, 23, 42, 0.12);
      }
      .brand-logo {
        position: relative;
        display: grid;
        place-items: center;
        width: 48px;
        height: 48px;
        border-radius: 16px;
        background: radial-gradient(circle at 30% 30%, rgba(248, 250, 252, 0.9), rgba(226, 232, 240, 0.45));
        border: 1px solid rgba(148, 163, 184, 0.45);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), 0 10px 24px rgba(15, 23, 42, 0.12);
        color: var(--accent);
      }
      .brand-logo::after {
        content: "";
        position: absolute;
        inset: -6px;
        border-radius: 20px;
        background: radial-gradient(circle, rgba(79, 70, 229, 0.14), transparent 65%);
        z-index: -1;
      }
      .brand-logo svg { width: 26px; height: 26px; }
      .brand-meta {
        display: grid;
        gap: 4px;
      }
      .brand-title {
        font-size: 18px;
        font-weight: 700;
        letter-spacing: -0.01em;
      }
      .brand-subtitle {
        font-size: 12px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.9);
      }
      .sidebar__section {
        display: grid;
        gap: 18px;
      }
      .sidebar label {
        display: grid;
        gap: 8px;
        font-size: 13px;
        color: var(--muted);
      }
      select,
      input,
      textarea {
        font: inherit;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: var(--panel);
        color: var(--fg);
        padding: 10px 14px;
      }
      textarea { resize: vertical; }
      select:focus,
      input:focus,
      textarea:focus {
        outline: 2px solid rgba(76, 110, 245, 0.35);
        outline-offset: 2px;
      }
      .sidebar__nav {
        display: grid;
        gap: 8px;
      }
      .nav-btn {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        border-radius: 14px;
        border: 1px solid transparent;
        background: transparent;
        font-size: 14px;
        color: var(--muted);
        transition: background 0.2s ease, border 0.2s ease, color 0.2s ease;
      }
      .nav-btn.active {
        background: var(--accent-soft);
        border-color: var(--border);
        color: var(--fg);
      }
      .sidebar__footer {
        margin-top: auto;
        display: grid;
        gap: 12px;
        font-size: 13px;
        color: var(--muted);
      }
      .sidebar__footer form { margin: 0; }
      .powered-card {
        margin-top: 4px;
        padding: 16px;
        border-radius: 18px;
        background: radial-gradient(120% 120% at 100% 0%, rgba(76, 110, 245, 0.18), rgba(14, 116, 144, 0.08) 55%, rgba(15, 23, 42, 0.05) 100%);
        border: 1px solid rgba(148, 163, 184, 0.25);
        box-shadow: 0 18px 38px rgba(15, 23, 42, 0.08);
        display: grid;
        gap: 6px;
        text-align: center;
      }
      .powered-card__label {
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.14em;
        color: rgba(148, 163, 184, 0.9);
      }
      .powered-card__brand {
        font-size: 16px;
        font-weight: 600;
        color: var(--fg);
      }
      .powered-card--mobile {
        display: none;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        border-radius: 14px;
        padding: 10px 16px;
        border: 1px solid transparent;
        background: transparent;
        color: inherit;
        font: inherit;
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
      }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; }
      .btn--primary {
        background: linear-gradient(135deg, #4c6ef5, #5b8ef9);
        color: #fff;
        box-shadow: 0 18px 40px rgba(76, 110, 245, 0.25);
      }
      .btn--ghost {
        border-color: var(--border);
        background: transparent;
        color: var(--fg);
      }
      .btn--outline {
        border-color: var(--border);
        background: var(--panel);
      }
      .btn--danger {
        border-color: rgba(239, 68, 68, 0.35);
        color: #dc2626;
      }
      :root.dark .btn--danger { color: #fca5a5; }
      header.main-header {
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(18px);
        background: var(--surface);
        border-bottom: 1px solid var(--border);
      }
      .header-inner {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 16px;
        padding: 20px 32px;
      }
      .search-group {
        display: flex;
        flex: 1 1 280px;
        gap: 12px;
        align-items: center;
      }
      .search-group input {
        flex: 1 1 auto;
      }
      .filter-group {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .header-actions {
        margin-left: auto;
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .dropdown {
        position: relative;
      }
      .menu {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        min-width: 200px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: var(--surface);
        box-shadow: var(--shadow);
        padding: 8px;
        display: grid;
        gap: 6px;
        z-index: 40;
      }
      .menu button,
      .menu a {
        display: flex;
        width: 100%;
        align-items: center;
        justify-content: flex-start;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 12px;
        border: none;
        background: transparent;
        font: inherit;
        color: inherit;
        cursor: pointer;
      }
      .menu button:hover,
      .menu a:hover {
        background: rgba(148, 163, 184, 0.15);
      }
      .theme-toggle {
        position: relative;
        width: 44px;
        height: 44px;
        padding: 0;
        border-color: var(--border);
        background: var(--panel);
        color: var(--fg);
        overflow: hidden;
      }
      .theme-toggle:focus-visible {
        outline: 2px solid rgba(76, 110, 245, 0.45);
        outline-offset: 3px;
      }
      .theme-toggle__icon {
        position: absolute;
        inset: 0;
        margin: auto;
        width: 20px;
        height: 20px;
        opacity: 0;
        transform: scale(0.75) rotate(8deg);
        transition: opacity 0.28s ease, transform 0.28s ease;
      }
      .theme-toggle__icon--sun {
        opacity: 1;
        transform: scale(1);
      }
      .theme-toggle__icon--moon {
        transform: scale(0.8) rotate(-10deg);
      }
      :root.dark .theme-toggle {
        background: rgba(76, 110, 245, 0.16);
        border-color: rgba(99, 102, 241, 0.4);
        color: #f8fafc;
      }
      :root.dark .theme-toggle__icon--sun {
        opacity: 0;
        transform: scale(0.65) rotate(-12deg);
      }
      :root.dark .theme-toggle__icon--moon {
        opacity: 1;
        transform: scale(1);
      }
      main {
        padding: 32px;
        display: grid;
        gap: 28px;
      }
      .summary-grid {
        display: grid;
        gap: 18px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      .summary-card {
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        background: var(--surface);
        padding: 24px;
        box-shadow: var(--shadow);
        display: grid;
        gap: 10px;
      }
      .summary-card small { color: var(--muted); }
      .summary-card strong { font-size: 28px; letter-spacing: -0.02em; }
      .content-grid {
        display: grid;
        gap: 24px;
      }
      @media (min-width: 1200px) {
        .content-grid.two-column {
          grid-template-columns: minmax(0, 2.1fr) minmax(0, 1fr);
        }
      }
      .panel {
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        background: var(--surface);
        box-shadow: var(--shadow);
        padding: 24px;
        display: grid;
        gap: 20px;
      }
      .panel--flush { padding: 0; }
      .panel__header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .panel__header h2 {
        margin: 0;
        font-size: 20px;
        letter-spacing: -0.02em;
      }
      .panel__meta { color: var(--muted); font-size: 13px; }
      .inventory-list {
        display: grid;
        border-radius: var(--radius-lg);
        overflow: hidden;
        border: 1px solid var(--border);
      }
      .inventory-item {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border);
        display: grid;
        gap: 18px;
        background: var(--panel);
      }
      .inventory-item:last-child { border-bottom: none; }
      .inventory-item.low {
        border-left: 4px solid rgba(239, 68, 68, 0.6);
        background: rgba(239, 68, 68, 0.08);
      }
      :root.dark .inventory-item.low {
        background: rgba(239, 68, 68, 0.15);
      }
      .item-top {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: space-between;
        align-items: flex-start;
      }
      .item-name {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        letter-spacing: -0.01em;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(239, 68, 68, 0.35);
        color: #dc2626;
        background: rgba(239, 68, 68, 0.12);
      }
      :root.dark .badge { color: #fca5a5; }
      .chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 2px 10px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(148, 163, 184, 0.14);
        color: var(--muted);
        font-size: 12px;
        font-weight: 600;
        line-height: 1.4;
        white-space: nowrap;
      }
      .chip.success {
        border-color: rgba(16, 185, 129, 0.35);
        background: rgba(16, 185, 129, 0.16);
        color: #047857;
      }
      .chip.danger {
        border-color: rgba(239, 68, 68, 0.28);
        background: rgba(239, 68, 68, 0.16);
        color: #b91c1c;
      }
      .chip.warning {
        border-color: rgba(245, 158, 11, 0.35);
        background: rgba(245, 158, 11, 0.16);
        color: #92400e;
      }
      .chip.accent {
        border-color: rgba(76, 110, 245, 0.45);
        background: rgba(76, 110, 245, 0.18);
        color: var(--accent);
      }
      .chip.neutral {
        border-color: rgba(148, 163, 184, 0.4);
        background: rgba(148, 163, 184, 0.18);
        color: var(--muted);
      }
      :root.dark .chip.success { color: #34d399; }
      :root.dark .chip.danger { color: #fca5a5; }
      :root.dark .chip.warning { color: #fbbf24; }
      :root.dark .chip.accent { color: #8da2fb; }
      .quantity-chip {
        border-radius: 999px;
        border: 1px solid rgba(76, 110, 245, 0.35);
        padding: 6px 12px;
        font-size: 14px;
        background: rgba(76, 110, 245, 0.12);
        color: var(--fg);
      }
      .item-details {
        display: grid;
        gap: 6px;
        font-size: 13px;
        color: var(--muted);
      }
      .inventory-form {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
      .inventory-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      .inventory-actions form {
        margin: 0;
        display: inline-flex;
      }
      .inventory-form label {
        display: grid;
        gap: 8px;
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .inventory-form .actions {
        grid-column: 1 / -1;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: flex-end;
      }
      .form-alert {
        grid-column: 1 / -1;
        padding: 12px 16px;
        border-radius: 14px;
        border: 1px solid rgba(239, 68, 68, 0.35);
        background: rgba(239, 68, 68, 0.12);
        color: #b91c1c;
        font-size: 13px;
      }
      :root.dark .form-alert {
        background: rgba(239, 68, 68, 0.16);
        color: #fca5a5;
      }
      .batch-adjust__mode {
        grid-column: 1 / -1;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px;
        border-radius: 16px;
        background: var(--panel);
        border: 1px solid var(--border);
      }
      .batch-mode__btn {
        flex: 1 1 auto;
        padding: 8px 16px;
        border-radius: 12px;
        border: 1px solid transparent;
        background: transparent;
        color: var(--muted);
        font-size: 13px;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        transition: all 0.2s ease;
      }
      .batch-mode__btn.active {
        color: #fff;
        background: var(--accent);
        border-color: var(--accent);
        box-shadow: 0 8px 20px rgba(76, 110, 245, 0.25);
      }
      .batch-mode__btn:focus-visible {
        outline: 2px solid rgba(76, 110, 245, 0.45);
        outline-offset: 2px;
      }
      .batch-adjust__editor {
        grid-column: 1 / -1;
        display: grid;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 16px;
        background: var(--panel);
        border: 1px solid var(--border);
      }
      .batch-adjust__inputs {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
      .batch-adjust__inputs label {
        margin: 0;
      }
      .batch-adjust__list {
        grid-column: 1 / -1;
        display: grid;
        gap: 12px;
        max-height: 240px;
        overflow-y: auto;
        padding: 4px;
      }
      .batch-adjust__item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 16px;
        background: var(--panel);
        border: 1px solid var(--border);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08);
      }
      .batch-adjust__item-main {
        display: grid;
        gap: 4px;
      }
      .batch-adjust__item-name {
        font-weight: 600;
      }
      .batch-adjust__item-meta {
        font-size: 13px;
        color: var(--muted);
      }
      .batch-adjust__item-error {
        font-size: 12px;
        color: var(--danger);
      }
      :root.dark .batch-adjust__item-error {
        color: #fca5a5;
      }
      .batch-adjust__item.batch-adjust__item--error {
        border-color: rgba(239, 68, 68, 0.65);
        background: rgba(239, 68, 68, 0.08);
      }
      .batch-adjust__empty {
        padding: 24px 12px;
        text-align: center;
        border: 1px dashed var(--border);
        border-radius: 16px;
        color: var(--muted);
      }
      .batch-adjust__remove {
        white-space: nowrap;
      }
      @media (max-width: 768px) {
        .batch-adjust__editor {
          padding: 12px;
        }
        .batch-adjust__item {
          align-items: flex-start;
        }
        .batch-adjust__mode {
          flex-direction: column;
          align-items: stretch;
        }
      }
      .pagination {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        font-size: 13px;
        color: var(--muted);
      }
      .pagination form { display: flex; align-items: center; gap: 6px; }
      .pagination select { padding: 8px 12px; }
      .timeline-header {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .timeline-header__main {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .timeline-header__title {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .timeline-header__meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        font-size: 13px;
        color: var(--muted);
      }
      .timeline-actions {
        display: inline-flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }
      .timeline-actions form {
        margin: 0;
        display: inline-flex;
      }
      .timeline-toolbar {
        display: grid;
        gap: 12px;
      }
      .timeline-filters {
        display: grid;
        gap: 10px;
      }
      .timeline-filters form {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
      }
      .timeline-filters label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--muted);
        width: 100%;
      }
      .timeline-filters select {
        flex: 1 1 160px;
        min-width: 0;
        padding: 8px 12px;
      }
      .timeline-pagination {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        font-size: 13px;
        color: var(--muted);
      }
      .timeline-pagination__buttons {
        display: flex;
        gap: 6px;
      }
      .timeline-list {
        display: grid;
        gap: 16px;
      }
      .timeline-item {
        display: grid;
        gap: 10px;
        padding: 16px 18px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: var(--panel);
      }
      .timeline-item__marker {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        font-size: 12px;
        color: var(--muted);
      }
      .timeline-item__content {
        display: grid;
        gap: 8px;
      }
      .timeline-item__title {
        font-weight: 600;
      }
      .timeline-item__meta {
        font-size: 13px;
        color: var(--muted);
      }
      .timeline-item__details {
        font-size: 13px;
        color: inherit;
      }
      .timeline-item__list {
        margin: 0;
        padding-left: 18px;
      }
      .timeline-badge {
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 10px;
      }
      .timeline-item__time {
        font-size: 12px;
        color: var(--muted);
      }
      .timeline-badge.success { background: rgba(16, 185, 129, 0.12); color: #047857; border: 1px solid rgba(16,185,129,0.28); }
      .timeline-badge.danger { background: rgba(239, 68, 68, 0.12); color: #b91c1c; border: 1px solid rgba(239,68,68,0.28); }
      .timeline-badge.neutral { background: rgba(148, 163, 184, 0.12); color: var(--muted); border: 1px solid rgba(148,163,184,0.3); }
      :root.dark .timeline-badge.success { color: #34d399; }
      :root.dark .timeline-badge.danger { color: #fca5a5; }
      .timeline-demo-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(76, 110, 245, 0.12);
        color: var(--accent);
        font-size: 12px;
      }
      .timeline-demo-banner {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 12px 16px;
        border-radius: 14px;
        background: rgba(76, 110, 245, 0.08);
        color: var(--muted);
        font-size: 13px;
      }
      .timeline-demo-banner strong {
        color: var(--accent);
      }
      @media (min-width: 720px) {
        .timeline-toolbar {
          gap: 20px;
        }
        .timeline-filters {
          display: flex;
          flex-wrap: wrap;
          align-items: center;
          gap: 16px;
        }
        .timeline-filters form {
          flex: 0 1 220px;
        }
      }
      @media (min-width: 960px) {
        .timeline-header {
          flex-direction: row;
          align-items: center;
          justify-content: space-between;
          gap: 24px;
        }
        .timeline-header__main {
          flex-direction: row;
          align-items: baseline;
          gap: 18px;
        }
        .timeline-header__title {
          flex-direction: column;
          gap: 6px;
        }
        .timeline-actions {
          margin-left: auto;
          flex-wrap: nowrap;
          gap: 10px;
        }
        .timeline-actions form {
          width: auto;
        }
        .timeline-toolbar {
          grid-template-columns: minmax(0, 1fr) auto;
          align-items: flex-end;
          gap: 12px 16px;
        }
        .timeline-filters {
          display: inline-flex;
          flex-wrap: wrap;
          align-items: flex-end;
          gap: 12px;
        }
        .timeline-filters form {
          flex: 0 0 auto;
        }
        .timeline-filters label {
          width: auto;
          gap: 6px;
        }
        .timeline-pagination {
          justify-content: flex-end;
          gap: 12px;
        }
      }
      @media (min-width: 640px) {
        .timeline-item {
          grid-template-columns: auto 1fr;
          align-items: flex-start;
        }
        .timeline-item__marker {
          flex-direction: column;
          align-items: flex-start;
        }
      }
      .alert-stack {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(239, 68, 68, 0.35);
        background: rgba(239, 68, 68, 0.12);
        padding: 20px;
        display: grid;
        gap: 12px;
      }
      :root.dark .alert-stack {
        background: rgba(239, 68, 68, 0.18);
      }
      .alert-stack h3 { margin: 0; font-size: 18px; }
      .alert-stack ul { margin: 0; padding-left: 18px; color: #b91c1c; }
      :root.dark .alert-stack ul { color: #fca5a5; }
      .modal {
        position: fixed;
        inset: 0;
        z-index: 60;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .modal.flex { display: flex; }
      .modal::before {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        backdrop-filter: blur(12px);
      }
      .modal__dialog {
        position: relative;
        z-index: 1;
        width: min(720px, 100%);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        background: var(--surface);
        box-shadow: var(--shadow);
        padding: 28px;
        display: grid;
        gap: 20px;
      }
      #lowStockModal .modal__dialog {
        max-height: min(90vh, 720px);
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      #lowStockModal .modal__body {
        flex: 1 1 auto;
        overflow: auto;
      }
      #lowStockModal .modal__footer {
        display: flex;
        justify-content: flex-end;
      }
      #importPreviewModal .modal__dialog {
        max-height: min(92vh, 760px);
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .import-preview__content {
        flex: 1 1 auto;
        min-height: 0;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .import-preview__table-wrapper {
        flex: 1 1 auto;
        min-height: 0;
        overflow: auto;
        border: 1px solid var(--border);
        border-radius: 18px;
        background: var(--panel);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
        max-height: clamp(240px, 60vh, 440px);
      }
      .import-preview__table-wrapper::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      .import-preview__table-wrapper::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.4);
        border-radius: 999px;
      }
      :root.dark .import-preview__table-wrapper::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.3);
      }
      #importPreviewTable {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 13px;
        min-width: 560px;
      }
      #importPreviewTable thead th {
        position: sticky;
        top: 0;
        background: rgba(148, 163, 184, 0.16);
        backdrop-filter: blur(4px);
        border-bottom: 1px solid var(--border);
        padding: 12px 16px;
        font-weight: 600;
        letter-spacing: 0.01em;
        text-transform: none;
      }
      :root.dark #importPreviewTable thead th {
        background: rgba(30, 41, 59, 0.82);
      }
      #importPreviewTable tbody tr {
        transition: background 0.18s ease;
      }
      #importPreviewTable tbody tr:hover td {
        background: rgba(148, 163, 184, 0.12);
      }
      #importPreviewTable tbody td {
        padding: 14px 16px;
        vertical-align: top;
        border-bottom: 1px solid var(--border);
      }
      #importPreviewTable tbody tr:last-child td {
        border-bottom: none;
      }
      .import-preview__row td:first-child {
        border-left: 4px solid transparent;
      }
      .import-preview__row.is-new td:first-child {
        border-left-color: rgba(16, 185, 129, 0.85);
      }
      .import-preview__row.is-updated td:first-child {
        border-left-color: rgba(76, 110, 245, 0.8);
      }
      .import-preview__row.is-invalid td:first-child {
        border-left-color: rgba(239, 68, 68, 0.85);
      }
      .import-preview__row.is-invalid td {
        background: rgba(239, 68, 68, 0.08);
      }
      :root.dark .import-preview__row.is-invalid td {
        background: rgba(239, 68, 68, 0.18);
      }
      .import-preview__name {
        font-weight: 600;
        letter-spacing: -0.01em;
      }
      .import-preview__name--missing {
        color: #b91c1c;
      }
      :root.dark .import-preview__name--missing {
        color: #fca5a5;
      }
      .import-preview__meta {
        margin-top: 4px;
        font-size: 12px;
        color: var(--muted);
      }
      .import-preview__value {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-variant-numeric: tabular-nums;
      }
      .import-preview__arrow {
        opacity: 0.55;
      }
      .import-preview__status {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .import-preview__messages {
        display: grid;
        gap: 8px;
      }
      .import-preview__message {
        border-radius: 12px;
        border: 1px solid rgba(239, 68, 68, 0.25);
        background: rgba(239, 68, 68, 0.12);
        color: #b91c1c;
        padding: 8px 10px;
        font-size: 12px;
        line-height: 1.5;
      }
      :root.dark .import-preview__message {
        background: rgba(239, 68, 68, 0.24);
        color: #fca5a5;
      }
      .import-preview__muted {
        color: var(--muted);
        font-size: 12px;
      }
      .import-preview__summary-line {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 13px;
      }
      .import-preview__hint {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
      }
      .import-preview__empty {
        padding: 28px 16px;
        text-align: center;
        color: var(--muted);
      }
      @media (max-width: 640px) {
        #importPreviewTable {
          font-size: 12px;
          min-width: 520px;
        }
        #importPreviewTable thead th,
        #importPreviewTable tbody td {
          padding: 12px 14px;
        }
      }
      .modal__close {
        position: absolute;
        top: 16px;
        right: 16px;
        border: none;
        background: transparent;
        color: var(--muted);
        font-size: 18px;
        cursor: pointer;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      th, td {
        text-align: left;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
      }
      thead { background: rgba(148, 163, 184, 0.18); }
      .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 70;
      }
      .toast__body {
        border-radius: 14px;
        background: rgba(16, 185, 129, 0.95);
        color: #fff;
        padding: 14px 18px;
        box-shadow: var(--shadow);
        font-size: 14px;
      }
      .mobile-only {
        display: none;
        width: 100%;
        gap: 12px;
      }
      .mobile-only > * {
        width: 100%;
      }
      .mobile-search {
        display: flex;
        gap: 12px;
      }
      .mobile-filters {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .mobile-filters select {
        flex: 1 1 auto;
      }
      .mobile-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .desktop-only {}
      @media (max-width: 960px) {
        .app-shell { grid-template-columns: 1fr; }
        .sidebar {
          position: static;
          height: auto;
          border-right: none;
          border-bottom: 1px solid var(--border);
          box-shadow: none;
          padding: 24px;
        }
        header.main-header { position: static; }
        .header-inner { padding: 20px 24px; }
        main { padding: 24px; }
        .mobile-only { display: grid; }
        .desktop-only { display: none !important; }
        .powered-card--desktop { display: none; }
        .powered-card--mobile {
          display: grid;
          margin: 32px 24px;
        }
      }
      @media (max-width: 640px) {
        .search-group { flex-direction: column; align-items: stretch; }
        .header-actions { width: 100%; justify-content: flex-end; gap: 10px; }
        .filter-group { width: 100%; }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <div class="sidebar__brand">
          <div class="brand-logo">
              <svg viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" role="img" focusable="false">
                <!-- 云主体 -->
                <path d="M10.5 23a6.5 6.5 0 0 1 0-13 7 7 0 0 1 13.2 2.2A5.3 5.3 0 0 1 24 23H10.5Z" fill="currentColor" fill-opacity=".05"/>
                <path d="M10.5 23a6.5 6.5 0 0 1 0-13 7 7 0 0 1 13.2 2.2A5.3 5.3 0 0 1 24 23H10.5Z"/>

                <!-- 内部高光线 -->
                <path d="M8 18c1.2-2 3.8-3 6.5-3s5.3 1 7.2 2.8" opacity=".25"/>

                <!-- 云底阴影 -->
                <ellipse cx="16" cy="24.5" rx="7" ry="1.2" fill="currentColor" fill-opacity=".06" stroke="none"/>
              </svg>
            </div>
          <div class="brand-meta">
            <span class="brand-title">星选送</span>
            <span class="brand-subtitle">智慧运营管理系统</span>
          </div>
        </div>
        <div class="sidebar__section">
          <form method="post" action="{{ url_for('select_store') }}">
            <input type="hidden" name="next" value="{{ request.full_path }}" />
            <label>
              当前门店
              <select name="store_id" onchange="this.form.submit()">
                {% for store_id, store in stores.items() %}
                  <option value="{{ store_id }}" {% if store_id == selected_store %}selected{% endif %}>
                    {{ store.name }}{% if store.items_count %}（{{ store.items_count }}）{% endif %}
                  </option>
                {% endfor %}
              </select>
            </label>
          </form>
          {% if permissions.can_manage_stores %}
            <button class="btn btn--outline" data-open-modal="#storeModal">管理门店</button>
          {% endif %}
        </div>
        <nav class="sidebar__nav">
          <a class="nav-btn active" href="{{ url_for('index') }}">库存总览</a>
          {% if permissions.can_view_history %}
            <a class="nav-btn" href="{{ url_for('recent_activity') }}">最近动态</a>
            <a class="nav-btn" href="{{ url_for('analytics_dashboard') }}">出入库统计</a>
          {% endif %}
          {% if permissions.can_manage_users %}
            <a class="nav-btn" href="{{ url_for('manage_users') }}">用户管理</a>
          {% endif %}
        </nav>
        <div class="sidebar__footer">
          <div>当前账号：<strong>{{ current_user.username }}</strong></div>
          <div>角色：{{ role_labels.get(current_user.role, current_user.role) }}</div>
          <form method="post" action="{{ url_for('logout') }}">
            <button type="submit" class="btn btn--ghost" style="padding:8px 14px;">退出登录</button>
          </form>
          <div class="powered-card powered-card--desktop">
            <span class="powered-card__label">Powered by</span>
            <span class="powered-card__brand">OnmiCloud</span>
          </div>
        </div>
      </aside>
      <div class="main">
        <header class="main-header">
          <div class="header-inner">
            <div class="search-group desktop-only">
              <input id="keyword" data-keyword-input type="search" placeholder="搜索 SKU 名称" value="{{ inventory_search }}" />
              <button type="button" data-search-button data-input-selector="#keyword" class="btn btn--primary">搜索</button>
            </div>
            <div class="filter-group desktop-only">
              <select id="categoryFilter" data-category-filter>
                <option value="">全部分类</option>
                {% for category_id, category in categories.items() %}
                  <option value="{{ category_id }}" {% if category_id == selected_category %}selected{% endif %}>{{ category.name }}</option>
                {% endfor %}
              </select>
              {% if permissions.can_manage_categories %}
                <button class="btn btn--outline" data-open-modal="#categoryModal">分类管理</button>
              {% endif %}
            </div>
            <div class="header-actions desktop-only">
              {% if permissions.can_manage_items %}
                <div class="dropdown">
                  <button id="actionsMenuBtn" class="btn btn--outline" aria-haspopup="menu" aria-expanded="false">库存操作</button>
                  <div id="actionsMenu" class="menu hidden">
                    <button type="button" data-open-modal="#addModal">新增 SKU</button>
                    <button type="button" id="batchAdjustTrigger" data-open-modal="#batchAdjustModal" data-batch-adjust-trigger>批量出入库</button>
                    <button type="button" id="importTrigger">从表格导入</button>
                    <a href="/api/items/export">导出库存表格</a>
                    <a href="/api/items/template">下载导入模板</a>
                  </div>
                </div>
              {% endif %}
              <div class="dropdown">
                <button id="userMenuBtn" class="btn btn--outline" aria-haspopup="menu" aria-expanded="false">{{ current_user.username }}</button>
                <div id="userMenu" class="menu hidden">
                  <div class="panel__meta" style="padding:10px 12px;">{{ current_user.username }} · {{ role_labels.get(current_user.role, current_user.role) }}</div>
                  {% if permissions.can_view_history %}
                    <a href="{{ url_for('recent_activity') }}">最近动态</a>
                    <a href="{{ url_for('analytics_dashboard') }}">出入库统计</a>
                  {% endif %}
                  {% if permissions.can_manage_users %}
                    <a href="{{ url_for('manage_users') }}">用户管理</a>
                  {% endif %}
                  <form method="post" action="{{ url_for('logout') }}" style="margin:0;">
                    <button type="submit">退出登录</button>
                  </form>
                </div>
              </div>
              <button id="themeToggle" class="btn theme-toggle" type="button" aria-label="切换深浅色" aria-pressed="false">
                <svg class="theme-toggle__icon theme-toggle__icon--sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="12" cy="12" r="5" />
                  <path d="M12 2v2.5M12 19.5V22M4.22 4.22l1.77 1.77M17.99 17.99l1.79 1.79M2 12h2.5M19.5 12H22M4.22 19.78l1.77-1.77M17.99 6.01l1.79-1.79" />
                </svg>
                <svg class="theme-toggle__icon theme-toggle__icon--moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M21 14.25A7.25 7.25 0 0110.75 4a6.25 6.25 0 000 12.5A7.25 7.25 0 0121 14.25z" />
                </svg>
              </button>
            </div>
            <div class="mobile-only">
              <div class="mobile-search">
                <input id="keywordMobile" data-keyword-input type="search" placeholder="搜索 SKU 名称" value="{{ inventory_search }}" />
                <button type="button" data-search-button data-input-selector="#keywordMobile" class="btn btn--outline">搜索</button>
              </div>
              <div class="mobile-filters">
                <select id="categoryFilterMobile" data-category-filter>
                  <option value="">全部分类</option>
                  {% for category_id, category in categories.items() %}
                    <option value="{{ category_id }}" {% if category_id == selected_category %}selected{% endif %}>{{ category.name }}</option>
                  {% endfor %}
                </select>
                {% if permissions.can_manage_categories %}
                  <button class="btn btn--outline" data-open-modal="#categoryModal">分类管理</button>
                {% endif %}
              </div>
              {% if permissions.can_manage_items %}
                <div class="mobile-actions">
                  <button id="importTriggerM" class="btn btn--outline" type="button">导入</button>
                  <a class="btn btn--outline" href="/api/items/template">模板</a>
                  <a class="btn btn--outline" href="/api/items/export">导出</a>
                  <button class="btn btn--outline" type="button" data-open-modal="#batchAdjustModal" data-batch-adjust-trigger>批量出入库</button>
                  <button class="btn btn--primary" data-open-modal="#addModal">新增</button>
                </div>
              {% endif %}
            </div>
          </div>
        </header>
        <main>
          <section class="summary-grid">
            <article class="summary-card">
              <small>SKU 数量</small>
              <strong>{{ summary.total_items }}</strong>
            </article>
            <article class="summary-card">
              <small>库存总数</small>
              <strong>{{ summary.total_quantity }}</strong>
            </article>
            <article class="summary-card">
              <small>库存预警数量</small>
              <strong style="color: {{ summary.low_stock_count and '#ef4444' or 'inherit' }};">{{ summary.low_stock_count }}</strong>
            </article>
            <article class="summary-card">
              <small>出入库</small>
              <div class="panel__meta">入 {{ summary.latest_in|format_datetime('%Y-%m-%d %H:%M') }} · 出 {{ summary.latest_out|format_datetime('%Y-%m-%d %H:%M') }}</div>
            </article>
          </section>

          {% if low_stock_items %}
            <section class="alert-stack">
              <div class="panel__header">
                <h3>库存预警提醒</h3>
                <button class="btn btn--outline" data-open-modal="#lowStockModal">查看全部</button>
              </div>
              <p class="panel__meta">共有 {{ low_stock_items|length }} 个 SKU 达到阈值，请及时补货。</p>
              <ul>
                {% for item in low_stock_items[:4] %}
                  <li>{{ item.name }} · 当前 {{ item.quantity }}{% if item.unit %} {{ item.unit }}{% endif %}</li>
                {% endfor %}
              </ul>
            </section>
          {% endif %}

          <div class="content-grid">
            <section class="panel">
              <div class="panel__header">
                <h2>库存详情</h2>
                <div class="panel__meta">共 {{ inventory_pagination.total }} 项</div>
              </div>
              <div class="pagination">
                <form method="get" action="{{ url_for('index') }}">
                  {% for key, values in preserved_query.items() %}
                    {% if key not in ['inventory_per_page', 'inventory_page'] %}
                      {% for value in values %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}" />
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                  <input type="hidden" name="inventory_page" value="1" />
                  <label>每页
                    <select name="inventory_per_page" onchange="this.form.submit()">
                      {% for option in [5, 10, 20, 50] %}
                        <option value="{{ option }}" {% if inventory_pagination.per_page == option %}selected{% endif %}>{{ option }}</option>
                      {% endfor %}
                    </select>
                  </label>
                </form>
                <div style="display:flex; gap:8px; align-items:center;">
                  <span>第 {{ inventory_pagination.start_index or 0 }}-{{ inventory_pagination.end_index or 0 }} / {{ inventory_pagination.total }} 项</span>
                  <a href="{{ inventory_pagination.has_prev and build_query(inventory_page=inventory_pagination.prev_page) or '#' }}" class="btn btn--outline" style="padding:8px 12px; {% if not inventory_pagination.has_prev %}pointer-events:none; opacity:0.4;{% endif %}">上一页</a>
                  <a href="{{ inventory_pagination.has_next and build_query(inventory_page=inventory_pagination.next_page) or '#' }}" class="btn btn--outline" style="padding:8px 12px; {% if not inventory_pagination.has_next %}pointer-events:none; opacity:0.4;{% endif %}">下一页</a>
                </div>
              </div>
              {% if items %}
                <div id="inventoryList" class="inventory-list">
                  {% for item in items %}
                    {% set is_low = item.threshold is not none and item.quantity <= item.threshold %}
                    {% set category_info = categories.get(item.category) %}
                    <div class="inventory-item {% if is_low %}low{% endif %}" data-name="{{ item.name|lower }}" data-low-stock="{{ 'true' if is_low else 'false' }}">
                      <div class="item-top">
                        <div>
                          <div class="item-name">
                            <span title="{{ item.name }}">{{ item.name }}</span>
                            {% if is_low %}
                              <span class="badge">库存预警</span>
                            {% endif %}
                          </div>
                          <div class="item-details">
                            <span>最近入库：{{ item.last_in|format_datetime('%Y-%m-%d %H:%M') }}</span>
                            <span>最近出库：{{ item.last_out|format_datetime('%Y-%m-%d %H:%M') }}</span>
                            {% if item.threshold is not none %}
                              <span {% if is_low %}style="color:#ef4444;"{% endif %}>阈值提醒：≤ {{ item.threshold }}{% if item.unit %} {{ item.unit }}{% endif %}{% if is_low %}（当前已触发）{% endif %}</span>
                            {% else %}
                              <span>未设置阈值提醒</span>
                            {% endif %}
                            <span>分类：{{ category_info.name if category_info else '未分类' }}</span>
                          </div>
                        </div>
                        <span class="quantity-chip">{{ item.quantity }}{% if item.unit %} {{ item.unit }}{% endif %}</span>
                      </div>
                      <div class="inventory-actions">
                        {% if permissions.can_manage_items %}
                          <button
                            class="btn btn--outline"
                            type="button"
                            data-manage
                            data-name="{{ item.name|e }}"
                            data-quantity="{{ item.quantity }}"
                            data-unit="{{ (item.unit or '')|e }}"
                            data-category="{{ item.category or 'uncategorized' }}"
                            data-category-name="{{ (category_info.name if category_info else '未分类')|e }}"
                            data-threshold="{{ item.threshold if item.threshold is not none else '' }}"
                          >管理</button>
                        {% endif %}
                        {% if permissions.can_adjust_in %}
                          <button class="btn btn--outline" type="button" data-adjust="in" data-name="{{ item.name }}" data-unit="{{ item.unit or '' }}" data-current="{{ item.quantity }}">入库</button>
                        {% endif %}
                        {% if permissions.can_adjust_out %}
                          <button class="btn btn--outline" type="button" data-adjust="out" data-name="{{ item.name }}" data-unit="{{ item.unit or '' }}" data-current="{{ item.quantity }}">出库</button>
                        {% endif %}
                        {% if permissions.can_manage_items and stores|length > 1 %}
                          <button class="btn btn--outline" type="button" data-transfer data-name="{{ item.name }}" data-unit="{{ item.unit or '' }}" data-current="{{ item.quantity }}" data-store="{{ selected_store }}" data-store-name="{{ stores[selected_store]['name'] }}">调拨</button>
                        {% endif %}
                        {% if permissions.can_manage_items %}
                          <form method="post" action="/submit" onsubmit="return confirm('确认删除 {{ item.name }} 吗？');">
                            <input type="hidden" name="action" value="delete" />
                            <input type="hidden" name="name" value="{{ item.name }}" />
                            <input type="hidden" name="store_id" value="{{ selected_store }}" />
                            <input type="hidden" name="next" value="{{ request.full_path }}" />
                            <button class="btn btn--danger" type="submit">删除</button>
                          </form>
                        {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="panel__meta" style="padding:40px; text-align:center;">暂无库存记录，点击“库存操作”中的新增录入第一条库存。</div>
              {% endif %}
            </section>

          </div>
        </main>
      </div>
    </div>

    <div class="powered-card powered-card--mobile">
      <span class="powered-card__label">Powered by</span>
      <span class="powered-card__brand">OnmiCloud</span>
    </div>

    {% if low_stock_items %}
      <div id="lowStockModal" class="modal" data-modal>
        <div class="modal__dialog">
          <button type="button" class="modal__close" data-close-modal>&times;</button>
          <h2 style="margin:0; font-size:22px;">库存预警列表</h2>
          <p class="panel__meta">以下 SKU 库存不及阈值，请尽快安排补货。</p>
          <div class="modal__body">
            <table>
              <thead>
                <tr>
                  <th>SKU 名称</th>
                  <th>当前库存</th>
                  <th>阈值</th>
                </tr>
              </thead>
              <tbody>
                {% for item in low_stock_items %}
                  <tr>
                    <td>{{ item.name }}</td>
                    <td>{{ item.quantity }}{% if item.unit %} {{ item.unit }}{% endif %}</td>
                    <td>{{ item.threshold }}{% if item.unit %} {{ item.unit }}{% endif %}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="modal__footer">
            <button class="btn btn--primary" data-close-modal>知道了</button>
          </div>
        </div>
      </div>
    {% endif %}

    <div id="thresholdAlert" class="modal hidden" data-modal>
      <div class="modal__dialog" style="max-width:520px;">
        <button type="button" class="modal__close" data-close-alert>&times;</button>
        <h2 style="margin:0; font-size:22px;">库存预警提示</h2>
        <p class="panel__meta">您有 SKU 库存已低于设置阈值，请及时处理。</p>
        <div style="display:flex; justify-content:flex-end;">
          <button class="btn btn--primary" data-close-alert>我已知晓</button>
        </div>
      </div>
    </div>

    {% if permissions.can_manage_items %}
      <div id="manageModal" class="modal hidden" data-modal>
        <div class="modal__dialog" style="max-width:560px;">
          <button type="button" class="modal__close" data-close-modal>&times;</button>
          <h2 style="margin:0; font-size:22px;">管理 SKU</h2>
          <p id="manageSummary" class="panel__meta"></p>
          <form method="post" action="/submit" class="inventory-form" novalidate id="manageForm">
            <input type="hidden" name="action" value="update" />
            <input type="hidden" name="name" id="manageName" />
            <input type="hidden" name="store_id" value="{{ selected_store }}" />
            <input type="hidden" name="next" value="{{ request.full_path }}" />
            <label>设置数量<input name="quantity" id="manageQuantity" type="number" min="0" step="1" /></label>
            <label>单位<input name="unit" id="manageUnit" placeholder="件" /></label>
            <label>库存分类
              <select name="category" id="manageCategory">
                {% for category_id, category in categories.items() %}
                  <option value="{{ category_id }}">{{ category.name }}</option>
                {% endfor %}
              </select>
            </label>
            <label>阈值提醒（可选）<input name="threshold" id="manageThreshold" type="number" min="0" step="1" placeholder="例如 10" /></label>
            <div class="actions" style="justify-content:flex-end;">
              <button type="button" class="btn btn--ghost" data-close-modal>取消</button>
              <button type="submit" class="btn btn--primary">保存修改</button>
            </div>
          </form>
        </div>
      </div>
    {% endif %}

    <div id="addModal" class="modal hidden" data-modal>
      <div class="modal__dialog" style="max-width:600px;">
        <button type="button" class="modal__close" data-close-modal>&times;</button>
        <h2 style="margin:0; font-size:22px;">新增 SKU</h2>
        <form method="post" action="/submit" class="inventory-form" novalidate>
          <input type="hidden" name="action" value="create" />
          <label>SKU 名称<input name="name" placeholder="请输入 SKU 名称" required /></label>
          <label>数量<input name="quantity" type="number" min="0" step="1" value="0" /></label>
          <label>单位<input name="unit" placeholder="例如 件、箱" /></label>
          <label>分类
            <select name="category">
              {% for category_id, category in categories.items() %}
                <option value="{{ category_id }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </label>
          <label>阈值（可选）<input name="threshold" type="number" min="0" step="1" /></label>
          <input type="hidden" name="store_id" value="{{ selected_store }}" />
          <input type="hidden" name="next" value="{{ request.full_path }}" />
          <div class="actions" style="justify-content:flex-end;">
            <button type="button" class="btn btn--ghost" data-close-modal>取消</button>
            <button type="submit" class="btn btn--primary">保存</button>
          </div>
        </form>
      </div>
    </div>
    <div id="adjustModal" class="modal hidden" data-modal>
      <div class="modal__dialog" style="max-width:480px;">
        <button type="button" class="modal__close" data-close-modal>&times;</button>
        <h2 id="adjustModalTitle" style="margin:0; font-size:22px;">库存调整</h2>
        <p id="adjustModalInfo" class="panel__meta"></p>
        <form method="post" action="/submit" class="inventory-form" novalidate>
          <input type="hidden" name="name" id="adjustName" />
          <input type="hidden" name="store_id" value="{{ selected_store }}" />
          <input type="hidden" name="action" id="adjustAction" />
          <input type="hidden" name="next" value="{{ request.full_path }}" />
          <label id="adjustQuantityLabel">
            <span id="adjustQuantityLabelText">调整数量</span>
            <input id="adjustQuantity" name="quantity" type="number" min="1" step="1" required />
          </label>
          <label id="adjustTimeLabel">
            <span id="adjustTimeLabelText">调整时间</span>
            <input id="adjustTime" name="adjusted_at" type="datetime-local" required />
          </label>
          <div class="actions" style="justify-content:flex-end;">
            <button type="button" class="btn btn--ghost" data-close-modal>取消</button>
            <button type="submit" class="btn btn--primary" id="adjustSubmitBtn">确认</button>
          </div>
        </form>
      </div>
    </div>

    <div id="batchAdjustModal" class="modal hidden" data-modal>
      <div class="modal__dialog" style="max-width:640px;">
        <button type="button" class="modal__close" data-close-modal>&times;</button>
        <h2 style="margin:0; font-size:22px;">批量出入库</h2>
        <p class="panel__meta">逐条添加需要出入库的 SKU，一键完成批量操作。</p>
        <form id="batchAdjustForm" method="post" action="/submit" class="inventory-form" novalidate>
          <input type="hidden" name="action" value="batch_adjust" />
          <input type="hidden" name="mode" id="batchAdjustMode" value="out" />
          <input type="hidden" name="store_id" id="batchAdjustStoreId" value="{{ selected_store }}" />
          <input type="hidden" name="next" value="{{ request.full_path }}" />
          <input type="hidden" name="batch_payload" id="batchAdjustPayload" value="[]" />
          <div class="batch-adjust__mode" role="group" aria-label="批量操作类型">
            <button type="button" class="batch-mode__btn active" data-batch-mode="out">批量出库</button>
            <button type="button" class="batch-mode__btn" data-batch-mode="in">批量入库</button>
          </div>
          <div id="batchAdjustError" class="form-alert hidden" role="alert"></div>
          <div class="batch-adjust__editor">
            <div class="batch-adjust__inputs">
              <label>SKU 名称
                <input type="text" id="batchAdjustName" list="batchAdjustSkuOptions" placeholder="输入或选择 SKU 名称" autocomplete="off" />
              </label>
              <label>数量
                <input type="number" id="batchAdjustQuantity" min="1" step="1" placeholder="请输入数量" />
              </label>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
              <button type="button" class="btn btn--outline" id="batchAdjustAddBtn">添加到出库列表</button>
            </div>
          </div>
          <div class="batch-adjust__list" id="batchAdjustList">
            <div class="batch-adjust__empty">暂未添加任何记录</div>
          </div>
          <div class="actions" style="justify-content:flex-end; margin-top:8px;">
            <button type="button" class="btn btn--ghost" data-close-modal>取消</button>
            <button type="submit" class="btn btn--primary" id="batchAdjustSubmit" disabled>确认出库</button>
          </div>
        </form>
        <datalist id="batchAdjustSkuOptions">
          {% for name in all_item_names %}
            <option value="{{ name }}"></option>
          {% endfor %}
        </datalist>
      </div>
    </div>

    <div id="transferModal" class="modal hidden" data-modal>
      <div class="modal__dialog" style="max-width:520px;">
        <button type="button" class="modal__close" data-close-modal>&times;</button>
        <h2 style="margin:0; font-size:22px;">库存调拨</h2>
        <p id="transferInfo" class="panel__meta"></p>
        <form method="post" action="/submit" class="inventory-form" novalidate>
          <input type="hidden" name="action" value="transfer" />
          <input type="hidden" name="name" id="transferName" />
          <input type="hidden" name="store_id" id="transferSourceStore" value="{{ selected_store }}" />
          <input type="hidden" name="next" value="{{ request.full_path }}" />
          <div class="panel__meta">当前调出门店：<strong>{{ stores[selected_store]['name'] }}</strong></div>
          <label>调入门店
            <select name="target_store_id" id="transferTargetStore">
              {% for store_id, store in stores.items() %}
                <option value="{{ store_id }}">{{ store.name }}</option>
              {% endfor %}
            </select>
          </label>
          <label>调拨数量<input id="transferQuantity" name="quantity" type="number" min="1" step="1" required /></label>
          <div class="actions" style="justify-content:flex-end;">
            <button type="button" class="btn btn--ghost" data-close-modal>取消</button>
            <button type="submit" class="btn btn--primary" id="transferSubmitBtn">确认调拨</button>
          </div>
        </form>
      </div>
    </div>

    <div id="storeModal" class="modal hidden" data-modal>
      <div class="modal__dialog" style="max-width:520px;">
        <button type="button" class="modal__close" data-close-modal>&times;</button>
        <h2 style="margin:0; font-size:22px;">门店管理</h2>
        <form method="post" action="{{ url_for('create_store_route') }}" class="inventory-form">
          <label>新增门店名称<input name="name" placeholder="例如：旗舰店" required /></label>
          <div class="actions" style="justify-content:flex-end;">
            <button type="submit" class="btn btn--primary">新增门店</button>
          </div>
        </form>
        <div class="panel__meta">现有门店</div>
        <div class="timeline-list">
          {% for store_id, store in stores.items() %}
            <div class="timeline-item" style="gap:10px;">
              <div style="font-weight:600;">{{ store.name }}</div>
              <div class="panel__meta">SKU 数量：{{ store.items_count }}</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                <form method="post" action="{{ url_for('delete_store_route', store_id=store_id) }}" onsubmit="return confirm('确认删除 {{ store.name }} 吗？');">
                  <button type="submit" class="btn btn--danger">删除</button>
                </form>
                <form method="post" action="{{ url_for('delete_store_route', store_id=store_id) }}" onsubmit="return confirm('确认删除 {{ store.name }} 并清空其库存吗？');">
                  <input type="hidden" name="cascade" value="1" />
                  <button type="submit" class="btn btn--danger">连同库存删除</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div id="categoryModal" class="modal hidden" data-modal>
      <div class="modal__dialog" style="max-width:520px;">
        <button type="button" class="modal__close" data-close-modal>&times;</button>
        <h2 style="margin:0; font-size:22px;">分类管理</h2>
        <form method="post" action="{{ url_for('create_category_route') }}" class="inventory-form" novalidate>
          <label>新增分类名称<input name="name" placeholder="例如：饮品" required /></label>
          <div class="actions" style="justify-content:flex-end;">
            <button type="submit" class="btn btn--primary">新增分类</button>
          </div>
        </form>
        <div class="panel__meta">现有分类</div>
        <div class="timeline-list" style="max-height:300px; overflow:auto;">
          {% for category_id, category in categories.items() %}
            <div class="timeline-item" style="gap:10px;">
              <div style="font-weight:600;">{{ category.name }}</div>
              <div class="panel__meta">ID：{{ category_id }}</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                {% if category_id != 'uncategorized' %}
                  <form method="post" action="{{ url_for('delete_category_route', category_id=category_id) }}" onsubmit="return confirm('确认删除分类 {{ category.name }} 吗？');">
                    <input type="hidden" name="store_id" value="{{ selected_store }}" />
                    <button type="submit" class="btn btn--danger">删除</button>
                  </form>
                  <form method="post" action="{{ url_for('delete_category_route', category_id=category_id) }}" onsubmit="return confirm('确认删除分类 {{ category.name }} 并清空其下所有 SKU 吗？');">
                    <input type="hidden" name="cascade" value="1" />
                    <input type="hidden" name="store_id" value="{{ selected_store }}" />
                    <button type="submit" class="btn btn--danger">连同库存删除</button>
                  </form>
                {% else %}
                  <span class="panel__meta">系统默认分类</span>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <div id="importPreviewModal" class="modal hidden" data-modal>
      <div class="modal__dialog" style="max-width:720px;">
        <button type="button" class="modal__close" id="importPreviewClose">&times;</button>
        <h2 style="margin:0; font-size:22px;">导入前检查</h2>
        <p class="panel__meta">请确认系统已正确识别即将导入的 SKU 数据。</p>
        <div class="import-preview__content">
          <div id="importPreviewStatus" class="panel__meta"></div>
          <div class="import-preview__table-wrapper">
            <table id="importPreviewTable"></table>
          </div>
          <div id="importPreviewSummary" class="panel__meta"></div>
        </div>
        <div class="actions" style="justify-content:flex-end;">
          <button type="button" class="btn btn--ghost" id="importPreviewCancel">取消</button>
          <button type="button" class="btn btn--primary" id="importPreviewConfirm" disabled>确认导入</button>
        </div>
      </div>
    </div>

    <form id="importForm" method="post" action="/import" enctype="multipart/form-data" class="hidden">
      <input type="file" id="importFile" name="file" accept=".xlsx,.xls,.csv" />
      <input type="hidden" id="importStoreId" name="store_id" value="{{ selected_store }}" />
    </form>

    <div id="toast" class="toast hidden">
      <div class="toast__body">操作已提交</div>
    </div>

    <script>
      const root = document.documentElement;
      const themeToggleBtn = document.getElementById('themeToggle');
      const getTheme = () => localStorage.getItem('theme');
      const setTheme = t => localStorage.setItem('theme', t);
      const syncThemeToggle = theme => {
        if (!themeToggleBtn) return;
        themeToggleBtn.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
        themeToggleBtn.dataset.theme = theme;
      };
      const applyTheme = theme => {
        root.classList.toggle('dark', theme === 'dark');
        syncThemeToggle(theme);
      };
      const initTheme = () => {
        const storedTheme = getTheme();
        if (storedTheme) {
          applyTheme(storedTheme);
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          applyTheme('dark');
        }
      };
      initTheme();
      syncThemeToggle(root.classList.contains('dark') ? 'dark' : 'light');
      themeToggleBtn?.addEventListener('click', () => {
        const nextTheme = root.classList.contains('dark') ? 'light' : 'dark';
        applyTheme(nextTheme);
        setTheme(nextTheme);
      });

      function openModal(selector){
        const modal = document.querySelector(selector);
        if(!modal) return;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }
      function closeModal(selector){
        const modal = document.querySelector(selector);
        if(!modal) return;
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
      const modalElements = document.querySelectorAll('[data-modal]');
      document.querySelectorAll('[data-open-modal]')?.forEach(btn => {
        const target = btn.getAttribute('data-open-modal');
        if(!target) return;
        btn.addEventListener('click', () => openModal(target));
      });
      document.querySelectorAll('[data-close-modal]')?.forEach(btn => {
        btn.addEventListener('click', () => {
          const modal = btn.closest('[data-modal]');
          if(modal?.id) closeModal(`#${modal.id}`);
        });
      });
      modalElements.forEach(modal => {
        modal.addEventListener('click', event => {
          if(event.target === modal) closeModal(`#${modal.id}`);
        });
      });

      (function setupManageModal(){
        const manageModal = document.getElementById('manageModal');
        if(!manageModal) return;
        const manageButtons = document.querySelectorAll('[data-manage]');
        if(!manageButtons.length) return;
        const nameInput = document.getElementById('manageName');
        const quantityInput = document.getElementById('manageQuantity');
        const unitInput = document.getElementById('manageUnit');
        const thresholdInput = document.getElementById('manageThreshold');
        const categorySelect = document.getElementById('manageCategory');
        const summary = document.getElementById('manageSummary');
        manageButtons.forEach(button => {
          button.addEventListener('click', () => {
            const name = button.getAttribute('data-name') || '';
            const unit = button.getAttribute('data-unit') || '';
            const quantity = button.getAttribute('data-quantity') || '';
            const threshold = button.getAttribute('data-threshold') || '';
            const category = button.getAttribute('data-category') || '';
            const categoryName = button.getAttribute('data-category-name') || '未分类';
            if(nameInput) {
              nameInput.value = name;
            }
            if(quantityInput) {
              quantityInput.value = quantity;
              const placeholderUnit = unit ? ` ${unit}` : '';
              quantityInput.placeholder = quantity
                ? `当前 ${quantity}${placeholderUnit}`
                : '请输入数量';
            }
            if(unitInput) {
              unitInput.value = unit;
            }
            if(thresholdInput) {
              thresholdInput.value = threshold;
            }
            if(categorySelect) {
              let matched = false;
              Array.from(categorySelect.options).forEach(option => {
                if(option.value === category) {
                  option.selected = true;
                  matched = true;
                }
              });
              if(!matched && categorySelect.options.length) {
                categorySelect.selectedIndex = 0;
              }
            }
            if(summary) {
              const unitSuffix = unit ? ` ${unit}` : '';
              const quantityText = quantity !== '' ? quantity : '0';
              summary.textContent = `${name} · 当前库存 ${quantityText}${unitSuffix} · 分类：${categoryName}`;
            }
            openModal('#manageModal');
            setTimeout(() => {
              quantityInput?.focus();
            }, 120);
          });
        });
      })();

      (function setupAdjustModal(){
        const adjustModal = document.getElementById('adjustModal');
        const adjustButtons = document.querySelectorAll('[data-adjust]');
        const adjustActionInput = document.getElementById('adjustAction');
        const adjustNameInput = document.getElementById('adjustName');
        const adjustQuantityInput = document.getElementById('adjustQuantity');
        const adjustTimeInput = document.getElementById('adjustTime');
        const adjustInfo = document.getElementById('adjustModalInfo');
        const adjustTitle = document.getElementById('adjustModalTitle');
        const adjustQuantityLabel = document.getElementById('adjustQuantityLabel');
        const adjustQuantityLabelText = document.getElementById('adjustQuantityLabelText');
        const adjustTimeLabelText = document.getElementById('adjustTimeLabelText');
        const adjustSubmitBtn = document.getElementById('adjustSubmitBtn');
        if(!adjustModal || !adjustButtons.length || !adjustActionInput || !adjustNameInput || !adjustQuantityInput || !adjustTimeInput || !adjustInfo || !adjustTitle || !adjustQuantityLabel || !adjustQuantityLabelText || !adjustTimeLabelText || !adjustSubmitBtn){
          return;
        }
        const toDatetimeLocalValue = (date) => {
          const pad = (value) => String(value).padStart(2, '0');
          const year = date.getFullYear();
          const month = pad(date.getMonth() + 1);
          const day = pad(date.getDate());
          const hours = pad(date.getHours());
          const minutes = pad(date.getMinutes());
          return `${year}-${month}-${day}T${hours}:${minutes}`;
        };
        adjustButtons.forEach(button => {
          button.addEventListener('click', () => {
            const action = button.getAttribute('data-adjust') || 'in';
            const name = button.getAttribute('data-name') || '';
            const unit = button.getAttribute('data-unit') || '';
            const current = Number(button.getAttribute('data-current') || '0');
            const isOut = action === 'out';
            adjustActionInput.value = action;
            adjustNameInput.value = name;
            adjustQuantityInput.value = '';
            adjustQuantityInput.min = 1;
            adjustTimeInput.value = toDatetimeLocalValue(new Date());
            if(isOut && current > 0){
              adjustQuantityInput.setAttribute('max', String(current));
            } else {
              adjustQuantityInput.removeAttribute('max');
            }
            const disable = isOut && current === 0;
            adjustQuantityInput.disabled = disable;
            adjustSubmitBtn.disabled = disable;
            adjustQuantityInput.placeholder = isOut ? '请输入出库数量' : '请输入入库数量';
            adjustTitle.textContent = isOut ? '出库' : '入库';
            adjustQuantityLabelText.textContent = isOut ? '出库数量' : '入库数量';
            adjustTimeLabelText.textContent = isOut ? '出库时间' : '入库时间';
            adjustSubmitBtn.textContent = isOut ? '确认出库' : '确认入库';
            const unitSuffix = unit ? ' ' + unit : '';
            let infoText = `${name} · 当前库存 ${current}${unitSuffix}`;
            if(disable){
              infoText += ' · 当前库存不足以出库';
            }
            adjustInfo.textContent = infoText;
            openModal('#adjustModal');
            setTimeout(() => {
              if(!adjustQuantityInput.disabled){
                adjustQuantityInput.focus();
              }
            }, 120);
          });
        });
      })();

      (function setupBatchAdjustModal(){
        const modal = document.getElementById('batchAdjustModal');
        if(!modal) return;
        const triggers = document.querySelectorAll('[data-batch-adjust-trigger]');
        const form = document.getElementById('batchAdjustForm');
        const nameInput = document.getElementById('batchAdjustName');
        const quantityInput = document.getElementById('batchAdjustQuantity');
        const addBtn = document.getElementById('batchAdjustAddBtn');
        const list = document.getElementById('batchAdjustList');
        const payloadInput = document.getElementById('batchAdjustPayload');
        const submitBtn = document.getElementById('batchAdjustSubmit');
        const storeInput = document.getElementById('batchAdjustStoreId');
        const storeSelect = document.querySelector('select[name="store_id"]');
        const modeInput = document.getElementById('batchAdjustMode');
        const modeButtons = modal.querySelectorAll('[data-batch-mode]');
        const errorBox = document.getElementById('batchAdjustError');
        const entries = [];
        let mode = 'out';

        const getModeLabel = () => (mode === 'in' ? '入库' : '出库');

        function syncStore(){
          if(storeInput){
            storeInput.value = storeSelect?.value || '';
          }
        }

        function hideError(){
          if(errorBox){
            errorBox.classList.add('hidden');
            errorBox.textContent = '';
          }
        }

        function showError(message){
          if(!errorBox) return;
          errorBox.textContent = message;
          errorBox.classList.remove('hidden');
        }

        function clearInputs(){
          if(nameInput){
            nameInput.value = '';
            nameInput.setCustomValidity('');
          }
          if(quantityInput){
            quantityInput.value = '';
            quantityInput.setCustomValidity('');
          }
        }

        function updatePayload(){
          if(payloadInput){
            payloadInput.value = JSON.stringify(entries.map(entry => ({
              name: entry.name,
              quantity: entry.quantity,
            })));
          }
          if(submitBtn){
            submitBtn.disabled = entries.length === 0;
          }
          if(modeInput){
            modeInput.value = mode;
          }
        }

        function renderList(){
          if(!list) return;
          list.innerHTML = '';
          if(!entries.length){
            const empty = document.createElement('div');
            empty.className = 'batch-adjust__empty';
            empty.textContent = '暂未添加任何记录';
            list.appendChild(empty);
            updatePayload();
            return;
          }
          entries.forEach((entry, index) => {
            const row = document.createElement('div');
            row.className = 'batch-adjust__item';
            if(entry.error){
              row.classList.add('batch-adjust__item--error');
            }
            const main = document.createElement('div');
            main.className = 'batch-adjust__item-main';
            const nameEl = document.createElement('div');
            nameEl.className = 'batch-adjust__item-name';
            nameEl.textContent = entry.name;
            const meta = document.createElement('div');
            meta.className = 'batch-adjust__item-meta';
            meta.textContent = `${getModeLabel()}数量：${entry.quantity}`;
            main.appendChild(nameEl);
            main.appendChild(meta);
            if(entry.error){
              const errorEl = document.createElement('div');
              errorEl.className = 'batch-adjust__item-error';
              errorEl.textContent = entry.error.message || '提交失败';
              main.appendChild(errorEl);
            }
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'btn btn--ghost batch-adjust__remove';
            removeBtn.textContent = '移除';
            removeBtn.addEventListener('click', () => {
              entries.splice(index, 1);
              renderList();
            });
            row.appendChild(main);
            row.appendChild(removeBtn);
            list.appendChild(row);
          });
          updatePayload();
        }

        function setMode(nextMode){
          const normalized = nextMode === 'in' ? 'in' : 'out';
          if(mode === normalized){
            return;
          }
          mode = normalized;
          entries.splice(0, entries.length);
          hideError();
          clearInputs();
          modeButtons.forEach(btn => {
            const target = btn.getAttribute('data-batch-mode');
            btn.classList.toggle('active', target === mode);
          });
          if(submitBtn){
            submitBtn.textContent = `确认${getModeLabel()}`;
          }
          if(addBtn){
            addBtn.textContent = `添加到${getModeLabel()}列表`;
          }
          renderList();
        }

        function resetMode(){
          mode = 'out';
          modeButtons.forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-batch-mode') === mode);
          });
          if(submitBtn){
            submitBtn.textContent = `确认${getModeLabel()}`;
            submitBtn.disabled = true;
          }
          if(addBtn){
            addBtn.textContent = `添加到${getModeLabel()}列表`;
          }
          if(modeInput){
            modeInput.value = mode;
          }
        }

        function resetEntries(){
          entries.splice(0, entries.length);
          clearInputs();
          renderList();
        }

        function resetModal(){
          resetMode();
          resetEntries();
          hideError();
          syncStore();
        }

        function handleAdd(){
          if(!nameInput || !quantityInput){
            return;
          }
          const name = nameInput.value.trim();
          if(!name){
            nameInput.setCustomValidity('请输入 SKU 名称');
            nameInput.reportValidity();
            return;
          }
          nameInput.setCustomValidity('');
          const parsedQuantity = parseInt(quantityInput.value, 10);
          if(!Number.isFinite(parsedQuantity) || parsedQuantity <= 0){
            quantityInput.setCustomValidity('请输入大于 0 的数量');
            quantityInput.reportValidity();
            return;
          }
          quantityInput.setCustomValidity('');
          const existing = entries.find(entry => entry.name === name);
          if(existing){
            existing.quantity += parsedQuantity;
            existing.error = undefined;
          } else {
            entries.push({ name, quantity: parsedQuantity });
          }
          clearInputs();
          hideError();
          renderList();
          nameInput.focus();
        }

        async function submitEntries(event){
          event.preventDefault();
          if(!entries.length){
            showError('请先添加至少一条记录');
            return;
          }
          updatePayload();
          hideError();
          entries.forEach(entry => {
            entry.error = undefined;
          });
          renderList();
          if(submitBtn){
            submitBtn.disabled = true;
            submitBtn.textContent = `${getModeLabel()}中…`;
          }
          let completed = false;
          try{
            const response = await fetch('/api/batch-adjust', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
              },
              body: JSON.stringify({
                mode,
                store_id: storeInput?.value || '',
                entries: entries.map(entry => ({
                  name: entry.name,
                  quantity: entry.quantity,
                })),
              }),
            });
            const result = await response.json().catch(() => null);
            const errorList = Array.isArray(result?.errors) ? result.errors : [];
            if(!response.ok || !result || result.success !== true){
              if(errorList.length){
                const messages = [];
                errorList.forEach(error => {
                  const target = entries.find(entry => entry.name === error.name);
                  if(target){
                    target.error = error;
                  }
                  if(error.message){
                    messages.push(error.name ? `${error.name}：${error.message}` : error.message);
                  }
                });
                renderList();
                showError(messages.join('；') || result?.error || '部分记录未通过校验');
              } else {
                showError(result?.error || '批量操作提交失败，请稍后重试。');
              }
              return;
            }
            if(submitBtn){
              submitBtn.textContent = '操作完成';
            }
            completed = true;
            setTimeout(() => {
              window.location.reload();
            }, 500);
          } catch(err){
            console.error(err);
            showError('批量操作提交失败，请检查网络后重试。');
          } finally {
            if(submitBtn && !completed){
              submitBtn.disabled = entries.length === 0;
              submitBtn.textContent = `确认${getModeLabel()}`;
            }
          }
        }

        triggers.forEach(trigger => {
          trigger.addEventListener('click', () => {
            resetModal();
            setTimeout(() => nameInput?.focus(), 120);
          });
        });

        modeButtons.forEach(button => {
          button.addEventListener('click', () => {
            const targetMode = button.getAttribute('data-batch-mode');
            setMode(targetMode);
          });
        });

        addBtn?.addEventListener('click', handleAdd);
        nameInput?.addEventListener('keydown', event => {
          if(event.key === 'Enter'){
            event.preventDefault();
            handleAdd();
          }
        });
        quantityInput?.addEventListener('keydown', event => {
          if(event.key === 'Enter'){
            event.preventDefault();
            handleAdd();
          }
        });
        nameInput?.addEventListener('input', () => nameInput.setCustomValidity(''));
        quantityInput?.addEventListener('input', () => quantityInput.setCustomValidity(''));
        storeSelect?.addEventListener('change', syncStore);
        modal.querySelectorAll('[data-close-modal]').forEach(button => {
          button.addEventListener('click', () => {
            resetModal();
          });
        });
        modal.addEventListener('click', event => {
          if(event.target === modal){
            resetModal();
          }
        });
        form?.addEventListener('submit', submitEntries);

        resetModal();
        syncStore();
      })();

      (function setupTransferModal(){
        const transferModal = document.getElementById('transferModal');
        if(!transferModal) return;
        const transferButtons = document.querySelectorAll('[data-transfer]');
        if(!transferButtons.length) return;
        const transferNameInput = document.getElementById('transferName');
        const transferSourceInput = document.getElementById('transferSourceStore');
        const transferTargetSelect = document.getElementById('transferTargetStore');
        const transferQuantityInput = document.getElementById('transferQuantity');
        const transferInfo = document.getElementById('transferInfo');
        const transferSubmitBtn = document.getElementById('transferSubmitBtn');
        transferButtons.forEach(button => {
          button.addEventListener('click', () => {
            const name = button.getAttribute('data-name') || '';
            const unit = button.getAttribute('data-unit') || '';
            const current = Number(button.getAttribute('data-current') || '0');
            const storeId = button.getAttribute('data-store') || '';
            const storeName = button.getAttribute('data-store-name') || '';
            transferNameInput.value = name;
            transferSourceInput.value = storeId;
            let firstAvailable = null;
            Array.from(transferTargetSelect.options).forEach(option => {
              const isSame = option.value === storeId;
              option.disabled = isSame;
              if(isSame && option.selected){
                option.selected = false;
              }
              if(!isSame && !firstAvailable){
                firstAvailable = option;
              }
            });
            if((!transferTargetSelect.value || transferTargetSelect.options[transferTargetSelect.selectedIndex]?.disabled) && firstAvailable){
              firstAvailable.selected = true;
            }
            transferQuantityInput.value = '';
            const unitSuffix = unit ? ` ${unit}` : '';
            let infoText = `${name} · 当前库存 ${current}${unitSuffix}`;
            if(storeName){
              infoText += ` · 调出门店：${storeName}`;
            }
            if(current > 0){
              transferQuantityInput.max = String(current);
              transferQuantityInput.disabled = false;
              transferSubmitBtn.disabled = false;
              transferQuantityInput.placeholder = `最多可调拨 ${current}${unitSuffix}`.trim();
            } else {
              transferQuantityInput.removeAttribute('max');
              transferQuantityInput.disabled = true;
              transferSubmitBtn.disabled = true;
              transferQuantityInput.placeholder = '当前库存不足，无法调拨';
            }
            transferInfo.textContent = infoText;
            openModal('#transferModal');
            setTimeout(() => {
              if(!transferQuantityInput.disabled){
                transferQuantityInput.focus();
              }
            }, 120);
          });
        });
      })();

      const toast = document.getElementById('toast');
      let toastTimer = null;
      function showToast(){
        if(!toast) return;
        toast.classList.remove('hidden');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          toast.classList.add('hidden');
        }, 2400);
      }

      const fileInput = document.getElementById('importFile');
      const importForm = document.getElementById('importForm');
      const importStoreInput = document.getElementById('importStoreId');
      const importPreviewModal = document.getElementById('importPreviewModal');
      const importPreviewStatus = document.getElementById('importPreviewStatus');
      const importPreviewTable = document.getElementById('importPreviewTable');
      const importPreviewSummary = document.getElementById('importPreviewSummary');
      const importPreviewConfirm = document.getElementById('importPreviewConfirm');
      const importPreviewCancel = document.getElementById('importPreviewCancel');
      const importPreviewClose = document.getElementById('importPreviewClose');
      const importTriggers = [document.getElementById('importTrigger'), document.getElementById('importTriggerM')].filter(Boolean);
      let pendingImportFile = null;

      function renderPreviewRows(rows, options = {}){
        if(!importPreviewTable) return;
        const escapeHtml = (value) => String(value ?? '').replace(/[&<>"']/g, (match) => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
        })[match]);
        const formatDisplay = (value, emptyLabel = '未填写') => {
          const text = value === undefined || value === null ? '' : String(value);
          if(text.trim() === ''){
            return `<span class="import-preview__muted">${escapeHtml(emptyLabel)}</span>`;
          }
          return escapeHtml(text);
        };
        const toNumber = (value) => {
          if(typeof value === 'number' && !Number.isNaN(value)){
            return value;
          }
          if(typeof value === 'string'){
            const trimmed = value.trim();
            if(trimmed !== ''){
              const parsed = Number(trimmed);
              if(!Number.isNaN(parsed)){
                return parsed;
              }
            }
          }
          return null;
        };
        const emptyText = options.emptyText || '暂无可预览数据';
        if(!rows.length){
          importPreviewTable.innerHTML = `<tbody><tr><td class="import-preview__empty" colspan="5">${escapeHtml(emptyText)}</td></tr></tbody>`;
          if(importPreviewSummary){
            importPreviewSummary.innerHTML = '';
          }
          if(importPreviewConfirm){
            importPreviewConfirm.disabled = true;
          }
          return;
        }
        const headers = ['SKU / 来源行', '数量调整', '单位', '分类', '识别结果'];
        const stats = { total: rows.length, valid: 0, new: 0, update: 0, unchanged: 0, invalid: 0 };
        const body = rows.map(row => {
          const valid = Boolean(row && row.valid);
          const existing = Boolean(row && row.existing);
          if(valid){
            stats.valid += 1;
          } else {
            stats.invalid += 1;
          }
          const rowClasses = ['import-preview__row'];
          const quantityValue = toNumber(row?.quantity);
          const previousQuantity = toNumber(row?.existing_quantity);
          const deltaValue = toNumber(row?.quantity_delta);
          const unit = row?.unit ?? '';
          const previousUnit = row?.existing_unit ?? '';
          const categoryName = row?.category_name ?? '';
          const previousCategoryName = row?.existing_category_name ?? '';
          const quantityChanged = Boolean(
            row?.quantity_changed ?? (
              existing && quantityValue !== null && previousQuantity !== null && quantityValue !== previousQuantity
            )
          );
          const unitChanged = Boolean(
            row?.unit_changed ?? (existing && (unit || '') !== (previousUnit || ''))
          );
          const categoryChanged = Boolean(
            row?.category_changed ?? (
              existing && (row?.existing_category_id ?? '') !== (row?.category_id ?? '')
            )
          );
          if(!valid){
            rowClasses.push('is-invalid');
          } else if(!existing){
            rowClasses.push('is-new');
            stats.new += 1;
          } else if(quantityChanged || unitChanged || categoryChanged){
            rowClasses.push('is-updated');
            stats.update += 1;
          } else {
            stats.unchanged += 1;
          }
          const indexLabel = row?.index ? `第 ${row.index} 行` : '';
          const nameHtml = row?.name
            ? `<div class="import-preview__name">${escapeHtml(row.name)}</div>`
            : `<div class="import-preview__name import-preview__name--missing">（未填写名称）</div>`;
          const metaParts = [];
          if(indexLabel){
            metaParts.push(indexLabel);
          }
          if(existing){
            metaParts.push('已匹配库存');
          } else if(valid){
            metaParts.push('将创建新库存');
          }
          if(!valid){
            metaParts.push('存在错误');
          }
          const metaHtml = metaParts.length ? `<div class="import-preview__meta">${metaParts.join(' · ')}</div>` : '';
          const quantityCell = (() => {
            if(!valid || quantityValue === null){
              return '<span class="import-preview__muted">—</span>';
            }
            if(!existing){
              const deltaBadge = `<span class="chip success">+${escapeHtml(quantityValue)}</span>`;
              return `<div class="import-preview__value">${escapeHtml(quantityValue)}</div>${deltaBadge}<span class="import-preview__muted">新建库存</span>`;
            }
            const prevText = previousQuantity === null ? escapeHtml('—') : escapeHtml(previousQuantity);
            const nextText = escapeHtml(quantityValue);
            const effectiveDelta = deltaValue !== null
              ? deltaValue
              : (previousQuantity !== null && quantityValue !== null ? quantityValue - previousQuantity : null);
            let deltaBadge = '';
            if(effectiveDelta !== null){
              if(effectiveDelta > 0){
                deltaBadge = `<span class="chip success">+${escapeHtml(effectiveDelta)}</span>`;
              } else if(effectiveDelta < 0){
                deltaBadge = `<span class="chip danger">${escapeHtml(effectiveDelta)}</span>`;
              } else {
                deltaBadge = '<span class="chip neutral">无变化</span>';
              }
            } else if(!quantityChanged){
              deltaBadge = '<span class="chip neutral">无变化</span>';
            }
            const arrow = '<span class="import-preview__arrow">→</span>';
            if(previousQuantity === null){
              return `<div class="import-preview__value">${nextText}</div>${deltaBadge}`;
            }
            return `<div class="import-preview__value">${prevText} ${arrow} ${nextText}</div>${deltaBadge}`;
          })();
          const unitCell = (() => {
            if(!valid){
              return '<span class="import-preview__muted">—</span>';
            }
            if(!existing){
              return `<div class="import-preview__value">${formatDisplay(unit, '未填写')}</div><span class="import-preview__muted">新建设置</span>`;
            }
            if(unitChanged){
              return `<div class="import-preview__value">${formatDisplay(previousUnit, '未设置')} <span class="import-preview__arrow">→</span> ${formatDisplay(unit, '未填写')}</div><span class="chip warning">单位变更</span>`;
            }
            return `<div class="import-preview__value">${formatDisplay(unit, '未填写')}</div>`;
          })();
          const categoryCell = (() => {
            if(!valid){
              return '<span class="import-preview__muted">—</span>';
            }
            const nextLabel = categoryName || '未分类';
            const prevLabel = previousCategoryName || (existing ? '未分类' : '');
            if(!existing){
              return `<div class="import-preview__value">${formatDisplay(nextLabel, '未分类')}</div><span class="import-preview__muted">新建设置</span>`;
            }
            if(categoryChanged){
              return `<div class="import-preview__value">${formatDisplay(prevLabel, '未分类')} <span class="import-preview__arrow">→</span> ${formatDisplay(nextLabel, '未分类')}</div><span class="chip accent">分类变更</span>`;
            }
            return `<div class="import-preview__value">${formatDisplay(nextLabel, '未分类')}</div>`;
          })();
          const changeParts = [];
          if(quantityChanged){
            changeParts.push('数量');
          }
          if(unitChanged){
            changeParts.push('单位');
          }
          if(categoryChanged){
            changeParts.push('分类');
          }
          let statusBadge = '';
          if(!valid){
            statusBadge = '<span class="chip danger">无法导入</span>';
          } else if(!existing){
            statusBadge = '<span class="chip success">新增</span>';
          } else if(quantityChanged || unitChanged || categoryChanged){
            statusBadge = '<span class="chip accent">待更新</span>';
          } else {
            statusBadge = '<span class="chip neutral">保持不变</span>';
          }
          const changeMeta = changeParts.length ? `<div class="import-preview__meta">变更字段：${changeParts.join('、')}</div>` : '';
          const messages = Array.isArray(row?.messages) ? row.messages.filter(message => message) : [];
          const messageHtml = messages.length
            ? `<div class="import-preview__messages">${messages.map(message => `<div class="import-preview__message">${escapeHtml(message)}</div>`).join('')}</div>`
            : '';
          const statusPieces = [statusBadge];
          if(changeMeta){
            statusPieces.push(changeMeta);
          }
          if(messageHtml){
            statusPieces.push(messageHtml);
          }
          const statusCell = `<div class="import-preview__status">${statusPieces.join('')}</div>`;
          return `<tr class="${rowClasses.join(' ')}"><td>${nameHtml}${metaHtml}</td><td>${quantityCell}</td><td>${unitCell}</td><td>${categoryCell}</td><td>${statusCell}</td></tr>`;
        }).join('');
        importPreviewTable.innerHTML = `<thead><tr>${headers.map(title => `<th>${title}</th>`).join('')}</tr></thead><tbody>${body}</tbody>`;
        if(importPreviewSummary){
          const summaryParts = [
            `识别 ${stats.total} 行`,
            `有效 ${stats.valid} 行`,
          ];
          if(stats.new){
            summaryParts.push(`新增 ${stats.new}`);
          }
          if(stats.update){
            summaryParts.push(`更新 ${stats.update}`);
          }
          if(stats.unchanged){
            summaryParts.push(`保持 ${stats.unchanged}`);
          }
          if(stats.invalid){
            summaryParts.push(`异常 ${stats.invalid}`);
          }
          const summaryLine = summaryParts.join(' · ');
          const hint = stats.invalid ? '<div class="import-preview__hint">红色行将被跳过，请修正后重新导入。</div>' : '';
          importPreviewSummary.innerHTML = `<div class="import-preview__summary-line">${summaryLine}</div>${hint}`;
        }
        if(importPreviewConfirm){
          importPreviewConfirm.disabled = stats.valid === 0;
        }
      }

      function setPreviewStatus(message, variant){
        if(!importPreviewStatus) return;
        importPreviewStatus.textContent = message;
        importPreviewStatus.style.color = variant === 'error' ? '#ef4444' : 'var(--muted)';
      }

      function currentStoreId(){
        return importStoreInput?.value || document.querySelector('select[name="store_id"]')?.value || '';
      }

      function syncImportStore(){
        if(!importStoreInput) return;
        importStoreInput.value = currentStoreId();
      }

      function resetImportPreview(){
        if(!importPreviewModal) return;
        closeModal('#importPreviewModal');
        setPreviewStatus('');
        if(importPreviewSummary){
          importPreviewSummary.innerHTML = '';
        }
        renderPreviewRows([], { emptyText: '等待选择文件…' });
        if(importPreviewConfirm){
          importPreviewConfirm.disabled = true;
          importPreviewConfirm.textContent = '确认导入';
        }
        pendingImportFile = null;
        if(fileInput){
          fileInput.value = '';
        }
      }

      syncImportStore();
      const storeSelect = document.querySelector('select[name="store_id"]');
      storeSelect?.addEventListener('change', syncImportStore);
      importPreviewCancel?.addEventListener('click', () => resetImportPreview());
      importPreviewClose?.addEventListener('click', () => resetImportPreview());
      importPreviewModal?.addEventListener('click', event => {
        if(event.target === importPreviewModal){
          resetImportPreview();
        }
      });

      importTriggers.forEach(trigger => {
        trigger.addEventListener('click', () => {
          if(!fileInput){
            return;
          }
          resetImportPreview();
          syncImportStore();
          fileInput.click();
        });
      });

      fileInput?.addEventListener('change', async () => {
        if(!fileInput.files?.length || !importForm){
          return;
        }
        const file = fileInput.files[0];
        pendingImportFile = null;
        syncImportStore();
        openModal('#importPreviewModal');
        setPreviewStatus('正在分析导入文件，请稍候…');
        if(importPreviewSummary){
          importPreviewSummary.innerHTML = '';
        }
        if(importPreviewConfirm){
          importPreviewConfirm.disabled = true;
          importPreviewConfirm.textContent = '确认导入';
        }
        renderPreviewRows([], { emptyText: '正在分析导入文件…' });
        try {
          const formData = new FormData();
          formData.append('file', file);
          const storeId = currentStoreId();
          if(storeId){
            formData.append('store_id', storeId);
          }
          const response = await fetch('/api/items/import/preview', {
            method: 'POST',
            body: formData,
          });
          let data = null;
          try {
            data = await response.json();
          } catch (err) {
            data = null;
          }
          if(!response.ok){
            const message = data && data.error ? data.error : '导入前检查失败';
            throw new Error(message);
          }
          pendingImportFile = file;
          renderPreviewRows(data?.rows || [], { meta: data });
          setPreviewStatus('检查完成，请确认识别结果后继续导入。');
        } catch (error) {
          pendingImportFile = null;
          const message = error instanceof Error ? error.message : '导入前检查失败';
          setPreviewStatus(message, 'error');
          renderPreviewRows([], { emptyText: '未识别到可导入的数据' });
        }
      });

      importPreviewConfirm?.addEventListener('click', () => {
        if(!importPreviewConfirm || importPreviewConfirm.disabled){
          return;
        }
        if(!fileInput?.files?.length || !importForm || !pendingImportFile){
          return;
        }
        setPreviewStatus('正在导入，请稍候…');
        importPreviewConfirm.disabled = true;
        importPreviewConfirm.textContent = '正在导入…';
        syncImportStore();
        if(typeof importForm.requestSubmit === 'function'){
          importForm.requestSubmit();
        } else {
          importForm.submit();
        }
      });

      const menuPairs = [
        { button: document.getElementById('actionsMenuBtn'), menu: document.getElementById('actionsMenu') },
        { button: document.getElementById('userMenuBtn'), menu: document.getElementById('userMenu') }
      ].filter(pair => pair.button && pair.menu);
      function closeMenus(){
        menuPairs.forEach(({ button, menu }) => {
          menu.classList.add('hidden');
          button.setAttribute('aria-expanded', 'false');
        });
      }
      menuPairs.forEach(({ button, menu }) => {
        button.addEventListener('click', (event) => {
          event.stopPropagation();
          const expanded = button.getAttribute('aria-expanded') === 'true';
          closeMenus();
          if(!expanded){
            menu.classList.remove('hidden');
            button.setAttribute('aria-expanded', 'true');
          }
        });
      });
      document.addEventListener('click', closeMenus);
      document.addEventListener('keydown', (event) => {
        if(event.key === 'Escape') closeMenus();
      });

      const thresholdAlert = document.getElementById('thresholdAlert');
      thresholdAlert?.querySelectorAll('[data-close-alert]')?.forEach(el => {
        el.addEventListener('click', () => {
          thresholdAlert.classList.add('hidden');
        });
      });

      const keywordInputs = document.querySelectorAll('[data-keyword-input]');
      function submitKeyword(value){
        const trimmed = value.trim();
        const url = new URL(window.location.href);
        const currentSearch = url.searchParams.get('inventory_search') || '';
        if(trimmed){
          url.searchParams.set('inventory_search', trimmed);
        } else {
          url.searchParams.delete('inventory_search');
        }
        if(trimmed !== currentSearch){
          url.searchParams.set('inventory_page', '1');
        }
        window.location.href = url.toString();
      }
      keywordInputs.forEach(input => {
        input.addEventListener('keydown', event => {
          if(event.key === 'Enter'){
            event.preventDefault();
            submitKeyword(input.value || '');
          }
        });
      });
      document.querySelectorAll('[data-search-button]').forEach(button => {
        const selector = button.getAttribute('data-input-selector');
        button.addEventListener('click', () => {
          const input = selector ? document.querySelector(selector) : null;
          submitKeyword(input?.value || '');
        });
      });

      const categoryFilters = document.querySelectorAll('[data-category-filter]');
      categoryFilters.forEach(select => {
        select.addEventListener('change', () => {
          const url = new URL(window.location.href);
          const value = select.value;
          if(value){
            url.searchParams.set('category', value);
          } else {
            url.searchParams.delete('category');
          }
          url.searchParams.set('inventory_page', '1');
          window.location.href = url.toString();
        });
      });

      const importFormElement = document.getElementById('importForm');
      importFormElement?.addEventListener('submit', () => {
        setTimeout(() => {
          showToast();
        }, 200);
      });
    </script>
  </body>
</html>
