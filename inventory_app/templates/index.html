<!doctype html>
<html lang="zh" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>库存控制中心</title>

    <!-- Tailwind (CDN build) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: ['class'],
        theme: {
          extend: {
            fontFamily: {
              sans: ['ui-sans-serif','-apple-system','BlinkMacSystemFont','Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft Yahei','Helvetica Neue','Arial','Noto Sans CJK SC','sans-serif']
            },
            colors: {
              brand: {
                50: '#F4F6FF',
                100: '#E9EDFF',
                200: '#C7D0FF',
                300: '#A4B4FF',
                400: '#8097FF',
                500: '#5D7BFF',
                600: '#3A5EFF',
                700: '#2447E6',
                800: '#1B34B0',
                900: '#14257F'
              }
            },
            boxShadow: {
              xlsoft: '0 25px 80px rgba(15, 23, 42, .16)',
              innerlg: 'inset 0 1px 0 rgba(255,255,255,.06), inset 0 -1px 0 rgba(0,0,0,.15)'
            },
            backdropBlur: { 12: '12px' },
            keyframes: {
              in: { '0%':{opacity:0,transform:'translateY(8px)'}, '100%':{opacity:1,transform:'translateY(0)'} },
              pingy: { '0%,100%':{transform:'translateY(0)'}, '50%':{transform:'translateY(-2px)'} }
            },
            animation: {
              in: 'in .45s cubic-bezier(.22,.61,.36,1) both',
              pingy: 'pingy 2s ease-in-out infinite'
            }
          }
        }
      }
    </script>

    <style>
      :root { color-scheme: light dark; }
      html, body { height: 100%; }
      .glass { backdrop-filter: blur(12px) saturate(1.15); -webkit-backdrop-filter: blur(12px) saturate(1.15); background: color-mix(in oklab, var(--tw-bg-opacity,1) 0%, transparent 0%); }
      .surface {
        background: radial-gradient(120% 120% at 0% 0%, rgba(93,123,255,.15) 0%, transparent 50%),
                    radial-gradient(120% 120% at 100% 0%, rgba(36,71,230,.14) 0%, transparent 52%),
                    linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.35));
      }
      .surface-dark {
        background: radial-gradient(120% 120% at 0% 0%, rgba(93,123,255,.14) 0%, transparent 50%),
                    radial-gradient(120% 120% at 100% 0%, rgba(36,71,230,.12) 0%, transparent 52%),
                    linear-gradient(180deg, rgba(20,24,40,.65), rgba(20,24,40,.45));
      }
      .switcher::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; height: 18px; width: 18px; border-radius: 9999px; background: white; border: 3px solid #5D7BFF; box-shadow: 0 6px 18px rgba(93,123,255,.45); }
      .switcher { accent-color: #5D7BFF; }
      .desktop-nav { display: none !important; }
      .mobile-nav { display: block; }
      @media (min-width: 768px) {
        .desktop-nav { display: flex !important; }
        .mobile-nav { display: none !important; }
      }
    </style>
  </head>

  <body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 font-sans antialiased selection:bg-brand-200/60 selection:text-slate-900">
    <!-- Top Bar -->
    <header class="sticky top-0 z-40 supports-[backdrop-filter]:backdrop-blur-12 border-b border-slate-200/60 dark:border-white/5 bg-white/80 dark:bg-slate-900/70">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center gap-4">
        <a href="#" class="flex items-center gap-2 font-semibold tracking-tight group min-w-0" aria-label="返回首页">
          <svg class="w-5 h-5 text-brand-600 group-hover:animate-pingy shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/></svg>
          <span class="truncate">库存控制中心</span>
        </a>
        <div class="desktop-nav flex-1 items-center gap-4 min-w-0">
          <div class="flex items-center gap-2 shrink-0">
            <form method="post" action="{{ url_for('select_store') }}" class="h-10">
              <select name="store_id" class="h-10 rounded-xl border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 text-sm" onchange="this.form.submit()">
                {% for store_id, store in stores.items() %}
                  <option value="{{ store_id }}" {% if store_id == selected_store %}selected{% endif %}>{{ store.name }}{% if store.items_count %}（{{ store.items_count }}）{% endif %}</option>
                {% endfor %}
              </select>
            </form>
            {% if permissions.can_manage_stores %}
              <button class="h-10 px-3 rounded-xl border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5 text-sm" data-open-modal="#storeModal">门店管理</button>
            {% endif %}
          </div>
          <div class="flex items-center gap-2 flex-1 min-w-[180px] max-w-md">
            <div class="relative flex-1">
              <input id="keyword" data-keyword-input type="search" placeholder="搜索 SKU 名称" value="{{ inventory_search }}" class="peer h-10 w-full rounded-xl bg-slate-100/70 dark:bg-white/5 border border-slate-200/60 dark:border-white/10 pl-9 pr-3 text-sm focus:outline-none focus:ring-4 ring-brand-500/20 focus:border-brand-500/60 transition">
              <svg class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 peer-focus:text-brand-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            </div>
            <button type="button" data-search-button data-input-selector="#keyword" class="h-10 px-4 rounded-xl bg-brand-600 text-white text-sm font-medium hover:brightness-105 transition">搜索</button>
          </div>
          <div class="flex items-center gap-2 shrink-0">
            <select id="categoryFilter" data-category-filter class="h-10 rounded-xl border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 text-sm">
              <option value="">全部分类</option>
              {% for category_id, category in categories.items() %}
                <option value="{{ category_id }}" {% if category_id == selected_category %}selected{% endif %}>{{ category.name }}</option>
              {% endfor %}
            </select>
            {% if permissions.can_manage_categories %}
              <button class="h-10 px-3 rounded-xl border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5 text-sm" data-open-modal="#categoryModal">分类管理</button>
            {% endif %}
          </div>
          <div class="flex items-center gap-2 ml-auto shrink-0">
            {% if permissions.can_manage_items %}
              <div class="relative">
                <button id="actionsMenuBtn" class="h-10 px-3 rounded-xl border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5 text-sm inline-flex items-center gap-1" aria-haspopup="menu" aria-expanded="false">
                  快捷操作
                  <svg class="w-3.5 h-3.5 opacity-70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
                </button>
                <div id="actionsMenu" class="hidden absolute right-0 mt-2 w-48 rounded-xl border border-slate-200/60 dark:border-white/10 bg-white dark:bg-slate-900 shadow-xlsoft p-1 text-sm z-50" role="menu" aria-labelledby="actionsMenuBtn">
                  <button type="button" class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100/70 dark:hover:bg-white/5" data-open-modal="#addModal" role="menuitem">新增 SKU</button>
                  <button type="button" id="importTrigger" class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100/70 dark:hover:bg-white/5" role="menuitem">从表格导入</button>
                  <a href="/api/items/export" class="block px-3 py-2 rounded-lg hover:bg-slate-100/70 dark:hover:bg-white/5" role="menuitem">导出库存表格</a>
                  <a href="/api/items/template" class="block px-3 py-2 rounded-lg hover:bg-slate-100/70 dark:hover:bg-white/5" role="menuitem">下载导入模板</a>
                </div>
              </div>
            {% endif %}
            <div class="relative">
              <button id="userMenuBtn" class="h-10 px-3 rounded-xl border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5 text-sm inline-flex items-center gap-2" aria-haspopup="menu" aria-expanded="false">
                <span class="truncate max-w-[7rem]">{{ current_user.username }}</span>
                <svg class="w-3.5 h-3.5 opacity-70" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg>
              </button>
              <div id="userMenu" class="hidden absolute right-0 mt-2 w-48 rounded-xl border border-slate-200/60 dark:border-white/10 bg-white dark:bg-slate-900 shadow-xlsoft text-sm z-50" role="menu" aria-labelledby="userMenuBtn">
                <div class="px-3 py-2 text-xs text-slate-500 dark:text-slate-300 border-b border-slate-200/60 dark:border-white/10">
                  {{ current_user.username }}
                  <span class="text-slate-400 dark:text-slate-500">· {{ role_labels.get(current_user.role, current_user.role) }}</span>
                </div>
                <div class="p-1 space-y-1">
                  {% if permissions.can_view_history %}
                    <a href="{{ url_for('analytics_dashboard') }}" class="block px-3 py-2 rounded-lg hover:bg-slate-100/70 dark:hover:bg-white/5" role="menuitem">出入库统计</a>
                  {% endif %}
                  {% if permissions.can_manage_users %}
                    <a href="{{ url_for('manage_users') }}" class="block px-3 py-2 rounded-lg hover:bg-slate-100/70 dark:hover:bg-white/5" role="menuitem">用户管理</a>
                  {% endif %}
                  <form method="post" action="{{ url_for('logout') }}">
                    <button type="submit" class="w-full text-left px-3 py-2 rounded-lg hover:bg-slate-100/70 dark:hover:bg-white/5" role="menuitem">退出登录</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
        <button id="themeToggle" type="button" class="ml-2 inline-flex items-center gap-2 rounded-full border border-slate-200/60 dark:border-white/10 bg-white/60 dark:bg-slate-900/60 px-2.5 py-1.5 text-xs font-medium text-slate-600 dark:text-slate-200 shadow-sm hover:bg-slate-100/80 dark:hover:bg-white/10 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500/50 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-50 dark:focus-visible:ring-offset-slate-900" aria-label="切换主题" aria-pressed="false">
          <span class="relative inline-flex h-6 w-12 items-center rounded-full bg-slate-200/70 dark:bg-slate-700/60 px-1 transition-colors">
            <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-white text-amber-500 shadow-sm transition-transform duration-300 ease-out translate-x-0 dark:translate-x-5">
              <svg class="w-3.5 h-3.5 dark:hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="4"/>
                <path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32 1.41 1.41M2 12h2m16 0h2m-3.66-7.07 1.41 1.41M4.93 19.07l1.41-1.41"/>
              </svg>
              <svg class="hidden w-3.5 h-3.5 text-sky-400 dark:block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
              </svg>
            </span>
          </span>
          <span class="theme-label hidden text-xs font-medium text-slate-600 dark:text-slate-200 sm:inline">深色模式</span>
        </button>
      </div>
      <div class="mobile-nav border-t border-slate-200/60 dark:border-white/10">
        <div class="max-w-7xl mx-auto px-4 py-2 flex flex-wrap items-center gap-2 text-sm">
          <form method="post" action="{{ url_for('select_store') }}" class="w-full flex items-center gap-2">
            <select name="store_id" class="flex-1 rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" onchange="this.form.submit()">
              {% for store_id, store in stores.items() %}
                <option value="{{ store_id }}" {% if store_id == selected_store %}selected{% endif %}>{{ store.name }}</option>
              {% endfor %}
            </select>
            {% if permissions.can_manage_stores %}
              <button type="button" class="px-3 py-2 rounded-lg border border-slate-200/60 dark:border-white/10" data-open-modal="#storeModal">管理</button>
            {% endif %}
          </form>
          <div class="w-full flex items-center gap-2">
            <div class="relative flex-1">
              <input id="keywordMobile" data-keyword-input type="search" placeholder="搜索 SKU 名称" value="{{ inventory_search }}" class="peer h-10 w-full rounded-lg bg-slate-100/70 dark:bg-white/5 border border-slate-200/60 dark:border-white/10 pl-9 pr-3 focus:outline-none focus:ring-4 ring-brand-500/20 focus:border-brand-500/60 transition">
              <svg class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 peer-focus:text-brand-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            </div>
            <button type="button" data-search-button data-input-selector="#keywordMobile" class="h-10 px-4 rounded-lg bg-brand-600 text-white font-medium">搜索</button>
          </div>
          <div class="w-full flex items-center gap-2">
            <select data-category-filter class="flex-1 rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2">
              <option value="">全部分类</option>
              {% for category_id, category in categories.items() %}
                <option value="{{ category_id }}" {% if category_id == selected_category %}selected{% endif %}>{{ category.name }}</option>
              {% endfor %}
            </select>
            {% if permissions.can_manage_categories %}
              <button type="button" class="px-3 py-2 rounded-lg border border-slate-200/60 dark:border-white/10" data-open-modal="#categoryModal">分类管理</button>
            {% endif %}
          </div>
          <div class="text-slate-600 dark:text-slate-300">
            {{ current_user.username }}
            <span class="text-slate-400 dark:text-slate-500">· {{ role_labels.get(current_user.role, current_user.role) }}</span>
          </div>
          {% if permissions.can_manage_users %}
            <a href="{{ url_for('manage_users') }}" class="px-3 py-1 rounded-lg border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5">用户管理</a>
          {% endif %}
          {% if permissions.can_view_history %}
            <a href="{{ url_for('analytics_dashboard') }}" class="px-3 py-1 rounded-lg border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5">出入库统计</a>
          {% endif %}
          <form method="post" action="{{ url_for('logout') }}">
            <button type="submit" class="px-3 py-1 rounded-lg border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5">退出</button>
          </form>
        </div>
      </div>
    </header>

    <!-- Hero KPIs -->
    <section class="relative">
      <div class="absolute inset-0 -z-10 opacity-90 dark:opacity-70">
        <div class="h-64 surface dark:hidden"></div>
        <div class="h-64 hidden dark:block surface-dark"></div>
      </div>
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 animate-in">
          <div class="col-span-1 lg:col-span-3 p-6 rounded-2xl shadow-xlsoft border border-white/40 dark:border-white/10 bg-white/60 dark:bg-slate-900/50 glass">
            <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6">
              <div>
                <span class="inline-flex items-center gap-2 text-xs px-2 py-1 rounded-full bg-white/70 dark:bg-white/10 border border-white/30 dark:border-white/5 text-slate-700 dark:text-slate-200">控制面板 <span class="opacity-60">实时把握库存动态</span></span>
                <h1 class="mt-2 text-3xl md:text-4xl font-bold tracking-tight">库存控制中心</h1>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 w-full lg:w-auto">
                <div class="p-4 rounded-xl bg-white/70 dark:bg-white/5 border border-white/40 dark:border-white/10">
                  <div class="text-xs text-slate-500">SKU 数量</div>
                  <div class="mt-1 text-2xl font-semibold">{{ summary.total_items }}</div>
                </div>
                <div class="p-4 rounded-xl bg-white/70 dark:bg-white/5 border border-white/40 dark:border-white/10">
                  <div class="text-xs text-slate-500">库存总数</div>
                  <div class="mt-1 text-2xl font-semibold">{{ summary.total_quantity }}</div>
                </div>
                <div class="p-4 rounded-xl bg-white/70 dark:bg-white/5 border border-white/40 dark:border-white/10">
                  <div class="text-xs text-slate-500">库存预警数量</div>
                  <div class="mt-1 text-2xl font-semibold {% if summary.low_stock_count %}text-red-600 dark:text-red-300{% endif %}">{{ summary.low_stock_count }}</div>
                </div>
                <div class="p-4 rounded-xl bg-white/70 dark:bg-white/5 border border-white/40 dark:border-white/10">
                  <div class="text-xs text-slate-500">出入库</div>
                  <div class="mt-1 text-sm">入 {{ summary.latest_in|format_datetime('%Y-%m-%d %H:%M') }}<br>出 {{ summary.latest_out|format_datetime('%Y-%m-%d %H:%M') }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 grid grid-cols-1 {% if permissions.can_view_history %}xl:grid-cols-3{% else %}xl:grid-cols-1{% endif %} gap-6">
      <!-- List -->
      <section class="xl:col-span-2 space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-base font-semibold tracking-tight">库存详情 <span class="text-slate-500 font-normal">共 {{ inventory_pagination.total }} 项</span></h2>
          <div class="md:hidden inline-flex rounded-xl overflow-hidden border border-slate-200/60 dark:border-white/10">
            {% if permissions.can_manage_items %}
              <button class="px-3 py-2 text-sm" id="importTriggerM">导入</button>
              <a class="px-3 py-2 text-sm" href="/api/items/template">模板</a>
              <a class="px-3 py-2 text-sm" href="/api/items/export">导出</a>
              <button class="px-3 py-2 text-sm bg-brand-600 text-white" data-open-modal="#addModal">新增</button>
            {% endif %}
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-2 justify-between text-xs text-slate-500">
          <form method="get" action="{{ url_for('index') }}" class="flex items-center gap-1">
            {% for key, values in preserved_query.items() %}
              {% if key not in ['inventory_per_page', 'inventory_page'] %}
                {% for value in values %}
                  <input type="hidden" name="{{ key }}" value="{{ value }}" />
                {% endfor %}
              {% endif %}
            {% endfor %}
            <input type="hidden" name="inventory_page" value="1" />
            <label class="flex items-center gap-1">
              <span>每页</span>
              <select name="inventory_per_page" class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/80 dark:bg-white/5 px-2 py-1" onchange="this.form.submit()">
                {% for option in [5, 10, 20, 50, 100] %}
                  <option value="{{ option }}" {% if inventory_pagination.per_page == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
              </select>
            </label>
          </form>
          <div class="flex items-center gap-1">
            <span>第 {{ inventory_pagination.start_index or 0 }}-{{ inventory_pagination.end_index or 0 }} / {{ inventory_pagination.total }} 项</span>
            <a href="{{ inventory_pagination.has_prev and build_query(inventory_page=inventory_pagination.prev_page) or '#' }}" class="px-2 py-1 rounded-lg border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5 {% if not inventory_pagination.has_prev %}pointer-events-none opacity-40{% endif %}">上一页</a>
            <a href="{{ inventory_pagination.has_next and build_query(inventory_page=inventory_pagination.next_page) or '#' }}" class="px-2 py-1 rounded-lg border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5 {% if not inventory_pagination.has_next %}pointer-events-none opacity-40{% endif %}">下一页</a>
          </div>
        </div>

        {% if import_summary %}
          <div class="rounded-xl px-4 py-3 border text-sm shadow-innerlg
                      {% if import_summary.error %} border-red-300/50 bg-red-50 text-red-700 dark:bg-red-500/10 dark:border-red-500/30 dark:text-red-200
                      {% else %} border-emerald-300/50 bg-emerald-50 text-emerald-700 dark:bg-emerald-500/10 dark:border-emerald-500/30 dark:text-emerald-200{% endif %}">
            {% if import_summary.error %}
              导入失败，请确认文件为 UTF-8 编码的 CSV，并包含 <code>name</code>、<code>quantity</code> 字段。
            {% else %}
              已导入 <strong>{{ import_summary.imported or 0 }}</strong> 条记录{% if import_summary.skipped %}，忽略 <strong>{{ import_summary.skipped }}</strong> 条无效行{% endif %}。
            {% endif %}
          </div>
        {% endif %}

        {% if items %}
          <div id="inventoryList" class="divide-y divide-slate-200/70 dark:divide-white/5 rounded-2xl overflow-hidden border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-white/5">
{% for item in items %}
              {% set is_low = item.threshold is not none and item.quantity <= item.threshold %}
              {% set category_info = categories.get(item.category) %}
              <div class="px-5 py-5 transition hover:bg-slate-50/80 dark:hover:bg-white/5 {% if is_low %}bg-red-50/80 dark:bg-red-500/10 border-l-4 border-red-400/60 ring-1 ring-inset ring-red-400/40 dark:ring-red-400/30{% endif %}" data-name="{{ item.name|lower }}" data-low-stock="{{ 'true' if is_low else 'false' }}">
                <form class="grid grid-cols-1 gap-4 items-start lg:grid-cols-12 lg:items-end" method="post" action="/submit">
                  <div class="lg:col-span-4">
                    <div class="flex items-start md:items-center justify-between gap-3">
                      <div class="min-w-0">
                        <div class="flex items-center gap-2">
                          <div class="font-medium overflow-hidden text-ellipsis whitespace-nowrap md:whitespace-normal md:text-clip md:overflow-visible" title="{{ item.name }}">{{ item.name }}</div>
                          {% if is_low %}
                            <span class="inline-flex items-center gap-1 text-[11px] leading-4 font-medium px-2 py-0.5 rounded-full bg-red-500/15 text-red-600 dark:text-red-200 border border-red-500/30">
                              <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 9v4"/><path d="M12 17h.01"/><path d="m10.29 3.86-8 13.86A1.93 1.93 0 0 0 4 20h16a1.93 1.93 0 0 0 1.71-2.28l-8-13.86a2 2 0 0 0-3.42 0Z"/></svg>
                              库存预警
                            </span>
                          {% endif %}
                        </div>
                        <div class="text-xs text-slate-500 mt-1">最近入库：{{ item.last_in|format_datetime('%Y-%m-%d %H:%M') }}</div>
                        <div class="text-xs text-slate-500">最近出库：{{ item.last_out|format_datetime('%Y-%m-%d %H:%M') }}</div>
                        {% if item.threshold is not none %}
                          <div class="text-xs mt-1 {% if is_low %}text-red-600 dark:text-red-300{% else %}text-slate-500{% endif %}">
                            阈值提醒：≤ {{ item.threshold }}{% if item.unit %} {{ item.unit }}{% endif %}{% if is_low %}（当前已触发预警）{% endif %}
                          </div>
                        {% else %}
                          <div class="text-xs text-slate-400 mt-1">未设置阈值提醒</div>
                        {% endif %}
                        <div class="text-xs text-slate-500 mt-1">分类：{{ category_info.name if category_info else '未分类' }}</div>
                      </div>
                      <span class="shrink-0 inline-flex items-center h-7 px-2 rounded-full bg-brand-600/10 text-brand-700 dark:text-brand-300 border border-brand-600/20">
                        {{ item.quantity }}{% if item.unit %} {{ item.unit }}{% endif %}
                      </span>
                    </div>
                  </div>
                  {% if permissions.can_manage_items %}
                    <div class="lg:col-span-2">
                      <label class="block text-xs text-slate-500 mb-1">设置数量</label>
                      <input class="w-full rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" id="quantity-{{ loop.index }}" name="quantity" type="number" min="0" step="1" value="" placeholder="当前 {{ item.quantity }}{% if item.unit %} {{ item.unit }}{% endif %}（输入新数量）" />
                    </div>
                  {% endif %}
                  <div class="lg:col-span-2">
                    <label class="block text-xs text-slate-500 mb-1">单位</label>
                    {% if permissions.can_manage_items %}
                      <input class="w-full rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" id="unit-{{ loop.index }}" name="unit" value="{{ item.unit }}" placeholder="件" />
                    {% else %}
                      <div class="w-full rounded-lg border border-dashed border-slate-200/60 dark:border-white/10 bg-slate-50/80 dark:bg-white/5 px-3 py-2 text-sm text-slate-500">{{ item.unit or '—' }}</div>
                      <input type="hidden" name="unit" value="{{ item.unit }}" />
                    {% endif %}
                  </div>
                  <div class="lg:col-span-2">
                    <label class="block text-xs text-slate-500 mb-1">库存分类</label>
                    {% if permissions.can_manage_categories %}
                      <select class="w-full rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" name="category">
                        {% for category_id, category in categories.items() %}
                          <option value="{{ category_id }}" {% if category_id == item.category %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                      </select>
                    {% else %}
                      <div class="w-full rounded-lg border border-dashed border-slate-200/60 dark:border-white/10 bg-slate-50/80 dark:bg-white/5 px-3 py-2 text-sm text-slate-500">{{ category_info.name if category_info else '未分类' }}</div>
                      <input type="hidden" name="category" value="{{ item.category }}">
                    {% endif %}
                  </div>
                  <div class="lg:col-span-2">
                    <label class="block text-xs text-slate-500 mb-1">阈值提醒{% if permissions.can_manage_threshold %}（可选）{% else %}（仅管理员可改）{% endif %}</label>
                    {% if permissions.can_manage_threshold %}
                      <input class="w-full rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" id="threshold-{{ loop.index }}" name="threshold" type="number" min="0" step="1" value="{{ item.threshold if item.threshold is not none else '' }}" placeholder="例如 10" />
                    {% else %}
                      <div class="w-full rounded-lg border border-dashed border-slate-200/60 dark:border-white/10 bg-slate-50/80 dark:bg-white/5 px-3 py-2 text-sm text-slate-500">
                        {% if item.threshold is not none %}
                          ≤ {{ item.threshold }}{% if item.unit %} {{ item.unit }}{% endif %}
                        {% else %}
                          未设置阈值
                        {% endif %}
                      </div>
                      <input type="hidden" name="threshold" value="{{ item.threshold if item.threshold is not none else '' }}" />
                    {% endif %}
                  </div>
                  <div class="flex flex-wrap gap-2 lg:col-span-12 lg:justify-end">
                    <input type="hidden" name="name" value="{{ item.name }}" />
                    <input type="hidden" name="store_id" value="{{ selected_store }}" />
                    {% if permissions.can_adjust_in %}
                      <button class="px-3 py-2 rounded-lg border border-emerald-500/40 text-emerald-600 hover:bg-emerald-500/10" type="button" data-adjust="in" data-name="{{ item.name }}" data-unit="{{ item.unit or '' }}" data-current="{{ item.quantity }}">入库</button>
                    {% endif %}
                    {% if permissions.can_adjust_out %}
                      <button class="px-3 py-2 rounded-lg border border-amber-500/40 text-amber-600 hover:bg-amber-500/10" type="button" data-adjust="out" data-name="{{ item.name }}" data-unit="{{ item.unit or '' }}" data-current="{{ item.quantity }}">出库</button>
                    {% endif %}
                    {% if permissions.can_manage_items and stores|length > 1 %}
                      <button class="px-3 py-2 rounded-lg border border-cyan-500/40 text-cyan-600 hover:bg-cyan-500/10" type="button" data-transfer data-name="{{ item.name }}" data-unit="{{ item.unit or '' }}" data-current="{{ item.quantity }}" data-store="{{ selected_store }}" data-store-name="{{ stores[selected_store]['name'] }}">调拨</button>
                    {% endif %}
                    {% if permissions.can_manage_items %}
                      <button class="px-3 py-2 rounded-lg border border-brand-600/30 text-brand-700 dark:text-brand-300 hover:bg-brand-600/10" type="submit" name="action" value="update">保存修改</button>
                      <button class="px-3 py-2 rounded-lg border border-red-500/30 text-red-600 hover:bg-red-500/10" type="submit" name="action" value="delete" onclick="return confirm('确认删除 {{ item.name }} 吗？');">删除</button>
                    {% endif %}
                  </div>
                </form>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="p-10 text-center text-slate-500">暂无库存记录，点右上角「新增」录入第一条库存。</div>
        {% endif %}
      </section>

      {% if permissions.can_view_history %}
      <!-- Sidebar -->
      <aside class="space-y-4">
        <section class="rounded-2xl border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-white/5 p-5">
          <div class="flex flex-wrap items-center justify-between gap-2">
            <h3 class="text-sm font-semibold flex items-center gap-2"><svg class="w-4 h-4 text-brand-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg> 最近动态 <span class="text-xs font-normal text-slate-500">共 {{ timeline_pagination.total }} 条</span></h3>
            <div class="flex items-center gap-2">
              <a class="text-sm px-2 py-1 rounded-lg border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5" href="/api/history/export">导出记录</a>
              {% if permissions.can_clear_history %}
                <form method="post" action="{{ url_for('clear_history') }}" onsubmit="return confirm('确认清除全部最近动态记录？');">
                  <button type="submit" class="text-sm px-2 py-1 rounded-lg border border-red-400/40 text-red-600 hover:bg-red-500/10">清除记录</button>
                </form>
              {% endif %}
            </div>
          </div>
          <div class="mt-3 flex flex-wrap items-center gap-2 justify-between text-xs text-slate-500">
            <form method="get" action="{{ url_for('index') }}" class="flex items-center gap-1">
              {% for key, values in preserved_query.items() %}
                {% if key not in ['timeline_sku', 'timeline_page'] %}
                  {% for value in values %}
                    <input type="hidden" name="{{ key }}" value="{{ value }}" />
                  {% endfor %}
                {% endif %}
              {% endfor %}
              <input type="hidden" name="timeline_page" value="1" />
              <label class="flex items-center gap-1">
                <span>筛选 SKU</span>
                <select name="timeline_sku" class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/80 dark:bg-white/5 px-2 py-1" onchange="this.form.submit()">
                  <option value="" {% if not timeline_sku %}selected{% endif %}>全部</option>
                  {% for name in timeline_sku_options %}
                    <option value="{{ name }}" {% if timeline_sku == name %}selected{% endif %}>{{ name }}</option>
                  {% endfor %}
                </select>
              </label>
            </form>
            <form method="get" action="{{ url_for('index') }}" class="flex items-center gap-1">
              {% for key, values in preserved_query.items() %}
                {% if key not in ['timeline_per_page', 'timeline_page'] %}
                  {% for value in values %}
                    <input type="hidden" name="{{ key }}" value="{{ value }}" />
                  {% endfor %}
                {% endif %}
              {% endfor %}
              <input type="hidden" name="timeline_page" value="1" />
              <label class="flex items-center gap-1">
                <span>每页</span>
                <select name="timeline_per_page" class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-white/80 dark:bg-white/5 px-2 py-1" onchange="this.form.submit()">
                  {% for option in [5, 10, 20, 50] %}
                    <option value="{{ option }}" {% if timeline_pagination.per_page == option %}selected{% endif %}>{{ option }}</option>
                  {% endfor %}
                </select>
              </label>
            </form>
            <div class="flex items-center gap-1">
              <span>第 {{ timeline_pagination.start_index or 0 }}-{{ timeline_pagination.end_index or 0 }} / {{ timeline_pagination.total }} 条</span>
              <a href="{{ timeline_pagination.has_prev and build_query(timeline_page=timeline_pagination.prev_page) or '#' }}" class="px-2 py-1 rounded-lg border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5 {% if not timeline_pagination.has_prev %}pointer-events-none opacity-40{% endif %}">上一页</a>
              <a href="{{ timeline_pagination.has_next and build_query(timeline_page=timeline_pagination.next_page) or '#' }}" class="px-2 py-1 rounded-lg border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5 {% if not timeline_pagination.has_next %}pointer-events-none opacity-40{% endif %}">下一页</a>
            </div>
          </div>
          <div class="mt-4">
            {% if timeline %}
              <ul class="space-y-3">
                {% for event in timeline %}
                  <li class="flex items-start gap-3">
                    <span class="inline-flex text-xs px-2 py-1 rounded-lg border 
                      {% if event.badge == 'success' %}border-emerald-500/30 text-emerald-600 bg-emerald-600/10{% elif event.badge == 'danger' %}border-red-500/30 text-red-600 bg-red-600/10{% else %}border-slate-400/30 text-slate-600 bg-slate-400/10{% endif %}">
                      {{ event.type }}
                    </span>
                    <div class="min-w-0">
                      <div class="text-sm font-medium">{{ event.name }}</div>
                      <div class="text-xs text-slate-500">{{ event.timestamp|format_datetime('%Y-%m-%d %H:%M') }}</div>
                      <div class="text-xs text-slate-400 mt-1">操作人：{{ event.user }}</div>
                      {% if event.details %}
                        {% if event.details is string %}
                          <div class="text-xs text-slate-500 mt-1">{{ event.details }}</div>
                        {% else %}
                          <ul class="text-xs text-slate-500 mt-2 list-disc list-inside">
                            {% for detail in event.details %}
                              <li>{{ detail }}</li>
                            {% endfor %}
                          </ul>
                        {% endif %}
                      {% endif %}
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-slate-500 text-sm">当前暂无出入库记录，开始第一次操作后即可在此查看。</p>
            {% endif %}
          </div>
        </section>

      </aside>
      {% endif %}
    </main>

    <!-- Import Preview Modal -->
    <div id="importPreviewModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4" data-modal>
      <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" data-close-modal></div>
      <div class="relative w-full max-w-3xl rounded-2xl border border-slate-200/60 dark:border-white/10 bg-white dark:bg-slate-900 p-6 shadow-xlsoft animate-in space-y-5">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-lg font-semibold">导入前检查</h2>
            <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">请确认系统已正确识别即将导入的 SKU 数据。</p>
          </div>
          <button type="button" id="importPreviewClose" class="h-9 w-9 grid place-items-center rounded-full hover:bg-slate-100/70 dark:hover:bg-white/5" data-close-modal>&times;</button>
        </div>
        <div id="importPreviewStatus" class="text-sm text-slate-500 dark:text-slate-400 bg-slate-100/80 dark:bg-white/5 border border-slate-200/60 dark:border-white/10 rounded-xl px-4 py-3">
          请按照模板准备表格并选择文件，系统会在导入前完成检查。
        </div>
        <div class="border border-slate-200/60 dark:border-white/10 rounded-xl overflow-hidden">
          <div class="max-h-72 overflow-y-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-slate-100/80 dark:bg-white/5 text-slate-500 dark:text-slate-400">
                <tr>
                  <th class="px-4 py-2 text-left font-medium">行号</th>
                  <th class="px-4 py-2 text-left font-medium">SKU 名称</th>
                  <th class="px-4 py-2 text-left font-medium">数量</th>
                  <th class="px-4 py-2 text-left font-medium">单位</th>
                  <th class="px-4 py-2 text-left font-medium">分类</th>
                  <th class="px-4 py-2 text-left font-medium">阈值提醒</th>
                  <th class="px-4 py-2 text-left font-medium">识别状态</th>
                </tr>
              </thead>
              <tbody id="importPreviewTable" class="divide-y divide-slate-200/60 dark:divide-white/5 bg-white dark:bg-slate-900">
                <tr>
                  <td colspan="7" class="px-4 py-6 text-center text-sm text-slate-400">等待文件上传</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div id="importPreviewSummary" class="text-sm text-slate-500 dark:text-slate-400"></div>
        <div class="flex justify-end gap-2">
          <button type="button" id="importPreviewCancel" class="px-3 py-2 rounded-lg border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5" data-close-modal>取消</button>
          <button type="button" id="importPreviewConfirm" class="px-4 py-2 rounded-lg bg-brand-600 text-white text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed">确认导入</button>
        </div>
      </div>
    </div>

    <!-- Hidden Import Form -->
    <form id="importForm" class="hidden" action="/import" method="post" enctype="multipart/form-data">
      <input id="importFile" name="file" type="file" accept=".csv,text/csv">
      <input id="importStoreId" type="hidden" name="store_id" value="{{ selected_store }}">
    </form>

    {% if low_stock_items %}
      <div id="thresholdAlert" class="fixed inset-0 z-[55] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-red-500/20 dark:bg-red-900/40 backdrop-blur-sm" data-close-alert></div>
        <div class="relative w-full max-w-lg rounded-2xl border border-red-400/40 dark:border-red-500/40 bg-white dark:bg-slate-900 p-6 shadow-xlsoft animate-in flex flex-col max-h-[85vh]">
          <div class="flex items-center justify-between gap-3">
            <h2 class="text-lg font-semibold text-red-600 dark:text-red-300">库存阈值预警</h2>
            <button class="h-9 w-9 grid place-items-center rounded-full hover:bg-red-100/60 dark:hover:bg-red-500/20" data-close-alert>&times;</button>
          </div>
          <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">以下 {{ low_stock_items|length }} 个 SKU 当前库存已达到或低于设定的阈值，请及时安排补货：</p>
          <ul class="mt-4 space-y-3 overflow-y-auto flex-1 pr-1 -mr-1 max-h-[50vh]">
            {% for item in low_stock_items %}
              <li class="flex items-start justify-between gap-3 rounded-xl border border-red-200/60 dark:border-red-500/30 bg-red-50/70 dark:bg-red-500/10 px-4 py-3">
                <div class="min-w-0">
                  <div class="font-medium text-red-700 dark:text-red-200 truncate" title="{{ item.name }}">{{ item.name }}</div>
                  <div class="text-xs text-red-600/80 dark:text-red-200/80 mt-1">当前库存：{{ item.quantity }}{% if item.unit %} {{ item.unit }}{% endif %}，阈值：{{ item.threshold }}{% if item.unit %} {{ item.unit }}{% endif %}</div>
                </div>
                <span class="shrink-0 inline-flex items-center text-xs px-3 py-1 rounded-full bg-white text-red-600 border border-red-300/70">低库存</span>
              </li>
            {% endfor %}
          </ul>
          <div class="mt-5 text-right pt-1">
            <button type="button" class="px-4 py-2 rounded-lg bg-red-500 text-white hover:brightness-110" data-close-alert>我知道了</button>
          </div>
        </div>
      </div>
    {% endif %}

    <!-- Add Item Modal -->
    <div id="addModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4" data-modal>
      <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" data-close-modal></div>
      <div class="relative w-full max-w-md rounded-2xl border border-slate-200/60 dark:border-white/10 bg-white dark:bg-slate-900 p-6 shadow-xlsoft animate-in">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">新增库存</h2>
          <button type="button" class="h-9 w-9 grid place-items-center rounded-full hover:bg-slate-100/70 dark:hover:bg-white/5" data-close-modal>&times;</button>
        </div>
        <form method="post" action="/submit" class="mt-4 grid gap-4" novalidate>
          <input type="hidden" name="action" value="create">
          <input type="hidden" name="store_id" value="{{ selected_store }}">
          <label class="grid gap-1 text-sm">
            <span class="text-slate-500">物品名称</span>
            <input class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" id="modal-name" name="name" placeholder="例如：咖啡豆" required>
          </label>
          <div class="grid grid-cols-2 gap-3">
            <label class="grid gap-1 text-sm">
              <span class="text-slate-500">初始数量</span>
              <input class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" id="modal-quantity" name="quantity" type="number" min="0" step="1" value="0" required>
            </label>
            <label class="grid gap-1 text-sm">
              <span class="text-slate-500">单位（可选）</span>
              <input class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" id="modal-unit" name="unit" placeholder="件 / 盒 / 千克">
            </label>
          </div>
          <label class="grid gap-1 text-sm">
            <span class="text-slate-500">库存分类</span>
            <select class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" name="category">
              {% for category_id, category in categories.items() %}
                <option value="{{ category_id }}" {% if category_id == selected_category %}selected{% endif %}>{{ category.name }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="grid gap-1 text-sm">
            <span class="text-slate-500">阈值提醒（可选）</span>
            <input class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" id="modal-threshold" name="threshold" type="number" min="0" step="1" placeholder="当库存 ≤ 此值时提醒">
            <span class="text-xs text-slate-400">留空表示不设置预警。</span>
          </label>
          <div class="flex justify-end gap-2 pt-2">
            <button type="button" class="px-3 py-2 rounded-lg border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5" data-close-modal>取消</button>
            <button type="submit" class="px-3 py-2 rounded-lg bg-brand-600 text-white hover:brightness-105">保存</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Adjust Quantity Modal -->
    <div id="adjustModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4" data-modal>
      <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" data-close-modal></div>
      <div class="relative w-full max-w-md rounded-2xl border border-slate-200/60 dark:border-white/10 bg-white dark:bg-slate-900 p-6 shadow-xlsoft animate-in">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold" id="adjustModalTitle">调整库存</h2>
          <button type="button" class="h-9 w-9 grid place-items-center rounded-full hover:bg-slate-100/70 dark:hover:bg-white/5" data-close-modal>&times;</button>
        </div>
        <div class="mt-2 text-sm text-slate-500" id="adjustModalInfo"></div>
        <form id="adjustForm" method="post" action="/submit" class="mt-4 grid gap-4" novalidate>
          <input type="hidden" name="action" id="adjustAction">
          <input type="hidden" name="name" id="adjustName">
          <input type="hidden" name="store_id" value="{{ selected_store }}">
          <label class="grid gap-1 text-sm">
            <span class="text-slate-500" id="adjustQuantityLabel">数量</span>
            <input class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" id="adjustQuantity" name="quantity" type="number" min="1" step="1" required>
          </label>
          <div class="flex justify-end gap-2 pt-2">
            <button type="button" class="px-3 py-2 rounded-lg border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5" data-close-modal>取消</button>
            <button type="submit" class="px-3 py-2 rounded-lg bg-brand-600 text-white hover:brightness-105" id="adjustSubmitBtn">确认</button>
          </div>
        </form>
      </div>
    </div>

    {% if permissions.can_manage_items and stores|length > 1 %}
    <!-- Transfer Modal -->
    <div id="transferModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4" data-modal>
      <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" data-close-modal></div>
      <div class="relative w-full max-w-md rounded-2xl border border-slate-200/60 dark:border-white/10 bg-white dark:bg-slate-900 p-6 shadow-xlsoft animate-in">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">SKU 调拨</h2>
          <button type="button" class="h-9 w-9 grid place-items-center rounded-full hover:bg-slate-100/70 dark:hover:bg-white/5" data-close-modal>&times;</button>
        </div>
        <div class="mt-2 text-sm text-slate-500" id="transferInfo"></div>
        <form id="transferForm" method="post" action="/submit" class="mt-4 grid gap-4" novalidate>
          <input type="hidden" name="action" value="transfer">
          <input type="hidden" name="name" id="transferName">
          <input type="hidden" name="store_id" id="transferSourceStore" value="{{ selected_store }}">
          <label class="grid gap-1 text-sm">
            <span class="text-slate-500">目标门店</span>
            <select class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" id="transferTargetStore" name="target_store_id" required>
              {% for store_id, store in stores.items() %}
                <option value="{{ store_id }}">{{ store.name }}</option>
              {% endfor %}
            </select>
          </label>
          <label class="grid gap-1 text-sm">
            <span class="text-slate-500">调拨数量</span>
            <input class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" id="transferQuantity" name="quantity" type="number" min="1" step="1" required>
          </label>
          <div class="flex justify-end gap-2 pt-2">
            <button type="button" class="px-3 py-2 rounded-lg border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5" data-close-modal>取消</button>
            <button type="submit" class="px-3 py-2 rounded-lg bg-brand-600 text-white hover:brightness-105" id="transferSubmitBtn">确认调拨</button>
          </div>
        </form>
      </div>
    </div>
    {% endif %}


    <!-- Store Management Modal -->
    <div id="storeModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4" data-modal>
      <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" data-close-modal></div>
      <div class="relative w-full max-w-lg rounded-2xl border border-slate-200/60 dark:border-white/10 bg-white dark:bg-slate-900 p-6 shadow-xlsoft animate-in">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">门店管理</h2>
          <button type="button" class="h-9 w-9 grid place-items-center rounded-full hover:bg-slate-100/70 dark:hover:bg-white/5" data-close-modal>&times;</button>
        </div>
        <form method="post" action="{{ url_for('create_store_route') }}" class="mt-4 grid gap-3" novalidate>
          <label class="grid gap-1 text-sm">
            <span class="text-slate-500">新增门店名称</span>
            <input class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" name="name" placeholder="例如：旗舰店" required>
          </label>
          <div class="flex justify-end gap-2">
            <button type="submit" class="px-3 py-2 rounded-lg bg-brand-600 text-white hover:brightness-105">新增门店</button>
          </div>
        </form>
        <div class="mt-6 space-y-3">
          <h3 class="text-sm font-semibold text-slate-600 dark:text-slate-300">现有门店</h3>
          <ul class="space-y-2">
            {% for store_id, store in stores.items() %}
              <li class="flex items-center justify-between gap-3 rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-2 text-sm">
                <div>
                  <div class="font-medium">{{ store.name }}</div>
                  <div class="text-xs text-slate-500">SKU 数量：{{ store.items_count }}</div>
                </div>
                <div class="flex items-center gap-2">
                  <form method="post" action="{{ url_for('delete_store_route', store_id=store_id) }}" onsubmit="return confirm('确认删除 {{ store.name }} 吗？');">
                    <button type="submit" class="px-3 py-1 rounded-lg border border-red-400/50 text-red-600 hover:bg-red-500/10">删除</button>
                  </form>
                  <form method="post" action="{{ url_for('delete_store_route', store_id=store_id) }}" onsubmit="return confirm('确认删除 {{ store.name }} 并清空其库存吗？');">
                    <input type="hidden" name="cascade" value="1">
                    <button type="submit" class="px-3 py-1 rounded-lg border border-red-500/60 text-red-600 hover:bg-red-600/10">连同库存删除</button>
                  </form>
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <!-- Category Management Modal -->
    <div id="categoryModal" class="fixed inset-0 z-[60] hidden items-center justify-center p-4" data-modal>
      <div class="absolute inset-0 bg-slate-900/30 backdrop-blur-sm" data-close-modal></div>
      <div class="relative w-full max-w-lg rounded-2xl border border-slate-200/60 dark:border-white/10 bg-white dark:bg-slate-900 p-6 shadow-xlsoft animate-in">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">分类管理</h2>
          <button type="button" class="h-9 w-9 grid place-items-center rounded-full hover:bg-slate-100/70 dark:hover:bg-white/5" data-close-modal>&times;</button>
        </div>
        <form method="post" action="{{ url_for('create_category_route') }}" class="mt-4 grid gap-3" novalidate>
          <label class="grid gap-1 text-sm">
            <span class="text-slate-500">新增分类名称</span>
            <input class="rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" name="name" placeholder="例如：饮品" required>
          </label>
          <div class="flex justify-end gap-2">
            <button type="submit" class="px-3 py-2 rounded-lg bg-brand-600 text-white hover:brightness-105">新增分类</button>
          </div>
        </form>
        <div class="mt-6 space-y-3">
          <h3 class="text-sm font-semibold text-slate-600 dark:text-slate-300">现有分类</h3>
          <ul class="space-y-2 max-h-64 overflow-y-auto pr-1">
            {% for category_id, category in categories.items() %}
              <li class="flex items-center justify-between gap-3 rounded-lg border border-slate-200/60 dark:border-white/10 px-3 py-2 text-sm">
                <div>
                  <div class="font-medium">{{ category.name }}</div>
                  <div class="text-xs text-slate-500">ID：{{ category_id }}</div>
                </div>
                <div class="flex items-center gap-2">
                  {% if category_id != 'uncategorized' %}
                    <form method="post" action="{{ url_for('delete_category_route', category_id=category_id) }}" onsubmit="return confirm('确认删除分类 {{ category.name }} 吗？');">
                      <button type="submit" class="px-3 py-1 rounded-lg border border-red-400/50 text-red-600 hover:bg-red-500/10">删除</button>
                    </form>
                    <form method="post" action="{{ url_for('delete_category_route', category_id=category_id) }}" onsubmit="return confirm('确认删除分类 {{ category.name }} 并清空其下所有 SKU 吗？');">
                      <input type="hidden" name="cascade" value="1">
                      <button type="submit" class="px-3 py-1 rounded-lg border border-red-500/60 text-red-600 hover:bg-red-600/10">连同库存删除</button>
                    </form>
                  {% else %}
                    <span class="text-xs text-slate-400">系统默认分类</span>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 z-[70] hidden">
      <div class="rounded-xl bg-emerald-600 text-white shadow-xlsoft px-4 py-3 text-sm">操作已提交</div>
    </div>

    <!-- Scripts -->
    <script>
      // theme
      const root = document.documentElement;
      const themeToggleButton = document.getElementById('themeToggle');
      const themeMedia = window.matchMedia('(prefers-color-scheme: dark)');
      const getTheme = () => localStorage.getItem('theme');
      const setTheme = t => localStorage.setItem('theme', t);
      const updateThemeToggle = t => {
        if (!themeToggleButton) return;
        themeToggleButton.setAttribute('aria-pressed', t === 'dark' ? 'true' : 'false');
        themeToggleButton.dataset.theme = t;
        const label = themeToggleButton.querySelector('.theme-label');
        if (label) label.textContent = t === 'dark' ? '浅色模式' : '深色模式';
      };
      const applyTheme = t => {
        root.classList.toggle('dark', t === 'dark');
        updateThemeToggle(t);
      };
      const initTheme = () => {
        const stored = getTheme();
        if (stored) {
          applyTheme(stored);
          return;
        }
        applyTheme(themeMedia.matches ? 'dark' : 'light');
      };
      initTheme();
      themeToggleButton?.addEventListener('click', () => {
        const nextTheme = root.classList.contains('dark') ? 'light' : 'dark';
        applyTheme(nextTheme);
        setTheme(nextTheme);
      });
      const handleSystemThemeChange = event => {
        if (getTheme()) return;
        applyTheme(event.matches ? 'dark' : 'light');
      };
      if (typeof themeMedia.addEventListener === 'function') {
        themeMedia.addEventListener('change', handleSystemThemeChange);
      } else if (typeof themeMedia.addListener === 'function') {
        themeMedia.addListener(handleSystemThemeChange);
      }

      // modal helpers
      function openModal(selector){
        const modal = document.querySelector(selector);
        if(!modal) return;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }
      function closeModal(selector){
        const modal = document.querySelector(selector);
        if(!modal) return;
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
      const modalElements = document.querySelectorAll('[data-modal]');
      document.querySelectorAll('[data-open-modal]')?.forEach(btn => {
        const target = btn.getAttribute('data-open-modal');
        if(!target) return;
        btn.addEventListener('click', () => openModal(target));
      });
      document.querySelectorAll('[data-close-modal]')?.forEach(btn => {
        btn.addEventListener('click', () => {
          const modal = btn.closest('[data-modal]');
          if(modal?.id) closeModal(`#${modal.id}`);
        });
      });
      modalElements.forEach(modal => {
        modal.addEventListener('click', event => {
          if(event.target === modal) closeModal(`#${modal.id}`);
        });
      });

      // adjust modal wiring
      (function setupAdjustModal(){
        const adjustModal = document.getElementById('adjustModal');
        const adjustButtons = document.querySelectorAll('[data-adjust]');
        const adjustActionInput = document.getElementById('adjustAction');
        const adjustNameInput = document.getElementById('adjustName');
        const adjustQuantityInput = document.getElementById('adjustQuantity');
        const adjustInfo = document.getElementById('adjustModalInfo');
        const adjustTitle = document.getElementById('adjustModalTitle');
        const adjustQuantityLabel = document.getElementById('adjustQuantityLabel');
        const adjustSubmitBtn = document.getElementById('adjustSubmitBtn');
        if(!adjustModal || !adjustButtons.length || !adjustActionInput || !adjustNameInput || !adjustQuantityInput || !adjustInfo || !adjustTitle || !adjustQuantityLabel || !adjustSubmitBtn){
          return;
        }
        adjustButtons.forEach(button => {
          button.addEventListener('click', () => {
            const action = button.getAttribute('data-adjust') || 'in';
            const name = button.getAttribute('data-name') || '';
            const unit = button.getAttribute('data-unit') || '';
            const current = Number(button.getAttribute('data-current') || '0');
            const isOut = action === 'out';
            adjustActionInput.value = action;
            adjustNameInput.value = name;
            adjustQuantityInput.value = '';
            adjustQuantityInput.min = 1;
            if(isOut && current > 0){
              adjustQuantityInput.setAttribute('max', String(current));
            } else {
              adjustQuantityInput.removeAttribute('max');
            }
            const disable = isOut && current === 0;
            adjustQuantityInput.disabled = disable;
            adjustSubmitBtn.disabled = disable;
            adjustQuantityInput.placeholder = isOut ? '请输入出库数量' : '请输入入库数量';
            adjustTitle.textContent = isOut ? '出库' : '入库';
            adjustQuantityLabel.textContent = isOut ? '出库数量' : '入库数量';
            adjustSubmitBtn.textContent = isOut ? '确认出库' : '确认入库';
            const unitSuffix = unit ? ' ' + unit : '';
            let infoText = `${name} · 当前库存 ${current}${unitSuffix}`;
            if(disable){
              infoText += ' · 当前库存不足以出库';
            }
            adjustInfo.textContent = infoText;
            openModal('#adjustModal');
            setTimeout(() => {
              if(!adjustQuantityInput.disabled){
                adjustQuantityInput.focus();
              }
            }, 120);
          });
        });
      })();

      (function setupTransferModal(){
        const transferModal = document.getElementById('transferModal');
        if(!transferModal) return;
        const transferButtons = document.querySelectorAll('[data-transfer]');
        if(!transferButtons.length) return;
        const transferNameInput = document.getElementById('transferName');
        const transferSourceInput = document.getElementById('transferSourceStore');
        const transferTargetSelect = document.getElementById('transferTargetStore');
        const transferQuantityInput = document.getElementById('transferQuantity');
        const transferInfo = document.getElementById('transferInfo');
        const transferSubmitBtn = document.getElementById('transferSubmitBtn');
        transferButtons.forEach(button => {
          button.addEventListener('click', () => {
            const name = button.getAttribute('data-name') || '';
            const unit = button.getAttribute('data-unit') || '';
            const current = Number(button.getAttribute('data-current') || '0');
            const storeId = button.getAttribute('data-store') || '';
            const storeName = button.getAttribute('data-store-name') || '';
            transferNameInput.value = name;
            transferSourceInput.value = storeId;
            let firstAvailable = null;
            Array.from(transferTargetSelect.options).forEach(option => {
              const isSame = option.value === storeId;
              option.disabled = isSame;
              if(isSame && option.selected){
                option.selected = false;
              }
              if(!isSame && !firstAvailable){
                firstAvailable = option;
              }
            });
            if((!transferTargetSelect.value || transferTargetSelect.options[transferTargetSelect.selectedIndex]?.disabled) && firstAvailable){
              firstAvailable.selected = true;
            }
            transferQuantityInput.value = '';
            const unitSuffix = unit ? ` ${unit}` : '';
            let infoText = `${name} · 当前库存 ${current}${unitSuffix}`;
            if(storeName){
              infoText += ` · 调出门店：${storeName}`;
            }
            if(current > 0){
              transferQuantityInput.max = String(current);
              transferQuantityInput.disabled = false;
              transferSubmitBtn.disabled = false;
              transferQuantityInput.placeholder = `最多可调拨 ${current}${unitSuffix}`.trim();
            } else {
              transferQuantityInput.removeAttribute('max');
              transferQuantityInput.disabled = true;
              transferSubmitBtn.disabled = true;
              transferQuantityInput.placeholder = '当前库存不足，无法调拨';
              infoText += ' · 当前库存不足以调拨';
            }
            transferInfo.textContent = infoText;
            openModal('#transferModal');
            setTimeout(() => {
              if(!transferQuantityInput.disabled){
                transferQuantityInput.focus();
              }
            }, 120);
          });
        });
      })();

      // toast
      const toast = document.getElementById('toast');
      function showToast(){ if(!toast) return; toast.classList.remove('hidden'); setTimeout(()=>toast.classList.add('hidden'), 1800); }
      document.querySelectorAll('form').forEach(f=>{
        f.addEventListener('submit', () => { setTimeout(showToast, 50); });
      });

      // import wiring with preview
      const fileInput = document.getElementById('importFile');
      const importForm = document.getElementById('importForm');
      const importStoreInput = document.getElementById('importStoreId');
      const storeSelect = document.querySelector('select[name="store_id"]');
      const importPreviewModal = document.getElementById('importPreviewModal');
      const importPreviewStatus = document.getElementById('importPreviewStatus');
      const importPreviewTable = document.getElementById('importPreviewTable');
      const importPreviewSummary = document.getElementById('importPreviewSummary');
      const importPreviewConfirm = document.getElementById('importPreviewConfirm');
      const importPreviewCancel = document.getElementById('importPreviewCancel');
      const importPreviewClose = document.getElementById('importPreviewClose');
      const importTriggers = [document.getElementById('importTrigger'), document.getElementById('importTriggerM')].filter(Boolean);
      let pendingImportFile = null;

      function currentStoreId(){
        if(storeSelect){
          return storeSelect.value;
        }
        if(importStoreInput){
          return importStoreInput.value || '';
        }
        return '';
      }

      function syncImportStore(){
        if(importStoreInput){
          importStoreInput.value = currentStoreId();
        }
      }

      function setPreviewStatus(message, variant = 'info'){
        if(!importPreviewStatus){
          return;
        }
        importPreviewStatus.textContent = message;
        if(variant === 'error'){
          importPreviewStatus.classList.add('text-red-600','dark:text-red-300');
        } else {
          importPreviewStatus.classList.remove('text-red-600','dark:text-red-300');
        }
      }

      function renderPreviewRows(rows, options = {}){
        const { emptyText = '未识别到可导入的数据' } = options;
        if(!importPreviewTable){
          return;
        }
        importPreviewTable.innerHTML = '';
        if(!Array.isArray(rows) || !rows.length){
          const emptyRow = document.createElement('tr');
          const emptyCell = document.createElement('td');
          emptyCell.colSpan = 7;
          emptyCell.className = 'px-4 py-6 text-center text-sm text-slate-400';
          emptyCell.textContent = emptyText;
          emptyRow.appendChild(emptyCell);
          importPreviewTable.appendChild(emptyRow);
          if(importPreviewSummary){
            importPreviewSummary.textContent = '';
          }
          if(importPreviewConfirm){
            importPreviewConfirm.disabled = true;
            importPreviewConfirm.textContent = '确认导入';
          }
          return;
        }
        let validCount = 0;
        rows.forEach(row => {
          const tr = document.createElement('tr');
          const isValid = Boolean(row && row.valid);
          if(isValid){
            validCount += 1;
            tr.className = 'bg-white dark:bg-slate-900';
          } else {
            tr.className = 'bg-red-50/70 dark:bg-red-500/10';
          }
          const categoryName = row?.category_name || '未分类';
          const categoryInput = row?.category_input || '';
          const categoryText = categoryInput && categoryInput !== categoryName
            ? `${categoryName}（原始：${categoryInput}）`
            : categoryName;
          const messages = Array.isArray(row?.messages) ? row.messages : [];
          const statusText = isValid
            ? '可导入'
            : messages.length
              ? `将被忽略：${messages.join('；')}`
              : '将被忽略：数据格式异常';
          const cells = [
            String(row?.index ?? ''),
            row?.name || '',
            row?.quantity === 0 || row?.quantity ? String(row.quantity) : '—',
            row?.unit ? String(row.unit) : '—',
            categoryText,
            row?.threshold === 0 || row?.threshold ? String(row.threshold) : '—',
            statusText,
          ];
          cells.forEach((value, idx) => {
            const td = document.createElement('td');
            td.className = 'px-4 py-2 text-sm align-top';
            if(idx === 6){
              td.className += ' max-w-xs';
            }
            td.textContent = value;
            tr.appendChild(td);
          });
          importPreviewTable.appendChild(tr);
        });
        const total = rows.length;
        const invalidCount = total - validCount;
        if(importPreviewSummary){
          let summary = `共识别 ${total} 条记录`;
          if(validCount){
            summary += `，其中 ${validCount} 条可导入`;
          }
          if(invalidCount){
            summary += `，${invalidCount} 条存在问题`;
          }
          importPreviewSummary.textContent = summary;
        }
        if(importPreviewConfirm){
          importPreviewConfirm.disabled = validCount === 0;
          importPreviewConfirm.textContent = validCount ? `确认导入（${validCount} 条）` : '确认导入';
        }
      }

      function resetImportPreview(options = {}){
        const { preserveFile = false } = options;
        pendingImportFile = null;
        if(fileInput && !preserveFile){
          fileInput.value = '';
        }
        setPreviewStatus('请按照模板准备表格并选择文件，系统会在导入前完成检查。');
        renderPreviewRows([], { emptyText: '等待文件上传' });
      }

      syncImportStore();
      storeSelect?.addEventListener('change', syncImportStore);
      importPreviewCancel?.addEventListener('click', () => resetImportPreview());
      importPreviewClose?.addEventListener('click', () => resetImportPreview());
      importPreviewModal?.addEventListener('click', event => {
        if(event.target === importPreviewModal){
          resetImportPreview();
        }
      });

      importTriggers.forEach(trigger => {
        trigger.addEventListener('click', () => {
          if(!fileInput){
            return;
          }
          resetImportPreview();
          syncImportStore();
          fileInput.click();
        });
      });

      fileInput?.addEventListener('change', async () => {
        if(!fileInput.files?.length || !importForm){
          return;
        }
        const file = fileInput.files[0];
        pendingImportFile = null;
        syncImportStore();
        openModal('#importPreviewModal');
        setPreviewStatus('正在分析导入文件，请稍候…');
        if(importPreviewSummary){
          importPreviewSummary.textContent = '';
        }
        if(importPreviewConfirm){
          importPreviewConfirm.disabled = true;
          importPreviewConfirm.textContent = '确认导入';
        }
        renderPreviewRows([], { emptyText: '正在分析导入文件…' });
        try {
          const formData = new FormData();
          formData.append('file', file);
          const storeId = currentStoreId();
          if(storeId){
            formData.append('store_id', storeId);
          }
          const response = await fetch('/api/items/import/preview', {
            method: 'POST',
            body: formData,
          });
          let data = null;
          try {
            data = await response.json();
          } catch (err) {
            data = null;
          }
          if(!response.ok){
            const message = data && data.error ? data.error : '导入前检查失败';
            throw new Error(message);
          }
          pendingImportFile = file;
          renderPreviewRows(data?.rows || []);
          setPreviewStatus('检查完成，请确认识别结果后继续导入。');
        } catch (error) {
          pendingImportFile = null;
          const message = error instanceof Error ? error.message : '导入前检查失败';
          setPreviewStatus(message, 'error');
          renderPreviewRows([], { emptyText: '未识别到可导入的数据' });
        }
      });

      importPreviewConfirm?.addEventListener('click', () => {
        if(!importPreviewConfirm || importPreviewConfirm.disabled){
          return;
        }
        if(!fileInput?.files?.length || !importForm || !pendingImportFile){
          return;
        }
        setPreviewStatus('正在导入，请稍候…');
        importPreviewConfirm.disabled = true;
        importPreviewConfirm.textContent = '正在导入…';
        syncImportStore();
        if(typeof importForm.requestSubmit === 'function'){
          importForm.requestSubmit();
        } else {
          importForm.submit();
        }
      });

      // menu toggles
      const menuPairs = [
        { button: document.getElementById('actionsMenuBtn'), menu: document.getElementById('actionsMenu') },
        { button: document.getElementById('userMenuBtn'), menu: document.getElementById('userMenu') }
      ].filter(pair => pair.button && pair.menu);
      function closeMenus(){
        menuPairs.forEach(({ button, menu }) => {
          menu.classList.add('hidden');
          button.setAttribute('aria-expanded', 'false');
        });
      }
      menuPairs.forEach(({ button, menu }) => {
        button.addEventListener('click', (event) => {
          event.stopPropagation();
          const expanded = button.getAttribute('aria-expanded') === 'true';
          closeMenus();
          if(!expanded){
            menu.classList.remove('hidden');
            button.setAttribute('aria-expanded', 'true');
          }
        });
      });
      document.addEventListener('click', closeMenus);
      document.addEventListener('keydown', (event) => {
        if(event.key === 'Escape') closeMenus();
      });

      // threshold alert modal
      const thresholdAlert = document.getElementById('thresholdAlert');
      thresholdAlert?.querySelectorAll('[data-close-alert]')?.forEach(el => {
        el.addEventListener('click', () => {
          thresholdAlert.classList.add('hidden');
        });
      });

      const keywordInputs = document.querySelectorAll('[data-keyword-input]');
      function submitKeyword(value){
        const url = new URL(window.location.href);
        const trimmed = value.trim();
        const currentSearch = url.searchParams.get('inventory_search') || '';
        const currentPage = url.searchParams.get('inventory_page') || '1';
        if(trimmed){
          if(trimmed === currentSearch && currentPage === '1'){
            return;
          }
          url.searchParams.set('inventory_search', trimmed);
        } else {
          if(!currentSearch && currentPage === '1'){
            return;
          }
          url.searchParams.delete('inventory_search');
        }
        url.searchParams.set('inventory_page', '1');
        window.location.href = url.toString();
      }
      keywordInputs.forEach(input => {
        input.addEventListener('input', () => {
          const value = input.value;
          keywordInputs.forEach(other => {
            if(other !== input && other.value !== value){
              other.value = value;
            }
          });
        });
        input.addEventListener('keydown', (event) => {
          if(event.key === 'Enter'){
            event.preventDefault();
            submitKeyword(input.value);
          }
        });
        input.addEventListener('search', () => {
          submitKeyword(input.value);
        });
      });

      document.querySelectorAll('[data-search-button]').forEach(button => {
        button.addEventListener('click', () => {
          const selector = button.getAttribute('data-input-selector');
          let value = '';
          if(selector){
            const target = document.querySelector(selector);
            if(target){
              value = target.value;
            }
          } else if(keywordInputs.length){
            value = keywordInputs[0].value;
          }
          submitKeyword(value);
        });
      });

      const categoryFilters = document.querySelectorAll('[data-category-filter]');
      categoryFilters.forEach(select => {
        select.addEventListener('change', () => {
          const url = new URL(window.location.href);
          const value = select.value;
          if(value){
            url.searchParams.set('category', value);
          } else {
            url.searchParams.delete('category');
          }
          window.location.href = url.toString();
        });
      });
    </script>
  </body>
</html>
