<!doctype html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>最近动态 · 库存控制中心</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #eef1f9;
        --fg: #111827;
        --muted: #6b7280;
        --surface: rgba(255, 255, 255, 0.94);
        --panel: rgba(255,255,255,0.82);
        --border: rgba(148, 163, 184, 0.35);
        --border-strong: rgba(100, 116, 139, 0.45);
        --accent: #4c6ef5;
        --accent-soft: rgba(76, 110, 245, 0.12);
        --danger: #ef4444;
        --warning: #f59e0b;
        --success: #10b981;
        --shadow: 0 28px 60px rgba(15, 23, 42, 0.15);
        --radius-lg: 24px;
        --radius-md: 16px;
      }
      :root.dark {
        --bg: #050a18;
        --fg: #f8fafc;
        --muted: #94a3b8;
        --surface: rgba(12, 18, 36, 0.9);
        --panel: rgba(12, 18, 36, 0.78);
        --border: rgba(100, 116, 139, 0.22);
        --border-strong: rgba(100, 116, 139, 0.35);
        --shadow: 0 28px 60px rgba(2, 6, 23, 0.6);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Inter", "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
        background: radial-gradient(circle at top left, rgba(76, 110, 245, 0.15), transparent 55%),
                    radial-gradient(circle at bottom right, rgba(20, 184, 166, 0.08), transparent 60%),
                    var(--bg);
        color: var(--fg);
      }
      a { color: inherit; text-decoration: none; }
      .hidden { display: none !important; }
      .flex { display: flex !important; }
      .app-shell {
        min-height: 100vh;
        display: grid;
        grid-template-columns: 280px minmax(0, 1fr);
        gap: 0;
      }
      .sidebar {
        position: sticky;
        top: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 24px;
        padding: 32px 28px;
        background: var(--surface);
        border-right: 1px solid var(--border);
        box-shadow: inset -1px 0 0 rgba(255,255,255,0.04);
      }
      .sidebar__brand {
        position: relative;
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 18px 20px;
        border-radius: 20px;
        background: linear-gradient(135deg, rgba(76, 110, 245, 0.16), rgba(14, 116, 144, 0.08));
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 18px 38px rgba(15, 23, 42, 0.12);
      }
      .brand-logo {
        position: relative;
        display: grid;
        place-items: center;
        width: 48px;
        height: 48px;
        border-radius: 16px;
        background: radial-gradient(circle at 30% 30%, rgba(248, 250, 252, 0.9), rgba(226, 232, 240, 0.45));
        border: 1px solid rgba(148, 163, 184, 0.45);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), 0 10px 24px rgba(15, 23, 42, 0.12);
        color: var(--accent);
      }
      .brand-logo::after {
        content: "";
        position: absolute;
        inset: -6px;
        border-radius: 20px;
        background: radial-gradient(circle, rgba(79, 70, 229, 0.14), transparent 65%);
        z-index: -1;
      }
      .brand-logo svg { width: 26px; height: 26px; }
      .brand-meta {
        display: grid;
        gap: 4px;
      }
      .brand-title {
        font-size: 18px;
        font-weight: 700;
        letter-spacing: -0.01em;
      }
      .brand-subtitle {
        font-size: 12px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.9);
      }
      .sidebar__section {
        display: grid;
        gap: 18px;
      }
      .sidebar label {
        display: grid;
        gap: 8px;
        font-size: 13px;
        color: var(--muted);
      }
      select,
      input,
      textarea {
        font: inherit;
        border-radius: 14px;
        border: 1px solid var(--border);
        background: var(--panel);
        color: var(--fg);
        padding: 10px 14px;
      }
      textarea { resize: vertical; }
      select:focus,
      input:focus,
      textarea:focus {
        outline: 2px solid rgba(76, 110, 245, 0.35);
        outline-offset: 2px;
      }
      .sidebar__nav {
        display: grid;
        gap: 8px;
      }
      .nav-btn {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        border-radius: 14px;
        border: 1px solid transparent;
        background: transparent;
        font-size: 14px;
        color: var(--muted);
        transition: background 0.2s ease, border 0.2s ease, color 0.2s ease;
      }
      .nav-btn.active {
        background: var(--accent-soft);
        border-color: var(--border);
        color: var(--fg);
      }
      .sidebar__footer {
        margin-top: auto;
        display: grid;
        gap: 12px;
        font-size: 13px;
        color: var(--muted);
      }
      .sidebar__footer form { margin: 0; }
      .powered-card {
        margin-top: 4px;
        padding: 16px;
        border-radius: 18px;
        background: radial-gradient(120% 120% at 100% 0%, rgba(76, 110, 245, 0.18), rgba(14, 116, 144, 0.08) 55%, rgba(15, 23, 42, 0.05) 100%);
        border: 1px solid rgba(148, 163, 184, 0.25);
        box-shadow: 0 18px 38px rgba(15, 23, 42, 0.08);
        display: grid;
        gap: 6px;
        text-align: center;
      }
      .powered-card__label {
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.14em;
        color: rgba(148, 163, 184, 0.9);
      }
      .powered-card__brand {
        font-size: 16px;
        font-weight: 600;
        color: var(--fg);
      }
      .powered-card--mobile {
        display: none;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        border-radius: 14px;
        padding: 10px 16px;
        border: 1px solid transparent;
        background: transparent;
        color: inherit;
        font: inherit;
        cursor: pointer;
        transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease;
      }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; }
      .btn--primary {
        background: linear-gradient(135deg, #4c6ef5, #5b8ef9);
        color: #fff;
        box-shadow: 0 18px 40px rgba(76, 110, 245, 0.25);
      }
      .btn--ghost {
        border-color: var(--border);
        background: transparent;
        color: var(--fg);
      }
      .btn--outline {
        border-color: var(--border);
        background: var(--panel);
      }
      .btn--danger {
        border-color: rgba(239, 68, 68, 0.35);
        color: #dc2626;
      }
      :root.dark .btn--danger { color: #fca5a5; }
      header.main-header {
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(18px);
        background: var(--surface);
        border-bottom: 1px solid var(--border);
      }
      .header-inner {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 16px;
        padding: 20px 32px;
      }
      .search-group {
        display: flex;
        flex: 1 1 280px;
        gap: 12px;
        align-items: center;
      }
      .search-group input {
        flex: 1 1 auto;
      }
      .filter-group {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .header-actions {
        margin-left: auto;
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .dropdown {
        position: relative;
      }
      .menu {
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        min-width: 200px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: var(--surface);
        box-shadow: var(--shadow);
        padding: 8px;
        display: grid;
        gap: 6px;
        z-index: 40;
      }
      .menu button,
      .menu a {
        display: flex;
        width: 100%;
        align-items: center;
        justify-content: flex-start;
        gap: 8px;
        padding: 10px 12px;
        border-radius: 12px;
        border: none;
        background: transparent;
        font: inherit;
        color: inherit;
        cursor: pointer;
      }
      .menu button:hover,
      .menu a:hover {
        background: rgba(148, 163, 184, 0.15);
      }
      .theme-toggle {
        position: relative;
        width: 44px;
        height: 44px;
        padding: 0;
        border-color: var(--border);
        background: var(--panel);
        color: var(--fg);
        overflow: hidden;
      }
      .theme-toggle:focus-visible {
        outline: 2px solid rgba(76, 110, 245, 0.45);
        outline-offset: 3px;
      }
      .theme-toggle__icon {
        position: absolute;
        inset: 0;
        margin: auto;
        width: 20px;
        height: 20px;
        opacity: 0;
        transform: scale(0.75) rotate(8deg);
        transition: opacity 0.28s ease, transform 0.28s ease;
      }
      .theme-toggle__icon--sun {
        opacity: 1;
        transform: scale(1);
      }
      .theme-toggle__icon--moon {
        transform: scale(0.8) rotate(-10deg);
      }
      :root.dark .theme-toggle {
        background: rgba(76, 110, 245, 0.16);
        border-color: rgba(99, 102, 241, 0.4);
        color: #f8fafc;
      }
      :root.dark .theme-toggle__icon--sun {
        opacity: 0;
        transform: scale(0.65) rotate(-12deg);
      }
      :root.dark .theme-toggle__icon--moon {
        opacity: 1;
        transform: scale(1);
      }
      main {
        padding: 32px;
        display: grid;
        gap: 28px;
      }
      .summary-grid {
        display: grid;
        gap: 18px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      .summary-card {
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        background: var(--surface);
        padding: 24px;
        box-shadow: var(--shadow);
        display: grid;
        gap: 10px;
      }
      .summary-card small { color: var(--muted); }
      .summary-card strong { font-size: 28px; letter-spacing: -0.02em; }
      .content-grid {
        display: grid;
        gap: 24px;
      }
      @media (min-width: 1200px) {
        .content-grid.two-column {
          grid-template-columns: minmax(0, 2.1fr) minmax(0, 1fr);
        }
      }
      .panel {
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        background: var(--surface);
        box-shadow: var(--shadow);
        padding: 24px;
        display: grid;
        gap: 20px;
      }
      .panel--flush { padding: 0; }
      .panel__header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .panel__header h2 {
        margin: 0;
        font-size: 20px;
        letter-spacing: -0.02em;
      }
      .panel__meta { color: var(--muted); font-size: 13px; }
      .inventory-list {
        display: grid;
        border-radius: var(--radius-lg);
        overflow: hidden;
        border: 1px solid var(--border);
      }
      .inventory-item {
        padding: 20px 24px;
        border-bottom: 1px solid var(--border);
        display: grid;
        gap: 18px;
        background: var(--panel);
      }
      .inventory-item:last-child { border-bottom: none; }
      .inventory-item.low {
        border-left: 4px solid rgba(239, 68, 68, 0.6);
        background: rgba(239, 68, 68, 0.08);
      }
      :root.dark .inventory-item.low {
        background: rgba(239, 68, 68, 0.15);
      }
      .item-top {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: space-between;
        align-items: flex-start;
      }
      .item-name {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        letter-spacing: -0.01em;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid rgba(239, 68, 68, 0.35);
        color: #dc2626;
        background: rgba(239, 68, 68, 0.12);
      }
      :root.dark .badge { color: #fca5a5; }
      .chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 2px 10px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(148, 163, 184, 0.14);
        color: var(--muted);
        font-size: 12px;
        font-weight: 600;
        line-height: 1.4;
        white-space: nowrap;
      }
      .chip.success {
        border-color: rgba(16, 185, 129, 0.35);
        background: rgba(16, 185, 129, 0.16);
        color: #047857;
      }
      .chip.danger {
        border-color: rgba(239, 68, 68, 0.28);
        background: rgba(239, 68, 68, 0.16);
        color: #b91c1c;
      }
      .chip.warning {
        border-color: rgba(245, 158, 11, 0.35);
        background: rgba(245, 158, 11, 0.16);
        color: #92400e;
      }
      .chip.accent {
        border-color: rgba(76, 110, 245, 0.45);
        background: rgba(76, 110, 245, 0.18);
        color: var(--accent);
      }
      .chip.neutral {
        border-color: rgba(148, 163, 184, 0.4);
        background: rgba(148, 163, 184, 0.18);
        color: var(--muted);
      }
      :root.dark .chip.success { color: #34d399; }
      :root.dark .chip.danger { color: #fca5a5; }
      :root.dark .chip.warning { color: #fbbf24; }
      :root.dark .chip.accent { color: #8da2fb; }
      .quantity-chip {
        border-radius: 999px;
        border: 1px solid rgba(76, 110, 245, 0.35);
        padding: 6px 12px;
        font-size: 14px;
        background: rgba(76, 110, 245, 0.12);
        color: var(--fg);
      }
      .item-details {
        display: grid;
        gap: 6px;
        font-size: 13px;
        color: var(--muted);
      }
      .inventory-form {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
      .inventory-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }
      .inventory-actions form {
        margin: 0;
        display: inline-flex;
      }
      .inventory-form label {
        display: grid;
        gap: 8px;
        font-size: 12px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .inventory-form .actions {
        grid-column: 1 / -1;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: flex-end;
      }
      .pagination {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
        font-size: 13px;
        color: var(--muted);
      }
      .pagination form { display: flex; align-items: center; gap: 6px; }
      .pagination select { padding: 8px 12px; }
      .timeline-header {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .timeline-header__main {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .timeline-header__title {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .timeline-header__meta {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
        font-size: 13px;
        color: var(--muted);
      }
      .timeline-actions {
        display: inline-flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }
      .timeline-actions form {
        margin: 0;
        display: inline-flex;
      }
      .timeline-toolbar {
        display: grid;
        gap: 12px;
      }
      .timeline-filters {
        display: grid;
        gap: 10px;
      }
      .timeline-filters form {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
      }
      .timeline-filters label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--muted);
        width: 100%;
      }
      .timeline-filters select {
        flex: 1 1 160px;
        min-width: 0;
        padding: 8px 12px;
      }
      .timeline-pagination {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        font-size: 13px;
        color: var(--muted);
      }
      .timeline-pagination__buttons {
        display: flex;
        gap: 6px;
      }
      .timeline-list {
        display: grid;
        gap: 16px;
      }
      .timeline-item {
        display: grid;
        gap: 10px;
        padding: 16px 18px;
        border-radius: 16px;
        border: 1px solid var(--border);
        background: var(--panel);
      }
      .timeline-item__marker {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        font-size: 12px;
        color: var(--muted);
      }
      .timeline-item__content {
        display: grid;
        gap: 8px;
      }
      .timeline-item__title {
        font-weight: 600;
      }
      .timeline-item__meta {
        font-size: 13px;
        color: var(--muted);
      }
      .timeline-item__details {
        font-size: 13px;
        color: inherit;
      }
      .timeline-item__list {
        margin: 0;
        padding-left: 18px;
      }
      .timeline-badge {
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 10px;
      }
      .timeline-item__time {
        font-size: 12px;
        color: var(--muted);
      }
      .timeline-badge.success { background: rgba(16, 185, 129, 0.12); color: #047857; border: 1px solid rgba(16,185,129,0.28); }
      .timeline-badge.danger { background: rgba(239, 68, 68, 0.12); color: #b91c1c; border: 1px solid rgba(239,68,68,0.28); }
      .timeline-badge.neutral { background: rgba(148, 163, 184, 0.12); color: var(--muted); border: 1px solid rgba(148,163,184,0.3); }
      :root.dark .timeline-badge.success { color: #34d399; }
      :root.dark .timeline-badge.danger { color: #fca5a5; }
      .timeline-demo-chip {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(76, 110, 245, 0.12);
        color: var(--accent);
        font-size: 12px;
      }
      .timeline-demo-banner {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        padding: 12px 16px;
        border-radius: 14px;
        background: rgba(76, 110, 245, 0.08);
        color: var(--muted);
        font-size: 13px;
      }
      .timeline-demo-banner strong {
        color: var(--accent);
      }
      @media (min-width: 720px) {
        .timeline-toolbar {
          gap: 20px;
        }
        .timeline-filters {
          display: flex;
          flex-wrap: wrap;
          align-items: center;
          gap: 16px;
        }
        .timeline-filters form {
          flex: 0 1 220px;
        }
      }
      @media (min-width: 960px) {
        .timeline-header {
          flex-direction: row;
          align-items: center;
          justify-content: space-between;
          gap: 24px;
        }
        .timeline-header__main {
          flex-direction: row;
          align-items: baseline;
          gap: 18px;
        }
        .timeline-header__title {
          flex-direction: column;
          gap: 6px;
        }
        .timeline-actions {
          margin-left: auto;
          flex-wrap: nowrap;
          gap: 10px;
        }
        .timeline-actions form {
          width: auto;
        }
        .timeline-toolbar {
          grid-template-columns: minmax(0, 1fr) auto;
          align-items: flex-end;
          gap: 12px 16px;
        }
        .timeline-filters {
          display: inline-flex;
          flex-wrap: wrap;
          align-items: flex-end;
          gap: 12px;
        }
        .timeline-filters form {
          flex: 0 0 auto;
        }
        .timeline-filters label {
          width: auto;
          gap: 6px;
        }
        .timeline-pagination {
          justify-content: flex-end;
          gap: 12px;
        }
      }
      @media (min-width: 640px) {
        .timeline-item {
          grid-template-columns: auto 1fr;
          align-items: flex-start;
        }
        .timeline-item__marker {
          flex-direction: column;
          align-items: flex-start;
        }
      }
      .alert-stack {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(239, 68, 68, 0.35);
        background: rgba(239, 68, 68, 0.12);
        padding: 20px;
        display: grid;
        gap: 12px;
      }
      :root.dark .alert-stack {
        background: rgba(239, 68, 68, 0.18);
      }
      .alert-stack h3 { margin: 0; font-size: 18px; }
      .alert-stack ul { margin: 0; padding-left: 18px; color: #b91c1c; }
      :root.dark .alert-stack ul { color: #fca5a5; }
      .modal {
        position: fixed;
        inset: 0;
        z-index: 60;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .modal.flex { display: flex; }
      .modal::before {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        backdrop-filter: blur(12px);
      }
      .modal__dialog {
        position: relative;
        z-index: 1;
        width: min(720px, 100%);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border);
        background: var(--surface);
        box-shadow: var(--shadow);
        padding: 28px;
        display: grid;
        gap: 20px;
      }
      #importPreviewModal .modal__dialog {
        max-height: min(92vh, 760px);
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .import-preview__content {
        flex: 1 1 auto;
        min-height: 0;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .import-preview__table-wrapper {
        flex: 1 1 auto;
        min-height: 0;
        overflow: auto;
        border: 1px solid var(--border);
        border-radius: 18px;
        background: var(--panel);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05);
        max-height: clamp(240px, 60vh, 440px);
      }
      .import-preview__table-wrapper::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      .import-preview__table-wrapper::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.4);
        border-radius: 999px;
      }
      :root.dark .import-preview__table-wrapper::-webkit-scrollbar-thumb {
        background: rgba(148, 163, 184, 0.3);
      }
      #importPreviewTable {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 13px;
        min-width: 560px;
      }
      #importPreviewTable thead th {
        position: sticky;
        top: 0;
        background: rgba(148, 163, 184, 0.16);
        backdrop-filter: blur(4px);
        border-bottom: 1px solid var(--border);
        padding: 12px 16px;
        font-weight: 600;
        letter-spacing: 0.01em;
      }
      :root.dark #importPreviewTable thead th {
        background: rgba(30, 41, 59, 0.82);
      }
      #importPreviewTable tbody tr {
        transition: background 0.18s ease;
      }
      #importPreviewTable tbody tr:hover td {
        background: rgba(148, 163, 184, 0.12);
      }
      #importPreviewTable tbody td {
        padding: 14px 16px;
        vertical-align: top;
        border-bottom: 1px solid var(--border);
      }
      #importPreviewTable tbody tr:last-child td {
        border-bottom: none;
      }
      .import-preview__row td:first-child {
        border-left: 4px solid transparent;
      }
      .import-preview__row.is-new td:first-child {
        border-left-color: rgba(16, 185, 129, 0.85);
      }
      .import-preview__row.is-updated td:first-child {
        border-left-color: rgba(76, 110, 245, 0.8);
      }
      .import-preview__row.is-invalid td:first-child {
        border-left-color: rgba(239, 68, 68, 0.85);
      }
      .import-preview__row.is-invalid td {
        background: rgba(239, 68, 68, 0.08);
      }
      :root.dark .import-preview__row.is-invalid td {
        background: rgba(239, 68, 68, 0.18);
      }
      .import-preview__name {
        font-weight: 600;
        letter-spacing: -0.01em;
      }
      .import-preview__name--missing {
        color: #b91c1c;
      }
      :root.dark .import-preview__name--missing {
        color: #fca5a5;
      }
      .import-preview__meta {
        margin-top: 4px;
        font-size: 12px;
        color: var(--muted);
      }
      .import-preview__value {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-variant-numeric: tabular-nums;
      }
      .import-preview__arrow {
        opacity: 0.55;
      }
      .import-preview__status {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .import-preview__messages {
        display: grid;
        gap: 8px;
      }
      .import-preview__message {
        border-radius: 12px;
        border: 1px solid rgba(239, 68, 68, 0.25);
        background: rgba(239, 68, 68, 0.12);
        color: #b91c1c;
        padding: 8px 10px;
        font-size: 12px;
        line-height: 1.5;
      }
      :root.dark .import-preview__message {
        background: rgba(239, 68, 68, 0.24);
        color: #fca5a5;
      }
      .import-preview__muted {
        color: var(--muted);
        font-size: 12px;
      }
      .import-preview__summary-line {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 13px;
      }
      .import-preview__hint {
        margin-top: 6px;
        font-size: 12px;
        color: var(--muted);
      }
      .import-preview__empty {
        padding: 28px 16px;
        text-align: center;
        color: var(--muted);
      }
      @media (max-width: 640px) {
        #importPreviewTable {
          font-size: 12px;
          min-width: 520px;
        }
        #importPreviewTable thead th,
        #importPreviewTable tbody td {
          padding: 12px 14px;
        }
      }
      .modal__close {
        position: absolute;
        top: 16px;
        right: 16px;
        border: none;
        background: transparent;
        color: var(--muted);
        font-size: 18px;
        cursor: pointer;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      th, td {
        text-align: left;
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
      }
      thead { background: rgba(148, 163, 184, 0.18); }
      .toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 70;
      }
      .toast__body {
        border-radius: 14px;
        background: rgba(16, 185, 129, 0.95);
        color: #fff;
        padding: 14px 18px;
        box-shadow: var(--shadow);
        font-size: 14px;
      }
      .mobile-only {
        display: none;
        width: 100%;
        gap: 12px;
      }
      .mobile-only > * {
        width: 100%;
      }
      .mobile-search {
        display: flex;
        gap: 12px;
      }
      .mobile-filters {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      .mobile-filters select {
        flex: 1 1 auto;
      }
      .mobile-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .desktop-only {}
      @media (max-width: 960px) {
        .app-shell { grid-template-columns: 1fr; }
        .sidebar {
          position: static;
          height: auto;
          border-right: none;
          border-bottom: 1px solid var(--border);
          box-shadow: none;
          padding: 24px;
        }
        header.main-header { position: static; }
        .header-inner { padding: 20px 24px; }
        main { padding: 24px; }
        .mobile-only { display: grid; }
        .desktop-only { display: none !important; }
        .powered-card--desktop { display: none; }
        .powered-card--mobile {
          display: grid;
          margin: 32px 24px;
        }
      }
      @media (max-width: 640px) {
        .search-group { flex-direction: column; align-items: stretch; }
        .header-actions { width: 100%; justify-content: flex-end; gap: 10px; }
        .filter-group { width: 100%; }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <div class="sidebar__brand">
          <div class="brand-logo">
              <svg viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" role="img" focusable="false">
                <!-- 云主体 -->
                <path d="M10.5 23a6.5 6.5 0 0 1 0-13 7 7 0 0 1 13.2 2.2A5.3 5.3 0 0 1 24 23H10.5Z" fill="currentColor" fill-opacity=".05"/>
                <path d="M10.5 23a6.5 6.5 0 0 1 0-13 7 7 0 0 1 13.2 2.2A5.3 5.3 0 0 1 24 23H10.5Z"/>

                <!-- 内部高光线 -->
                <path d="M8 18c1.2-2 3.8-3 6.5-3s5.3 1 7.2 2.8" opacity=".25"/>

                <!-- 云底阴影 -->
                <ellipse cx="16" cy="24.5" rx="7" ry="1.2" fill="currentColor" fill-opacity=".06" stroke="none"/>
              </svg>
            </div>
          <div class="brand-meta">
            <span class="brand-title">星选送</span>
            <span class="brand-subtitle">智慧运营管理系统</span>
          </div>
        </div>
        <div class="sidebar__section">
          <form method="post" action="{{ url_for('select_store') }}">
            <input type="hidden" name="next" value="{{ request.full_path }}" />
            <label>
              当前门店
              <select name="store_id" onchange="this.form.submit()">
                {% for store_id, store in stores.items() %}
                  <option value="{{ store_id }}" {% if store_id == selected_store %}selected{% endif %}>
                    {{ store.name }}{% if store.items_count %}（{{ store.items_count }}）{% endif %}
                  </option>
                {% endfor %}
              </select>
            </label>
          </form>
          {% if permissions.can_manage_stores %}
            <button class="btn btn--outline" data-open-modal="#storeModal">管理门店</button>
          {% endif %}
        </div>
        <nav class="sidebar__nav">
          <a class="nav-btn" href="{{ url_for('index') }}">库存总览</a>
          {% if permissions.can_view_history %}
            <a class="nav-btn active" href="{{ url_for('recent_activity') }}">最近动态</a>
            <a class="nav-btn" href="{{ url_for('analytics_dashboard') }}">出入库统计</a>
          {% endif %}
          {% if permissions.can_manage_users %}
            <a class="nav-btn" href="{{ url_for('manage_users') }}">用户管理</a>
          {% endif %}
        </nav>
        <div class="sidebar__footer">
          <div>当前账号：<strong>{{ current_user.username }}</strong></div>
          <div>角色：{{ role_labels.get(current_user.role, current_user.role) }}</div>
          <form method="post" action="{{ url_for('logout') }}">
            <button type="submit" class="btn btn--ghost" style="padding:8px 14px;">退出登录</button>
          </form>
          <div class="powered-card powered-card--desktop">
            <span class="powered-card__label">Powered by</span>
            <span class="powered-card__brand">OnmiCloud</span>
          </div>
        </div>
      </aside>
      <div class="main">
        <header class="main-header">
          <div class="header-inner">
            <div style="display:flex; flex-direction:column; gap:6px;">
              <h1 style="margin:0; font-size:26px; letter-spacing:-0.02em;">最近动态</h1>
              <div class="panel__meta">门店：{{ stores[selected_store]['name'] }}</div>
            </div>
            <div class="header-actions">
              <div class="dropdown">
                <button id="userMenuBtn" class="btn btn--outline" aria-haspopup="menu" aria-expanded="false">{{ current_user.username }}</button>
                <div id="userMenu" class="menu hidden">
                  <div class="panel__meta" style="padding:10px 12px;">{{ current_user.username }} · {{ role_labels.get(current_user.role, current_user.role) }}</div>
                  <a href="{{ url_for('index') }}">库存总览</a>
                  {% if permissions.can_view_history %}
                    <a href="{{ url_for('analytics_dashboard') }}">出入库统计</a>
                  {% endif %}
                  {% if permissions.can_manage_users %}
                    <a href="{{ url_for('manage_users') }}">用户管理</a>
                  {% endif %}
                  <form method="post" action="{{ url_for('logout') }}" style="margin:0;">
                    <button type="submit">退出登录</button>
                  </form>
                </div>
              </div>
              <button id="themeToggle" class="btn theme-toggle" type="button" aria-label="切换深浅色" aria-pressed="false">
                <svg class="theme-toggle__icon theme-toggle__icon--sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="12" cy="12" r="5" />
                  <path d="M12 2v2.5M12 19.5V22M4.22 4.22l1.77 1.77M17.99 17.99l1.79 1.79M2 12h2.5M19.5 12H22M4.22 19.78l1.77-1.77M17.99 6.01l1.79-1.79" />
                </svg>
                <svg class="theme-toggle__icon theme-toggle__icon--moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M21 14.25A7.25 7.25 0 0110.75 4a6.25 6.25 0 000 12.5A7.25 7.25 0 0121 14.25z" />
                </svg>
              </button>
            </div>
          </div>
        </header>
        <main>
          <section class="panel timeline-panel">
            <header class="timeline-header">
              <div class="timeline-header__main">
                <div class="timeline-header__title">
                  <h2>出入库动态</h2>
                </div>
                <div class="timeline-header__meta">
                  <span>共 {{ timeline_pagination.total }} 条</span>
                  {% if timeline_is_demo %}
                    <span class="timeline-demo-chip">演示数据</span>
                  {% endif %}
                </div>
              </div>
              <div class="timeline-actions">
                <a class="btn btn--outline" href="/api/history/export">导出记录</a>
                {% if permissions.can_clear_history %}
                  <form method="post" action="{{ url_for('clear_history') }}" onsubmit="return confirm('确认清除全部最近动态记录？');">
                    <input type="hidden" name="next" value="{{ request.full_path }}" />
                    <button type="submit" class="btn btn--danger">清除记录</button>
                  </form>
                {% endif %}
              </div>
            </header>
            <div class="timeline-toolbar">
              <div class="timeline-filters">
                <form method="get" action="{{ url_for('recent_activity') }}">
                  {% for key, values in preserved_query.items() %}
                    {% if key not in ['timeline_sku', 'timeline_page'] %}
                      {% for value in values %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}" />
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                  <input type="hidden" name="timeline_page" value="1" />
                  <label>筛选 SKU
                    <select name="timeline_sku" onchange="this.form.submit()">
                      <option value="" {% if not timeline_sku %}selected{% endif %}>全部</option>
                      {% for name in timeline_sku_options %}
                        <option value="{{ name }}" {% if timeline_sku == name %}selected{% endif %}>{{ name }}</option>
                      {% endfor %}
                    </select>
                  </label>
                </form>
                <form method="get" action="{{ url_for('recent_activity') }}">
                  {% for key, values in preserved_query.items() %}
                    {% if key not in ['timeline_per_page', 'timeline_page'] %}
                      {% for value in values %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}" />
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                  <input type="hidden" name="timeline_page" value="1" />
                  <label>每页
                    <select name="timeline_per_page" onchange="this.form.submit()">
                      {% for option in [5, 10, 20, 50] %}
                        <option value="{{ option }}" {% if timeline_pagination.per_page == option %}selected{% endif %}>{{ option }}</option>
                      {% endfor %}
                    </select>
                  </label>
                </form>
              </div>
              <div class="timeline-pagination">
                <span>第 {{ timeline_pagination.start_index or 0 }}-{{ timeline_pagination.end_index or 0 }} / {{ timeline_pagination.total }} 条</span>
                <div class="timeline-pagination__buttons">
                  <a href="{{ timeline_pagination.has_prev and build_query(timeline_page=timeline_pagination.prev_page) or '#' }}" class="btn btn--outline" style="padding:8px 12px; {% if not timeline_pagination.has_prev %}pointer-events:none; opacity:0.4;{% endif %}">上一页</a>
                  <a href="{{ timeline_pagination.has_next and build_query(timeline_page=timeline_pagination.next_page) or '#' }}" class="btn btn--outline" style="padding:8px 12px; {% if not timeline_pagination.has_next %}pointer-events:none; opacity:0.4;{% endif %}">下一页</a>
                </div>
              </div>
            </div>
            {% if timeline_is_demo %}
              <div class="timeline-demo-banner">
                <strong>提示</strong>
                <span>暂无真实的出入库记录，以下为示例动态，方便你在桌面端快速检查布局与间距效果。</span>
              </div>
            {% endif %}
            <div class="timeline-list">
              {% if timeline %}
                {% for event in timeline %}
                  <article class="timeline-item">
                    <div class="timeline-item__marker">
                      <span class="timeline-badge {% if event.badge == 'success' %}success{% elif event.badge == 'danger' %}danger{% else %}neutral{% endif %}">{{ event.type }}</span>
                      <time class="timeline-item__time" datetime="{{ event.timestamp.isoformat() if event.timestamp is not none else '' }}">{{ event.timestamp|format_datetime('%Y-%m-%d %H:%M') }}</time>
                    </div>
                    <div class="timeline-item__content">
                      <div class="timeline-item__title">{{ event.name }}</div>
                      <div class="timeline-item__meta">操作人：{{ event.user }}</div>
                      {% if event.details %}
                        {% if event.details is string %}
                          <div class="timeline-item__details">{{ event.details }}</div>
                        {% else %}
                          <ul class="timeline-item__details timeline-item__list">
                            {% for detail in event.details %}
                              <li>{{ detail }}</li>
                            {% endfor %}
                          </ul>
                        {% endif %}
                      {% endif %}
                    </div>
                  </article>
                {% endfor %}
              {% else %}
                <div class="panel__meta" style="text-align:center; padding:32px;">当前暂无出入库记录，开始第一次操作后即可在此查看。</div>
              {% endif %}
            </div>
          </section>
        </main>
      </div>
    </div>

    <div class="powered-card powered-card--mobile">
      <span class="powered-card__label">Powered by</span>
      <span class="powered-card__brand">OnmiCloud</span>
    </div>

    <div id="storeModal" class="modal hidden" data-modal>
      <div class="modal__dialog" style="max-width:520px;">
        <button type="button" class="modal__close" data-close-modal>&times;</button>
        <h2 style="margin:0; font-size:22px;">门店管理</h2>
        <form method="post" action="{{ url_for('create_store_route') }}" class="inventory-form">
          <label>新增门店名称<input name="name" placeholder="例如：旗舰店" required /></label>
          <div class="actions" style="justify-content:flex-end;">
            <button type="submit" class="btn btn--primary">新增门店</button>
          </div>
        </form>
        <div class="panel__meta">现有门店</div>
        <div class="timeline-list">
          {% for store_id, store in stores.items() %}
            <div class="timeline-item" style="gap:10px;">
              <div style="font-weight:600;">{{ store.name }}</div>
              <div class="panel__meta">SKU 数量：{{ store.items_count }}</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                <form method="post" action="{{ url_for('delete_store_route', store_id=store_id) }}" onsubmit="return confirm('确认删除 {{ store.name }} 吗？');">
                  <button type="submit" class="btn btn--danger">删除</button>
                </form>
                <form method="post" action="{{ url_for('delete_store_route', store_id=store_id) }}" onsubmit="return confirm('确认删除 {{ store.name }} 并清空其库存吗？');">
                  <input type="hidden" name="cascade" value="1" />
                  <button type="submit" class="btn btn--danger">连同库存删除</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <script>
      const root = document.documentElement;
      const themeToggleBtn = document.getElementById('themeToggle');
      const getTheme = () => localStorage.getItem('theme');
      const setTheme = t => localStorage.setItem('theme', t);
      const syncThemeToggle = theme => {
        if (!themeToggleBtn) return;
        themeToggleBtn.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
        themeToggleBtn.dataset.theme = theme;
      };
      const applyTheme = theme => {
        root.classList.toggle('dark', theme === 'dark');
        syncThemeToggle(theme);
      };
      const initTheme = () => {
        const storedTheme = getTheme();
        if (storedTheme) {
          applyTheme(storedTheme);
        } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          applyTheme('dark');
        }
      };
      initTheme();
      syncThemeToggle(root.classList.contains('dark') ? 'dark' : 'light');
      themeToggleBtn?.addEventListener('click', () => {
        const nextTheme = root.classList.contains('dark') ? 'light' : 'dark';
        applyTheme(nextTheme);
        setTheme(nextTheme);
      });

      function openModal(selector){
        const modal = document.querySelector(selector);
        if(!modal) return;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }
      function closeModal(selector){
        const modal = document.querySelector(selector);
        if(!modal) return;
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
      const modalElements = document.querySelectorAll('[data-modal]');
      document.querySelectorAll('[data-open-modal]')?.forEach(btn => {
        const target = btn.getAttribute('data-open-modal');
        if(!target) return;
        btn.addEventListener('click', () => openModal(target));
      });
      document.querySelectorAll('[data-close-modal]')?.forEach(btn => {
        btn.addEventListener('click', () => {
          const modal = btn.closest('[data-modal]');
          if(modal?.id) closeModal(`#${modal.id}`);
        });
      });
      modalElements.forEach(modal => {
        modal.addEventListener('click', event => {
          if(event.target === modal) closeModal(`#${modal.id}`);
        });
      });

      (function setupManageModal(){
        const manageModal = document.getElementById('manageModal');
        if(!manageModal) return;
        const manageButtons = document.querySelectorAll('[data-manage]');
        if(!manageButtons.length) return;
        const nameInput = document.getElementById('manageName');
        const quantityInput = document.getElementById('manageQuantity');
        const unitInput = document.getElementById('manageUnit');
        const thresholdInput = document.getElementById('manageThreshold');
        const categorySelect = document.getElementById('manageCategory');
        const summary = document.getElementById('manageSummary');
        manageButtons.forEach(button => {
          button.addEventListener('click', () => {
            const name = button.getAttribute('data-name') || '';
            const unit = button.getAttribute('data-unit') || '';
            const quantity = button.getAttribute('data-quantity') || '';
            const threshold = button.getAttribute('data-threshold') || '';
            const category = button.getAttribute('data-category') || '';
            const categoryName = button.getAttribute('data-category-name') || '未分类';
            if(nameInput) {
              nameInput.value = name;
            }
            if(quantityInput) {
              quantityInput.value = quantity;
              const placeholderUnit = unit ? ` ${unit}` : '';
              quantityInput.placeholder = quantity
                ? `当前 ${quantity}${placeholderUnit}`
                : '请输入数量';
            }
            if(unitInput) {
              unitInput.value = unit;
            }
            if(thresholdInput) {
              thresholdInput.value = threshold;
            }
            if(categorySelect) {
              let matched = false;
              Array.from(categorySelect.options).forEach(option => {
                if(option.value === category) {
                  option.selected = true;
                  matched = true;
                }
              });
              if(!matched && categorySelect.options.length) {
                categorySelect.selectedIndex = 0;
              }
            }
            if(summary) {
              const unitSuffix = unit ? ` ${unit}` : '';
              const quantityText = quantity !== '' ? quantity : '0';
              summary.textContent = `${name} · 当前库存 ${quantityText}${unitSuffix} · 分类：${categoryName}`;
            }
            openModal('#manageModal');
            setTimeout(() => {
              quantityInput?.focus();
            }, 120);
          });
        });
      })();

      (function setupAdjustModal(){
        const adjustModal = document.getElementById('adjustModal');
        const adjustButtons = document.querySelectorAll('[data-adjust]');
        const adjustActionInput = document.getElementById('adjustAction');
        const adjustNameInput = document.getElementById('adjustName');
        const adjustQuantityInput = document.getElementById('adjustQuantity');
        const adjustInfo = document.getElementById('adjustModalInfo');
        const adjustTitle = document.getElementById('adjustModalTitle');
        const adjustQuantityLabel = document.getElementById('adjustQuantityLabel');
        const adjustSubmitBtn = document.getElementById('adjustSubmitBtn');
        if(!adjustModal || !adjustButtons.length || !adjustActionInput || !adjustNameInput || !adjustQuantityInput || !adjustInfo || !adjustTitle || !adjustQuantityLabel || !adjustSubmitBtn){
          return;
        }
        adjustButtons.forEach(button => {
          button.addEventListener('click', () => {
            const action = button.getAttribute('data-adjust') || 'in';
            const name = button.getAttribute('data-name') || '';
            const unit = button.getAttribute('data-unit') || '';
            const current = Number(button.getAttribute('data-current') || '0');
            const isOut = action === 'out';
            adjustActionInput.value = action;
            adjustNameInput.value = name;
            adjustQuantityInput.value = '';
            adjustQuantityInput.min = 1;
            if(isOut && current > 0){
              adjustQuantityInput.setAttribute('max', String(current));
            } else {
              adjustQuantityInput.removeAttribute('max');
            }
            const disable = isOut && current === 0;
            adjustQuantityInput.disabled = disable;
            adjustSubmitBtn.disabled = disable;
            adjustQuantityInput.placeholder = isOut ? '请输入出库数量' : '请输入入库数量';
            adjustTitle.textContent = isOut ? '出库' : '入库';
            adjustQuantityLabel.textContent = isOut ? '出库数量' : '入库数量';
            adjustSubmitBtn.textContent = isOut ? '确认出库' : '确认入库';
            const unitSuffix = unit ? ' ' + unit : '';
            let infoText = `${name} · 当前库存 ${current}${unitSuffix}`;
            if(disable){
              infoText += ' · 当前库存不足以出库';
            }
            adjustInfo.textContent = infoText;
            openModal('#adjustModal');
            setTimeout(() => {
              if(!adjustQuantityInput.disabled){
                adjustQuantityInput.focus();
              }
            }, 120);
          });
        });
      })();

      (function setupTransferModal(){
        const transferModal = document.getElementById('transferModal');
        if(!transferModal) return;
        const transferButtons = document.querySelectorAll('[data-transfer]');
        if(!transferButtons.length) return;
        const transferNameInput = document.getElementById('transferName');
        const transferSourceInput = document.getElementById('transferSourceStore');
        const transferTargetSelect = document.getElementById('transferTargetStore');
        const transferQuantityInput = document.getElementById('transferQuantity');
        const transferInfo = document.getElementById('transferInfo');
        const transferSubmitBtn = document.getElementById('transferSubmitBtn');
        transferButtons.forEach(button => {
          button.addEventListener('click', () => {
            const name = button.getAttribute('data-name') || '';
            const unit = button.getAttribute('data-unit') || '';
            const current = Number(button.getAttribute('data-current') || '0');
            const storeId = button.getAttribute('data-store') || '';
            const storeName = button.getAttribute('data-store-name') || '';
            transferNameInput.value = name;
            transferSourceInput.value = storeId;
            let firstAvailable = null;
            Array.from(transferTargetSelect.options).forEach(option => {
              const isSame = option.value === storeId;
              option.disabled = isSame;
              if(isSame && option.selected){
                option.selected = false;
              }
              if(!isSame && !firstAvailable){
                firstAvailable = option;
              }
            });
            if((!transferTargetSelect.value || transferTargetSelect.options[transferTargetSelect.selectedIndex]?.disabled) && firstAvailable){
              firstAvailable.selected = true;
            }
            transferQuantityInput.value = '';
            const unitSuffix = unit ? ` ${unit}` : '';
            let infoText = `${name} · 当前库存 ${current}${unitSuffix}`;
            if(storeName){
              infoText += ` · 调出门店：${storeName}`;
            }
            if(current > 0){
              transferQuantityInput.max = String(current);
              transferQuantityInput.disabled = false;
              transferSubmitBtn.disabled = false;
              transferQuantityInput.placeholder = `最多可调拨 ${current}${unitSuffix}`.trim();
            } else {
              transferQuantityInput.removeAttribute('max');
              transferQuantityInput.disabled = true;
              transferSubmitBtn.disabled = true;
              transferQuantityInput.placeholder = '当前库存不足，无法调拨';
            }
            transferInfo.textContent = infoText;
            openModal('#transferModal');
            setTimeout(() => {
              if(!transferQuantityInput.disabled){
                transferQuantityInput.focus();
              }
            }, 120);
          });
        });
      })();

      const toast = document.getElementById('toast');
      let toastTimer = null;
      function showToast(){
        if(!toast) return;
        toast.classList.remove('hidden');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => {
          toast.classList.add('hidden');
        }, 2400);
      }

      const fileInput = document.getElementById('importFile');
      const importForm = document.getElementById('importForm');
      const importStoreInput = document.getElementById('importStoreId');
      const importPreviewModal = document.getElementById('importPreviewModal');
      const importPreviewStatus = document.getElementById('importPreviewStatus');
      const importPreviewTable = document.getElementById('importPreviewTable');
      const importPreviewSummary = document.getElementById('importPreviewSummary');
      const importPreviewConfirm = document.getElementById('importPreviewConfirm');
      const importPreviewCancel = document.getElementById('importPreviewCancel');
      const importPreviewClose = document.getElementById('importPreviewClose');
      const importTriggers = [document.getElementById('importTrigger'), document.getElementById('importTriggerM')].filter(Boolean);
      let pendingImportFile = null;

      function renderPreviewRows(rows, options = {}){
        if(!importPreviewTable) return;
        const escapeHtml = (value) => String(value ?? '').replace(/[&<>"']/g, (match) => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
        })[match]);
        const formatDisplay = (value, emptyLabel = '未填写') => {
          const text = value === undefined || value === null ? '' : String(value);
          if(text.trim() === ''){
            return `<span class="import-preview__muted">${escapeHtml(emptyLabel)}</span>`;
          }
          return escapeHtml(text);
        };
        const toNumber = (value) => {
          if(typeof value === 'number' && !Number.isNaN(value)){
            return value;
          }
          if(typeof value === 'string'){
            const trimmed = value.trim();
            if(trimmed !== ''){
              const parsed = Number(trimmed);
              if(!Number.isNaN(parsed)){
                return parsed;
              }
            }
          }
          return null;
        };
        const emptyText = options.emptyText || '暂无可预览数据';
        if(!rows.length){
          importPreviewTable.innerHTML = `<tbody><tr><td class="import-preview__empty" colspan="5">${escapeHtml(emptyText)}</td></tr></tbody>`;
          if(importPreviewSummary){
            importPreviewSummary.innerHTML = '';
          }
          if(importPreviewConfirm){
            importPreviewConfirm.disabled = true;
          }
          return;
        }
        const headers = ['SKU / 来源行', '数量调整', '单位', '分类', '识别结果'];
        const stats = { total: rows.length, valid: 0, new: 0, update: 0, unchanged: 0, invalid: 0 };
        const body = rows.map(row => {
          const valid = Boolean(row && row.valid);
          const existing = Boolean(row && row.existing);
          if(valid){
            stats.valid += 1;
          } else {
            stats.invalid += 1;
          }
          const rowClasses = ['import-preview__row'];
          const quantityValue = toNumber(row?.quantity);
          const previousQuantity = toNumber(row?.existing_quantity);
          const deltaValue = toNumber(row?.quantity_delta);
          const unit = row?.unit ?? '';
          const previousUnit = row?.existing_unit ?? '';
          const categoryName = row?.category_name ?? '';
          const previousCategoryName = row?.existing_category_name ?? '';
          const quantityChanged = Boolean(
            row?.quantity_changed ?? (
              existing && quantityValue !== null && previousQuantity !== null && quantityValue !== previousQuantity
            )
          );
          const unitChanged = Boolean(
            row?.unit_changed ?? (existing && (unit || '') !== (previousUnit || ''))
          );
          const categoryChanged = Boolean(
            row?.category_changed ?? (
              existing && (row?.existing_category_id ?? '') !== (row?.category_id ?? '')
            )
          );
          if(!valid){
            rowClasses.push('is-invalid');
          } else if(!existing){
            rowClasses.push('is-new');
            stats.new += 1;
          } else if(quantityChanged || unitChanged || categoryChanged){
            rowClasses.push('is-updated');
            stats.update += 1;
          } else {
            stats.unchanged += 1;
          }
          const indexLabel = row?.index ? `第 ${row.index} 行` : '';
          const nameHtml = row?.name
            ? `<div class="import-preview__name">${escapeHtml(row.name)}</div>`
            : `<div class="import-preview__name import-preview__name--missing">（未填写名称）</div>`;
          const metaParts = [];
          if(indexLabel){
            metaParts.push(indexLabel);
          }
          if(existing){
            metaParts.push('已匹配库存');
          } else if(valid){
            metaParts.push('将创建新库存');
          }
          if(!valid){
            metaParts.push('存在错误');
          }
          const metaHtml = metaParts.length ? `<div class="import-preview__meta">${metaParts.join(' · ')}</div>` : '';
          const quantityCell = (() => {
            if(!valid || quantityValue === null){
              return '<span class="import-preview__muted">—</span>';
            }
            if(!existing){
              const deltaBadge = `<span class="chip success">+${escapeHtml(quantityValue)}</span>`;
              return `<div class="import-preview__value">${escapeHtml(quantityValue)}</div>${deltaBadge}<span class="import-preview__muted">新建库存</span>`;
            }
            const prevText = previousQuantity === null ? escapeHtml('—') : escapeHtml(previousQuantity);
            const nextText = escapeHtml(quantityValue);
            const effectiveDelta = deltaValue !== null
              ? deltaValue
              : (previousQuantity !== null && quantityValue !== null ? quantityValue - previousQuantity : null);
            let deltaBadge = '';
            if(effectiveDelta !== null){
              if(effectiveDelta > 0){
                deltaBadge = `<span class="chip success">+${escapeHtml(effectiveDelta)}</span>`;
              } else if(effectiveDelta < 0){
                deltaBadge = `<span class="chip danger">${escapeHtml(effectiveDelta)}</span>`;
              } else {
                deltaBadge = '<span class="chip neutral">无变化</span>';
              }
            } else if(!quantityChanged){
              deltaBadge = '<span class="chip neutral">无变化</span>';
            }
            const arrow = '<span class="import-preview__arrow">→</span>';
            if(previousQuantity === null){
              return `<div class="import-preview__value">${nextText}</div>${deltaBadge}`;
            }
            return `<div class="import-preview__value">${prevText} ${arrow} ${nextText}</div>${deltaBadge}`;
          })();
          const unitCell = (() => {
            if(!valid){
              return '<span class="import-preview__muted">—</span>';
            }
            if(!existing){
              return `<div class="import-preview__value">${formatDisplay(unit, '未填写')}</div><span class="import-preview__muted">新建设置</span>`;
            }
            if(unitChanged){
              return `<div class="import-preview__value">${formatDisplay(previousUnit, '未设置')} <span class="import-preview__arrow">→</span> ${formatDisplay(unit, '未填写')}</div><span class="chip warning">单位变更</span>`;
            }
            return `<div class="import-preview__value">${formatDisplay(unit, '未填写')}</div>`;
          })();
          const categoryCell = (() => {
            if(!valid){
              return '<span class="import-preview__muted">—</span>';
            }
            const nextLabel = categoryName || '未分类';
            const prevLabel = previousCategoryName || (existing ? '未分类' : '');
            if(!existing){
              return `<div class="import-preview__value">${formatDisplay(nextLabel, '未分类')}</div><span class="import-preview__muted">新建设置</span>`;
            }
            if(categoryChanged){
              return `<div class="import-preview__value">${formatDisplay(prevLabel, '未分类')} <span class="import-preview__arrow">→</span> ${formatDisplay(nextLabel, '未分类')}</div><span class="chip accent">分类变更</span>`;
            }
            return `<div class="import-preview__value">${formatDisplay(nextLabel, '未分类')}</div>`;
          })();
          const changeParts = [];
          if(quantityChanged){
            changeParts.push('数量');
          }
          if(unitChanged){
            changeParts.push('单位');
          }
          if(categoryChanged){
            changeParts.push('分类');
          }
          let statusBadge = '';
          if(!valid){
            statusBadge = '<span class="chip danger">无法导入</span>';
          } else if(!existing){
            statusBadge = '<span class="chip success">新增</span>';
          } else if(quantityChanged || unitChanged || categoryChanged){
            statusBadge = '<span class="chip accent">待更新</span>';
          } else {
            statusBadge = '<span class="chip neutral">保持不变</span>';
          }
          const changeMeta = changeParts.length ? `<div class="import-preview__meta">变更字段：${changeParts.join('、')}</div>` : '';
          const messages = Array.isArray(row?.messages) ? row.messages.filter(message => message) : [];
          const messageHtml = messages.length
            ? `<div class="import-preview__messages">${messages.map(message => `<div class="import-preview__message">${escapeHtml(message)}</div>`).join('')}</div>`
            : '';
          const statusPieces = [statusBadge];
          if(changeMeta){
            statusPieces.push(changeMeta);
          }
          if(messageHtml){
            statusPieces.push(messageHtml);
          }
          const statusCell = `<div class="import-preview__status">${statusPieces.join('')}</div>`;
          return `<tr class="${rowClasses.join(' ')}"><td>${nameHtml}${metaHtml}</td><td>${quantityCell}</td><td>${unitCell}</td><td>${categoryCell}</td><td>${statusCell}</td></tr>`;
        }).join('');
        importPreviewTable.innerHTML = `<thead><tr>${headers.map(title => `<th>${title}</th>`).join('')}</tr></thead><tbody>${body}</tbody>`;
        if(importPreviewSummary){
          const summaryParts = [
            `识别 ${stats.total} 行`,
            `有效 ${stats.valid} 行`,
          ];
          if(stats.new){
            summaryParts.push(`新增 ${stats.new}`);
          }
          if(stats.update){
            summaryParts.push(`更新 ${stats.update}`);
          }
          if(stats.unchanged){
            summaryParts.push(`保持 ${stats.unchanged}`);
          }
          if(stats.invalid){
            summaryParts.push(`异常 ${stats.invalid}`);
          }
          const summaryLine = summaryParts.join(' · ');
          const hint = stats.invalid ? '<div class="import-preview__hint">红色行将被跳过，请修正后重新导入。</div>' : '';
          importPreviewSummary.innerHTML = `<div class="import-preview__summary-line">${summaryLine}</div>${hint}`;
        }
        if(importPreviewConfirm){
          importPreviewConfirm.disabled = stats.valid === 0;
        }
      }

      function setPreviewStatus(message, variant){
        if(!importPreviewStatus) return;
        importPreviewStatus.textContent = message;
        importPreviewStatus.style.color = variant === 'error' ? '#ef4444' : 'var(--muted)';
      }

      function currentStoreId(){
        return importStoreInput?.value || document.querySelector('select[name="store_id"]')?.value || '';
      }

      function syncImportStore(){
        if(!importStoreInput) return;
        importStoreInput.value = currentStoreId();
      }

      function resetImportPreview(){
        if(!importPreviewModal) return;
        closeModal('#importPreviewModal');
        setPreviewStatus('');
        if(importPreviewSummary){
          importPreviewSummary.innerHTML = '';
        }
        renderPreviewRows([], { emptyText: '等待选择文件…' });
        if(importPreviewConfirm){
          importPreviewConfirm.disabled = true;
          importPreviewConfirm.textContent = '确认导入';
        }
        pendingImportFile = null;
        if(fileInput){
          fileInput.value = '';
        }
      }

      syncImportStore();
      const storeSelect = document.querySelector('select[name="store_id"]');
      storeSelect?.addEventListener('change', syncImportStore);
      importPreviewCancel?.addEventListener('click', () => resetImportPreview());
      importPreviewClose?.addEventListener('click', () => resetImportPreview());
      importPreviewModal?.addEventListener('click', event => {
        if(event.target === importPreviewModal){
          resetImportPreview();
        }
      });

      importTriggers.forEach(trigger => {
        trigger.addEventListener('click', () => {
          if(!fileInput){
            return;
          }
          resetImportPreview();
          syncImportStore();
          fileInput.click();
        });
      });

      fileInput?.addEventListener('change', async () => {
        if(!fileInput.files?.length || !importForm){
          return;
        }
        const file = fileInput.files[0];
        pendingImportFile = null;
        syncImportStore();
        openModal('#importPreviewModal');
        setPreviewStatus('正在分析导入文件，请稍候…');
        if(importPreviewSummary){
          importPreviewSummary.innerHTML = '';
        }
        if(importPreviewConfirm){
          importPreviewConfirm.disabled = true;
          importPreviewConfirm.textContent = '确认导入';
        }
        renderPreviewRows([], { emptyText: '正在分析导入文件…' });
        try {
          const formData = new FormData();
          formData.append('file', file);
          const storeId = currentStoreId();
          if(storeId){
            formData.append('store_id', storeId);
          }
          const response = await fetch('/api/items/import/preview', {
            method: 'POST',
            body: formData,
          });
          let data = null;
          try {
            data = await response.json();
          } catch (err) {
            data = null;
          }
          if(!response.ok){
            const message = data && data.error ? data.error : '导入前检查失败';
            throw new Error(message);
          }
          pendingImportFile = file;
          renderPreviewRows(data?.rows || [], { meta: data });
          setPreviewStatus('检查完成，请确认识别结果后继续导入。');
        } catch (error) {
          pendingImportFile = null;
          const message = error instanceof Error ? error.message : '导入前检查失败';
          setPreviewStatus(message, 'error');
          renderPreviewRows([], { emptyText: '未识别到可导入的数据' });
        }
      });

      importPreviewConfirm?.addEventListener('click', () => {
        if(!importPreviewConfirm || importPreviewConfirm.disabled){
          return;
        }
        if(!fileInput?.files?.length || !importForm || !pendingImportFile){
          return;
        }
        setPreviewStatus('正在导入，请稍候…');
        importPreviewConfirm.disabled = true;
        importPreviewConfirm.textContent = '正在导入…';
        syncImportStore();
        if(typeof importForm.requestSubmit === 'function'){
          importForm.requestSubmit();
        } else {
          importForm.submit();
        }
      });

      const menuPairs = [
        { button: document.getElementById('actionsMenuBtn'), menu: document.getElementById('actionsMenu') },
        { button: document.getElementById('userMenuBtn'), menu: document.getElementById('userMenu') }
      ].filter(pair => pair.button && pair.menu);
      function closeMenus(){
        menuPairs.forEach(({ button, menu }) => {
          menu.classList.add('hidden');
          button.setAttribute('aria-expanded', 'false');
        });
      }
      menuPairs.forEach(({ button, menu }) => {
        button.addEventListener('click', (event) => {
          event.stopPropagation();
          const expanded = button.getAttribute('aria-expanded') === 'true';
          closeMenus();
          if(!expanded){
            menu.classList.remove('hidden');
            button.setAttribute('aria-expanded', 'true');
          }
        });
      });
      document.addEventListener('click', closeMenus);
      document.addEventListener('keydown', (event) => {
        if(event.key === 'Escape') closeMenus();
      });

      const thresholdAlert = document.getElementById('thresholdAlert');
      thresholdAlert?.querySelectorAll('[data-close-alert]')?.forEach(el => {
        el.addEventListener('click', () => {
          thresholdAlert.classList.add('hidden');
        });
      });

      const keywordInputs = document.querySelectorAll('[data-keyword-input]');
      function submitKeyword(value){
        const trimmed = value.trim();
        const url = new URL(window.location.href);
        const currentSearch = url.searchParams.get('inventory_search') || '';
        if(trimmed){
          url.searchParams.set('inventory_search', trimmed);
        } else {
          url.searchParams.delete('inventory_search');
        }
        if(trimmed !== currentSearch){
          url.searchParams.set('inventory_page', '1');
        }
        window.location.href = url.toString();
      }
      keywordInputs.forEach(input => {
        input.addEventListener('keydown', event => {
          if(event.key === 'Enter'){
            event.preventDefault();
            submitKeyword(input.value || '');
          }
        });
      });
      document.querySelectorAll('[data-search-button]').forEach(button => {
        const selector = button.getAttribute('data-input-selector');
        button.addEventListener('click', () => {
          const input = selector ? document.querySelector(selector) : null;
          submitKeyword(input?.value || '');
        });
      });

      const categoryFilters = document.querySelectorAll('[data-category-filter]');
      categoryFilters.forEach(select => {
        select.addEventListener('change', () => {
          const url = new URL(window.location.href);
          const value = select.value;
          if(value){
            url.searchParams.set('category', value);
          } else {
            url.searchParams.delete('category');
          }
          url.searchParams.set('inventory_page', '1');
          window.location.href = url.toString();
        });
      });

      const importFormElement = document.getElementById('importForm');
      importFormElement?.addEventListener('submit', () => {
        setTimeout(() => {
          showToast();
        }, 200);
      });
    </script>
  </body>
</html>
