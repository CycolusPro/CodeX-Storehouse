<!doctype html>
<html lang="zh" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>用户管理 · 库存控制中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: ['class'],
        theme: {
          extend: {
            fontFamily: {
              sans: ['ui-sans-serif','-apple-system','BlinkMacSystemFont','Segoe UI','PingFang SC','Hiragino Sans GB','Microsoft Yahei','Helvetica Neue','Arial','Noto Sans CJK SC','sans-serif']
            },
            colors: {
              brand: {
                50: '#F4F6FF',
                100: '#E9EDFF',
                200: '#C7D0FF',
                300: '#A4B4FF',
                400: '#8097FF',
                500: '#5D7BFF',
                600: '#3A5EFF',
                700: '#2447E6',
                800: '#1B34B0',
                900: '#14257F'
              }
            },
            boxShadow: {
              xlsoft: '0 25px 80px rgba(15, 23, 42, .16)'
            }
          }
        }
      }
    </script>
    <style>
      :root { color-scheme: light dark; }
    </style>
  </head>
  <body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 font-sans">
    <header class="sticky top-0 z-30 border-b border-slate-200/60 dark:border-white/10 bg-white/80 dark:bg-slate-900/70 backdrop-blur">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
        <a href="{{ url_for('index') }}" class="flex items-center gap-2 font-semibold">
          <svg class="w-5 h-5 text-brand-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/><path d="M8 6H6a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h2"/></svg>
          返回控制中心
        </a>
        <div class="flex items-center gap-3 text-sm">
          <span class="text-slate-500 dark:text-slate-300">当前账号：<strong>{{ current_user.username }}</strong> · {{ role_labels.get(current_user.role, current_user.role) }}</span>
          <form method="post" action="{{ url_for('logout') }}">
            <button type="submit" class="px-3 py-1 rounded-lg border border-slate-200/60 dark:border-white/10 hover:bg-slate-100/70 dark:hover:bg-white/5">退出</button>
          </form>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-8">
      <div>
        <h1 class="text-2xl font-bold tracking-tight">用户管理</h1>
        <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">在此新增或维护可访问库存系统的账号。</p>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="space-y-2">
            {% for category, message in messages %}
              <div class="px-4 py-3 rounded-xl border text-sm {% if category == 'success' %}border-emerald-300/50 bg-emerald-50 text-emerald-700 dark:border-emerald-500/30 dark:bg-emerald-900/20 dark:text-emerald-200{% else %}border-red-300/50 bg-red-50 text-red-700 dark:border-red-500/30 dark:bg-red-900/20 dark:text-red-200{% endif %}">
                {{ message }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <form method="post" action="{{ url_for('create_user_route') }}" class="rounded-2xl border border-slate-200/60 dark:border-white/10 bg-white/80 dark:bg-slate-900/60 p-6 shadow-xlsoft space-y-5">
          <div>
            <h2 class="text-lg font-semibold">新增用户</h2>
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">创建新的登录账号并设置角色权限。</p>
          </div>
          <label class="block text-sm">
            <span class="text-slate-500">用户名</span>
            <input name="username" required minlength="3" class="mt-1 w-full rounded-xl border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" placeholder="至少 3 个字符" />
          </label>
          <label class="block text-sm">
            <span class="text-slate-500">密码</span>
            <input name="password" type="password" required class="mt-1 w-full rounded-xl border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" placeholder="请输入初始密码" />
          </label>
          <label class="block text-sm">
            <span class="text-slate-500">角色</span>
            <select name="role" class="mt-1 w-full rounded-xl border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2">
              <option value="staff">普通员工</option>
              <option value="admin">管理员</option>
              <option value="super_admin">超级管理员</option>
            </select>
          </label>
          <div class="flex justify-end">
            <button type="submit" class="px-4 py-2 rounded-xl bg-brand-600 text-white hover:brightness-105">创建账号</button>
          </div>
        </form>

        <section class="rounded-2xl border border-slate-200/60 dark:border-white/10 bg-white/80 dark:bg-slate-900/60 p-6 shadow-xlsoft">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">现有用户</h2>
            <span class="text-xs text-slate-400">共 {{ users|length }} 个</span>
          </div>
          <div class="mt-4 space-y-4">
            {% for user in users %}
              <div class="rounded-xl border border-slate-200/60 dark:border-white/10 bg-white/70 dark:bg-white/5 p-4 space-y-3">
                <form method="post" action="{{ url_for('update_user_route', username=user.username) }}" class="grid gap-3 md:grid-cols-5 items-end">
                  <label class="text-sm md:col-span-2">
                    <span class="text-slate-500">用户名</span>
                    <input name="username" value="{{ user.username }}" required minlength="3" class="mt-1 w-full rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" />
                  </label>
                  <label class="text-sm md:col-span-2">
                    <span class="text-slate-500">新密码 <span class="text-xs text-slate-400">（留空表示不修改）</span></span>
                    <input name="password" type="password" class="mt-1 w-full rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2" />
                  </label>
                  <label class="text-sm">
                    <span class="text-slate-500">角色</span>
                    <select name="role" class="mt-1 w-full rounded-lg border border-slate-200/60 dark:border-white/10 bg-slate-100/70 dark:bg-white/5 px-3 py-2">
                      <option value="staff" {% if user.role == 'staff' %}selected{% endif %}>普通员工</option>
                      <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>管理员</option>
                      <option value="super_admin" {% if user.role == 'super_admin' %}selected{% endif %}>超级管理员</option>
                    </select>
                  </label>
                  <div class="md:col-span-5 flex flex-wrap gap-2 justify-end">
                    <button type="submit" class="px-3 py-2 rounded-lg border border-brand-600/30 text-brand-700 dark:text-brand-300 hover:bg-brand-600/10">保存</button>
                  </div>
                </form>
                <form method="post" action="{{ url_for('delete_user_route', username=user.username) }}" class="flex justify-end">
                  <button type="submit" class="px-3 py-2 rounded-lg border border-red-500/30 text-red-600 hover:bg-red-500/10 disabled:opacity-40 disabled:cursor-not-allowed" {% if current_user.username == user.username %}disabled{% endif %}>删除</button>
                </form>
                <div class="mt-3 flex flex-wrap gap-4 text-xs text-slate-400">
                  <span>创建时间：{{ user.created_at|format_datetime('%Y-%m-%d %H:%M') }}</span>
                  <span>最近更新：{{ user.updated_at|format_datetime('%Y-%m-%d %H:%M') }}</span>
                </div>
              </div>
            {% endfor %}
          </div>
        </section>
      </section>
    </main>

    <script>
      const root = document.documentElement;
      const stored = localStorage.getItem('theme');
      if (stored) {
        root.classList.toggle('dark', stored === 'dark');
      } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        root.classList.add('dark');
      }
    </script>
  </body>
</html>
